<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #090d13; --s1: #111620; --s2: #181e2b; --s3: #1f2637;
  --border: #2a3347; --text: #dce6f5; --muted: #7a8baa;
  --accent: #7c6aef; --accent2: #a08df5; --abg: rgba(124,106,239,.13);
  --green: #3fb950; --orange: #e5a435; --red: #f85149; --blue: #58a6ff;
  --tool-bg: #131925; --r: 10px;
  --code-bg: #0d1219; --user-msg: #1a2460;
  --sidebar-w: 280px; --sidebar-r: 300px;
  --shadow: 0 4px 24px rgba(0,0,0,.4);
  --shadow-sm: 0 1px 4px rgba(0,0,0,.2);
  --shadow-md: 0 4px 16px rgba(0,0,0,.32);
  --shadow-lg: 0 12px 48px rgba(0,0,0,.5);
  --shadow-xl: 0 24px 64px rgba(0,0,0,.65);
  --r-sm: 6px; --r-md: 10px; --r-lg: 14px; --r-xl: 20px;
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; font-size: 15px; line-height: 1.55; }

/* ─── Focus visible (keyboard nav) ─── */
:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 3px; }
button:focus-visible, a:focus-visible { border-radius: 5px; }

/* ─── Subtle background noise texture ─── */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 9998; pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  opacity: 0.022;
}

/* ─── Staggered message entry ─── */
.mw:nth-child(1) { animation-delay: 0ms; }
.mw:nth-child(2) { animation-delay: 30ms; }
.mw:nth-child(3) { animation-delay: 60ms; }
.mw:nth-child(n+4) { animation-delay: 0ms; }

/* ─── Layout ─── */
.left {
  width: var(--sidebar-w); background: var(--s1);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden;
  transition: width .25s cubic-bezier(.4,0,.2,1), opacity .25s;
}
.left.collapsed { width: 0; opacity: 0; pointer-events: none; overflow: hidden; }
.left-inner { flex: 1; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; min-height: 0; }
.left-inner::-webkit-scrollbar { width: 3px; }
.left-inner::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.center { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
.right {
  width: var(--sidebar-r); background: var(--s1);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column; flex-shrink: 0;
  transition: width .25s cubic-bezier(.4,0,.2,1), opacity .25s;
}
.right.collapsed { width: 0; opacity: 0; pointer-events: none; overflow: hidden; }
.hidden { display: none !important; }

/* ─── Panel Toggle Tabs ─── */
.panel-tab {
  width: 14px; display: flex; align-items: center; justify-content: center;
  background: var(--s1); cursor: pointer; flex-shrink: 0;
  position: relative; transition: background .15s; user-select: none; z-index: 10;
}
.panel-tab:hover { background: var(--s2); }
.panel-tab-left { border-right: 1px solid var(--border); }
.panel-tab-right { border-right: 1px solid var(--border); }
.panel-tab-inner {
  width: 14px; height: 56px; display: flex; align-items: center; justify-content: center;
  background: var(--s2); border: 1px solid var(--border); border-radius: 0 5px 5px 0;
  transition: background .15s, border-color .15s;
}
.panel-tab-right .panel-tab-inner { border-radius: 0 5px 5px 0; }
.panel-tab:hover .panel-tab-inner { background: var(--s3); border-color: var(--accent); }
.panel-tab-inner svg {
  width: 10px; height: 10px; color: var(--muted); flex-shrink: 0;
  transition: transform .25s cubic-bezier(.4,0,.2,1), color .15s;
}
.panel-tab:hover .panel-tab-inner svg { color: var(--accent2); }
/* Left tab: default=collapsed → chevron right (→ to open) */
.panel-tab-left .panel-tab-inner svg { transform: rotate(0deg); }
/* Left tab: active=visible → chevron left (← to close) */
.panel-tab-left.active .panel-tab-inner svg { transform: rotate(180deg); }
/* Right tab (left of right panel): collapsed → chevron left (← click to open) */
.panel-tab-right .panel-tab-inner svg { transform: rotate(180deg); }
/* Right tab: active=visible → chevron right (→ click to close) */
.panel-tab-right.active .panel-tab-inner svg { transform: rotate(0deg); }
/* Tooltips handled by JS (#globalTip) */

/* ─── Sections ─── */
.sec { border-bottom: 1px solid var(--border); }
.sec-title { padding: 9px 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px; color: var(--muted); display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; transition: color .15s; }
.sec-title:hover { color: var(--text); }
.sec-title .badge { background: var(--accent); color: white; font-size: 10px; padding: 1px 7px; border-radius: 10px; font-weight: 700; min-width: 20px; text-align: center; }
.sec-title .badge:empty { display: none; }
.sec-body { padding: 4px 8px 10px; }
.sec-body.collapsed { display: none; }

/* ─── Active project label + version badge in header ─── */
#activeProjLabel { font-size: 12px; color: var(--accent2); background: rgba(124,106,239,.1); border: 1px solid rgba(124,106,239,.25); border-radius: 4px; padding: 2px 8px; display: none; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#versionBadge { font-size: 11px; color: var(--muted); cursor: default; letter-spacing: .3px; }
#versionBadge.update { color: var(--orange); cursor: pointer; text-decoration: underline dotted; }

/* ─── File browser action buttons ─── */
.fii .fdl, .fii .fpe { opacity: 0; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px; padding: 1px 4px; border-radius: 3px; transition: opacity .1s, color .1s; flex-shrink: 0; line-height: 1; }
.fii:hover .fdl, .fii:hover .fpe { opacity: .7; }
.fii .fdl:hover { color: var(--accent2); opacity: 1 !important; }
.fii .fpe:hover { color: var(--green); opacity: 1 !important; }

/* ─── Skill categories ─── */
.sk-cat { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px; color: var(--muted); padding: 10px 10px 4px; opacity: .7; }
.sk-cat:first-child { padding-top: 2px; }

/* ─── Toggle items ─── */
.ci { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: var(--r); cursor: pointer; font-size: 13px; transition: background .12s; border: 1px solid transparent; }
.ci:hover { background: var(--s2); }
.ci.on { background: rgba(124,106,239,.08); border-color: rgba(124,106,239,.2); }
/* Toggle switch */
.sw { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
.sw input { opacity: 0; width: 0; height: 0; position: absolute; }
.sw-track { position: absolute; inset: 0; background: var(--s3); border-radius: 20px; border: 1px solid var(--border); transition: background .2s, border-color .2s; }
.ci.on .sw-track { background: var(--accent); border-color: var(--accent); }
.sw-thumb { position: absolute; top: 3px; left: 3px; width: 12px; height: 12px; background: white; border-radius: 50%; transition: transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,.3); }
.ci.on .sw-thumb { transform: translateX(16px); }
/* Info */
.ci .inf { flex: 1; min-width: 0; }
.ci .inf .nm { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }
.ci .inf .ds { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.ci .inf .st { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .4px; margin-top: 2px; color: var(--muted); }
.ci.on .inf .st { color: var(--accent2); }
/* Remove button */
.ci .rm { opacity: 0; background: none; border: none; color: var(--red); cursor: pointer; font-size: 14px; padding: 3px 6px; border-radius: 4px; transition: opacity .12s; flex-shrink: 0; }
.ci:hover .rm { opacity: .45; }
.ci .rm:hover { opacity: 1 !important; background: rgba(248,81,73,.1); }
.ci .cfg { opacity: 0; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 13px; padding: 3px 6px; border-radius: 4px; transition: opacity .12s, color .12s; flex-shrink: 0; }
.ci:hover .cfg { opacity: .6; }
.ci .cfg:hover { opacity: 1 !important; color: var(--accent2); background: rgba(124,106,239,.1); }
.ci .warn-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--orange); flex-shrink: 0; margin-right: -4px; }
.af select { background: var(--s2); border: 1px solid var(--border); color: var(--text); padding: 6px 9px; border-radius: 6px; font-size: 12px; font-family: inherit; outline: none; cursor: pointer; transition: border .12s; }
.af select:focus { border-color: var(--accent); }
#mcpStdioFields, #mcpUrlFields { display: flex; flex-direction: column; gap: 6px; }

/* ─── Add buttons & forms ─── */
.add-btn { display: flex; align-items: center; gap: 6px; padding: 6px 9px; margin-top: 4px; border-radius: var(--r); cursor: pointer; font-size: 12px; color: var(--accent2); border: 1px dashed var(--border); background: none; width: 100%; transition: all .12s; }
.auto-skills-btn { font-size: 11px; font-weight: 700; color: var(--muted); background: none; border: 1px solid var(--border); border-radius: 4px; padding: 1px 6px; cursor: pointer; transition: all .15s; line-height: 1.6; letter-spacing: .3px; }
.auto-skills-btn:hover { color: var(--accent2); border-color: var(--accent); }
.auto-skills-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
.auto-notif { font-size: 10px; color: var(--accent2); padding: 2px 10px 6px; }
.add-btn:hover { background: var(--abg); border-color: var(--accent); }
.af { margin-top: 7px; display: flex; flex-direction: column; gap: 6px; }
.af input, .af textarea { background: var(--s2); border: 1px solid var(--border); color: var(--text); padding: 6px 9px; border-radius: 6px; font-size: 12px; font-family: inherit; outline: none; transition: border .12s; }
.af input:focus, .af textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,106,239,.15); }
.af textarea { resize: vertical; min-height: 44px; font-family: 'SF Mono', monospace; font-size: 11px; }
.fr { display: flex; gap: 6px; }
.fr button { padding: 5px 13px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 500; }
.bp { background: var(--accent); color: white; }
.bp:hover { background: var(--accent2); }
.bg { background: var(--s2); color: var(--muted); border: 1px solid var(--border) !important; }

/* ─── History ─── */
.hist-list { flex: 1; overflow-y: auto; padding: 4px 8px; max-height: 200px; }
.hist-item { padding: 7px 10px; border-radius: var(--r); cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; gap: 7px; transition: background .1s; }
.hist-item:hover { background: var(--s2); }
.hist-item.active { background: var(--abg); border-left: 2px solid var(--accent); padding-left: 8px; }
.hist-item .ht { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.hist-item .hd { font-size: 11px; color: var(--muted); flex-shrink: 0; }
.hist-item .del { opacity: 0; background: none; border: none; color: var(--red); cursor: pointer; font-size: 12px; padding: 2px 5px; border-radius: 3px; }
.hist-item:hover .del { opacity: .5; }
.hist-item .del:hover { opacity: 1; }
.hist-spin { width: 8px; height: 8px; flex-shrink: 0; margin-right: 4px; }

/* ─── Header ─── */
.hdr { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: var(--s1); border-bottom: 1px solid var(--border); }
.hdr-l { display: flex; align-items: center; gap: 10px; }
.logo { width: 32px; height: 32px; border-radius: 9px; background: linear-gradient(135deg, var(--accent), #a855f7); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; color: white; flex-shrink: 0; box-shadow: 0 2px 8px rgba(124,106,239,.4); }
.hdr h1 { font-size: 16px; font-weight: 700; letter-spacing: -.2px; }
.status-dot { display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }
.status-dot::before { content: '●'; font-size: 8px; }
.status-dot.ok { color: var(--green); }
.status-dot.ok::before { color: var(--green); }
.status-dot.err { color: var(--red); }
.status-dot.err::before { color: var(--red); }
.status-dot.warn { color: var(--orange); }
.status-dot.warn::before { color: var(--orange); }
.hdr-btns { display: flex; gap: 5px; }
.hb { background: var(--s2); border: 1px solid var(--border); color: var(--muted); padding: 5px 11px; border-radius: 7px; cursor: pointer; font-size: 13px; transition: all .15s; font-weight: 500; }
.hb:hover { color: var(--text); border-color: var(--accent2); background: var(--s3); }
.hb.active { color: var(--accent2); border-color: var(--accent); background: var(--abg); }
/* ─── Nav switcher (Chat ↔ Kanban) ─── */
.nav-sw { display: flex; align-items: center; background: var(--s3); border: 1px solid var(--border); border-radius: 8px; padding: 3px; gap: 2px; }
.nav-sw-btn { display: inline-flex; align-items: center; gap: 5px; padding: 4px 11px; border-radius: 6px; font-size: 13px; font-weight: 600; color: var(--muted); text-decoration: none; transition: all .15s; white-space: nowrap; }
.nav-sw-btn:hover { color: var(--text); background: rgba(255,255,255,.05); }
.nav-sw-btn.active { background: var(--s2); color: var(--accent2); box-shadow: 0 1px 3px rgba(0,0,0,.3); }

/* ─── Toolbar ─── */
.toolbar { display: flex; align-items: center; gap: 7px; padding: 6px 14px; background: var(--s1); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.tb-group { display: flex; align-items: center; gap: 2px; background: var(--s2); border: 1px solid var(--border); border-radius: 8px; padding: 3px; }
.tb-group .label { font-size: 11px; color: var(--muted); padding: 0 7px; text-transform: uppercase; letter-spacing: .6px; font-weight: 700; }
.tb-btn { padding: 4px 11px; border-radius: 6px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-size: 13px; transition: all .12s; white-space: nowrap; font-weight: 500; }
.tb-btn:hover { color: var(--text); background: rgba(255,255,255,.06); }
.tb-btn.on { background: var(--accent); color: white; box-shadow: 0 1px 6px rgba(124,106,239,.4); }
.tb-sep { width: 1px; height: 20px; background: var(--border); margin: 0 2px; }
.tb-input { background: var(--s2); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; border-radius: 6px; font-size: 13px; width: 55px; outline: none; text-align: center; }
.tb-input:focus { border-color: var(--accent); }
.mode-ind { font-size: 12px; color: var(--muted); padding: 2px 8px; display: flex; align-items: center; gap: 5px; }
.dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
.dot-plan { background: var(--blue); }
.dot-task { background: var(--green); }
.dot-auto { background: var(--orange); }

/* ─── Messages ─── */
.msgs { flex: 1; overflow-y: auto; padding: 20px 18px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
.msgs::-webkit-scrollbar { width: 4px; }
.msgs::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.mw { max-width: 86%; animation: fadeUp .15s ease; position: relative; }
.mw:hover .cpb { opacity: .6; }
.mw:hover .cpmd { opacity: .6; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(6px); } }
.mw.user { align-self: flex-end; }
.mw.assistant { align-self: flex-start; }

/* ─── Message bubbles ─── */
.msg { line-height: 1.75; font-size: 15.5px; word-break: break-word; }
.mw.user .msg { background: var(--user-msg); padding: 10px 15px; border-radius: 14px 14px 4px 14px; white-space: pre-wrap; border: 1px solid rgba(124,106,239,.3); }
.mw.assistant .msg { background: var(--s2); padding: 13px 16px; border-radius: 14px 14px 14px 4px; border: 1px solid var(--border); }

/* ─── Assistant message avatar marker ─── */
.mw.assistant { padding-left: 34px; }
.mw.assistant::before {
  content: 'AI';
  position: absolute; left: 0; top: 2px;
  width: 26px; height: 26px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #a855f7);
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; font-weight: 800; color: white; letter-spacing: .3px;
  box-shadow: 0 2px 8px rgba(124,106,239,.35);
  flex-shrink: 0;
}

/* User message right-align avatar */
.mw.user { padding-right: 34px; }
.mw.user::after {
  content: 'You';
  position: absolute; right: 0; top: 2px;
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--user-msg);
  border: 1px solid rgba(124,106,239,.4);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; color: var(--accent2); letter-spacing: .3px;
}

/* ─── Markdown styles inside .msg ─── */
.msg strong { font-weight: 700; color: var(--text); }
.msg em { font-style: italic; color: #c9d1d9; }
.msg h1, .msg h2, .msg h3 { font-weight: 700; margin: 12px 0 6px; color: var(--text); }
.msg h1 { font-size: 21px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
.msg h2 { font-size: 18px; }
.msg h3 { font-size: 16px; }
.msg p { margin: 6px 0; }
.msg ul, .msg ol { margin: 6px 0 6px 20px; }
.msg li { margin: 3px 0; }
.msg code { background: rgba(110,118,129,.18); padding: 2px 6px; border-radius: 5px; font-family: 'SF Mono', Consolas, 'Courier New', monospace; font-size: 13.5px; color: #e6a77b; }
.msg pre { background: var(--code-bg); border: 1px solid var(--border); border-radius: 9px; margin: 10px 0; overflow: hidden; }
.msg pre .pre-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; background: var(--s3); border-bottom: 1px solid var(--border); font-size: 12px; color: var(--muted); }
.msg pre .pre-header .lang { font-family: 'SF Mono', monospace; color: var(--accent2); font-weight: 700; font-size: 12px; }
.msg pre code { background: none; padding: 12px 14px; border-radius: 0; font-size: 13.5px; color: var(--text); display: block; overflow-x: auto; line-height: 1.65; }
.msg a { color: var(--accent2); text-decoration: none; }
.msg a:hover { text-decoration: underline; }
.msg blockquote { display: flex; align-items: flex-start; gap: 8px; border-left: 3px solid #3a4560; padding: 7px 12px; margin: 6px 0 10px; background: rgba(20,27,42,.75); border-radius: 0 8px 8px 0; color: #8a9bba; font-size: 14.5px; font-style: italic; line-height: 1.5; }
.msg blockquote > svg { flex-shrink: 0; margin-top: 3px; opacity: .4; color: #8a9bba; }
.msg hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
.msg .table-wrap { overflow-x: auto; margin: 12px 0; border-radius: 9px; border: 1px solid var(--border); }
.msg table { border-collapse: collapse; width: 100%; font-size: 14px; }
.msg th, .msg td { border: none; border-bottom: 1px solid var(--border); padding: 8px 14px; text-align: left; line-height: 1.5; }
.msg th { background: var(--s3); font-weight: 700; color: var(--accent2); border-bottom: 2px solid var(--border); white-space: nowrap; }
.msg tbody tr:nth-child(even) { background: rgba(255,255,255,.03); }
.msg tbody tr:hover { background: rgba(124,106,239,.08); }
.msg td { color: var(--text); }
.msg td:first-child, .msg th:first-child { padding-left: 16px; }
.msg td:last-child, .msg th:last-child { padding-right: 16px; }

/* ─── Copy button ─── */
.cpb { position: absolute; top: 5px; right: 5px; opacity: 0; background: var(--s3); border: 1px solid var(--border); color: var(--muted); padding: 3px 8px; border-radius: 5px; cursor: pointer; font-size: 11px; transition: opacity .15s; }
.cpb:hover { color: var(--text); opacity: 1 !important; }
.cpb.ok { color: var(--green); }
.cpmd { position: absolute; top: 5px; right: 38px; opacity: 0; background: var(--s3); border: 1px solid var(--border); color: var(--muted); padding: 3px 8px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600; transition: opacity .15s; }
.cpmd:hover { color: var(--text); opacity: 1 !important; border-color: var(--accent2); }
.cpmd.ok { color: var(--green); }
.copy-code-btn { background: var(--s2); border: 1px solid var(--border); color: var(--muted); padding: 2px 9px; border-radius: 5px; cursor: pointer; font-size: 11px; font-family: inherit; transition: all .12s; }
.copy-code-btn:hover { color: var(--text); border-color: var(--accent2); }
.copy-code-btn.ok { color: var(--green); }

/* ─── Agent badge (multi-agent) ─── */
.ab { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; flex-shrink: 0; }

/* ─── Agent status line (in-scroll legacy) ─── */
.agent-status { align-self: flex-start; display: flex; align-items: center; gap: 9px; padding: 5px 0 5px 2px; font-size: 12px; color: var(--muted); }
.agent-status .asdot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); flex-shrink: 0; animation: pulse-dot 1.4s ease-in-out infinite; }
.agent-status .astxt { opacity: .75; }
@keyframes pulse-dot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: .25; transform: scale(.65); } }

/* ─── Sticky status bar ─── */
#statusBar {
  display: flex; align-items: center; gap: 10px;
  padding: 0 20px;
  background: var(--s1);
  border-top: 1px solid transparent;
  font-size: 12px; color: var(--muted);
  max-height: 0; overflow: hidden; opacity: 0;
  transition: max-height .22s ease, opacity .18s ease, padding .22s ease, border-color .22s ease;
  flex-shrink: 0;
}
#statusBar.sb-active {
  max-height: 36px; opacity: 1;
  padding: 7px 20px;
  border-top-color: var(--border);
}
#statusBar .sb-spin {
  width: 11px; height: 11px;
  border: 1.5px solid rgba(124,106,239,.2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .65s linear infinite;
  flex-shrink: 0;
}
#statusBar .sb-txt {
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  opacity: .82; max-width: 520px;
}

/* ─── Message spinner / done badge ─── */
.msg-spinner { position: absolute; top: 9px; right: 36px; width: 13px; height: 13px; border: 2px solid rgba(124,106,239,.2); border-top-color: var(--accent); border-radius: 50%; animation: spin .65s linear infinite; z-index: 1; }
.msg-done { position: absolute; top: 7px; right: 34px; color: var(--green); font-size: 14px; line-height: 1; z-index: 1; }
@keyframes spin { to { transform: rotate(360deg); } }
/* ─── Streaming cursor ─── */
.stream-cursor { display: inline-block; width: 2px; height: .85em; background: var(--accent); margin-left: 2px; vertical-align: middle; border-radius: 1px; animation: blink .8s step-end infinite; }
@keyframes blink { 0%,100%{ opacity:1 } 50%{ opacity:0 } }

/* ─── User message acknowledgement (green ✓ after response received) ─── */
.msg-ack { font-size: 11px; color: var(--green); text-align: right; padding: 2px 8px 0; line-height: 1; opacity: 0.75; animation: fadeUp .25s ease; }

/* ─── Load history button ─── */
.load-hist-btn {
  align-self: center; background: var(--s2); border: 1px solid var(--border);
  color: var(--muted); font-size: 12px; padding: 6px 18px; border-radius: 20px;
  cursor: pointer; transition: background .15s, color .15s, border-color .15s;
  margin-bottom: 4px; flex-shrink: 0;
}
.load-hist-btn:hover { background: var(--s3); color: var(--text); border-color: var(--accent); }
.load-hist-btn:disabled { opacity: .45; cursor: not-allowed; }

/* ─── Load more messages button ─── */
.load-more-wrap { display: flex; justify-content: center; padding: 8px 0 4px; flex-shrink: 0; }
.load-more-btn { background: var(--s2); border: 1px solid var(--border); color: var(--muted); font-size: 11px; padding: 5px 16px; border-radius: 20px; cursor: pointer; transition: background .15s, color .15s, border-color .15s; }
.load-more-btn:hover { background: var(--s3); color: var(--text); border-color: var(--accent); }

/* ─── Scroll-to-bottom button ─── */
#scrollBtn {
  position: absolute; bottom: 90px; right: 20px;
  width: 36px; height: 36px;
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 50%; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  box-shadow: var(--shadow); color: var(--muted);
  opacity: 0; pointer-events: none; z-index: 20;
  transition: opacity .2s, background .15s, color .15s;
  font-size: 16px; line-height: 1;
}
#scrollBtn.visible { opacity: 1; pointer-events: all; }
#scrollBtn:hover { background: var(--accent); border-color: var(--accent); color: white; }

/* ─── Attachment chips (files & screenshots) ─── */
.att-chips { display: flex; flex-wrap: wrap; gap: 6px; padding: 6px 14px 2px; min-height: 0; }
.att-chips:empty { display: none; }
.att-chip { display: inline-flex; align-items: center; gap: 5px; background: var(--s3); border: 1px solid var(--border); border-radius: 6px; padding: 3px 8px 3px 6px; font-size: 11px; color: var(--text); max-width: 260px; position: relative; transition: border-color .12s; }
.att-chip:hover { border-color: var(--accent); }
.att-chip .chip-icon { font-size: 13px; flex-shrink: 0; }
.att-chip .chip-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
.att-chip .chip-rm { background: none; border: none; color: var(--muted); cursor: pointer; padding: 0 0 0 2px; font-size: 13px; line-height: 1; flex-shrink: 0; transition: color .1s; }
.att-chip .chip-rm:hover { color: var(--red); }
.att-chip.chip-img { padding: 3px 8px 3px 3px; gap: 6px; }
.att-chip.chip-img img { width: 28px; height: 28px; object-fit: cover; border-radius: 3px; display: block; }

/* ─── @ File picker popup ─── */
.at-popup {
  position: absolute; bottom: 100%; left: 0; right: 0; margin-bottom: 4px;
  background: var(--s2); border: 1px solid var(--border); border-radius: 10px;
  box-shadow: var(--shadow); overflow: hidden; z-index: 200;
  max-height: 260px; display: flex; flex-direction: column;
}
.at-popup-hdr { padding: 7px 12px; font-size: 11px; color: var(--muted); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.at-popup-hdr input { flex: 1; background: none; border: none; outline: none; color: var(--text); font-size: 12px; }
.at-popup-list { overflow-y: auto; flex: 1; }
.at-item { display: flex; align-items: center; gap: 8px; padding: 7px 12px; cursor: pointer; font-size: 12px; transition: background .1s; }
.at-item:hover, .at-item.active { background: var(--s3); }
.at-item .at-info { display: flex; flex-direction: column; overflow: hidden; flex: 1; min-width: 0; }
.at-item .at-name { font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.at-item .at-dir { color: var(--muted); font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
.at-item .at-icon { font-size: 14px; flex-shrink: 0; }
.at-empty { padding: 12px; text-align: center; color: var(--muted); font-size: 11px; }
.at-loading { padding: 12px; text-align: center; color: var(--muted); font-size: 11px; }

/* ─── Welcome ─── */
.welcome { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); text-align: center; gap: 10px; }
.wi { width: 54px; height: 54px; border-radius: 16px; background: linear-gradient(135deg, var(--accent), #a855f7); display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 4px; box-shadow: 0 4px 20px rgba(124,106,239,.35); }
.welcome h2 { color: var(--text); font-size: 18px; font-weight: 700; }
.welcome p { font-size: 13.5px; max-width: 300px; line-height: 1.65; }
.welcome-prompts { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 420px; margin-top: 20px; }
.wp-card { background: var(--s2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; font-size: 13px; color: var(--muted); cursor: pointer; transition: all .15s; text-align: left; line-height: 1.4; }
.wp-card:hover { background: var(--s3); border-color: rgba(124,106,239,.4); color: var(--text); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.2); }

/* ─── Tabs bar ─── */
.tabs-bar { display: flex; align-items: stretch; background: var(--bg); border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0; min-height: 34px; }
.tabs-bar::-webkit-scrollbar { height: 2px; }
.tabs-bar::-webkit-scrollbar-thumb { background: var(--border); }
.tab { display: flex; align-items: center; gap: 6px; padding: 0 10px 0 12px; min-width: 90px; max-width: 180px; border-right: 1px solid var(--border); cursor: pointer; font-size: 12.5px; color: var(--muted); transition: background .1s, color .1s; flex-shrink: 0; position: relative; }
.tab:hover { background: var(--s2); color: var(--text); }
.tab.active { background: var(--s2); color: var(--text); }
.tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--accent); }
.tab-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
.tab-close { opacity: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 3px; font-size: 11px; flex-shrink: 0; transition: opacity .12s; background: none; border: none; color: inherit; cursor: pointer; }
.tab:hover .tab-close, .tab.active .tab-close { opacity: .45; }
.tab-close:hover { opacity: 1 !important; background: var(--s3); }
.tab-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.tab-dot.spinning { border: 1.5px solid rgba(124,106,239,.25); border-top-color: var(--accent); animation: spin .65s linear infinite; }
.tab-dot.done { background: var(--green); }
.proj-busy-dot { display: inline-block; margin-left: 5px; vertical-align: middle; position: relative; top: -1px; }
.tab-new { padding: 0 13px; display: flex; align-items: center; color: var(--muted); cursor: pointer; font-size: 20px; line-height: 1; transition: color .1s; flex-shrink: 0; background: none; border: none; }
.tab-new:hover { color: var(--text); }
.tab-rename-input { background: transparent; border: none; border-bottom: 1.5px solid var(--accent); color: var(--text); font-size: 12.5px; font-family: inherit; padding: 0 2px; outline: none; width: 100%; min-width: 40px; }

/* ─── Session info bar ─── */
.sess-bar { display:flex; align-items:center; gap:6px; padding:3px 14px; font-size:11px; color:var(--text-dim); border-bottom:1px solid var(--border); user-select:none; min-height:24px; flex-shrink:0; }
.sess-bar .sess-id { font-family:monospace; cursor:pointer; padding:1px 5px; border-radius:4px; background:var(--s1); transition:background .1s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; }
.sess-bar .sess-id:hover { background:var(--s2); }
.sess-open-btn { padding:1px 8px; border-radius:4px; border:1px solid var(--border); background:transparent; color:var(--text-dim); cursor:pointer; font-size:11px; white-space:nowrap; transition:background .1s, color .1s; }
.sess-open-btn:hover { background:var(--s2); color:var(--text); }

/* ─── Task interrupted / retry banner ─── */
.msg-retry { display:flex; align-items:center; gap:10px; margin:8px 12px; padding:10px 14px; border-radius:8px; background:var(--s2); border:1px solid var(--warn,#f59e0b); font-size:13px; color:var(--text-dim); }
.msg-retry button { padding:4px 14px; border-radius:6px; background:var(--accent); color:#fff; border:none; cursor:pointer; font-size:12px; }
.msg-retry button:hover { opacity:.85; }

/* ─── Input area ─── */
.ia { padding: 12px 16px; background: var(--s1); border-top: 1px solid var(--border); }
.iw { display: flex; align-items: flex-end; gap: 8px; background: var(--s2); border: 1px solid var(--border); border-radius: 12px; padding: 5px 5px 5px 14px; transition: border-color .15s, box-shadow .15s; }
.iw:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,106,239,.15); }
.iw textarea { flex: 1; background: none; border: none; color: var(--text); font-size: 14.5px; font-family: inherit; resize: none; outline: none; max-height: 130px; padding: 7px 0; line-height: 1.55; }
.iw textarea::placeholder { color: var(--muted); }
.sb { width: 36px; height: 36px; border: none; background: var(--accent); color: white; border-radius: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background .12s, box-shadow .12s; box-shadow: 0 2px 8px rgba(124,106,239,.4); }
.sb:hover { background: var(--accent2); box-shadow: 0 3px 12px rgba(124,106,239,.5); }
.sb:disabled { opacity: .35; cursor: not-allowed; box-shadow: none; }
.stop-btn { background: var(--red); box-shadow: 0 2px 8px rgba(248,81,73,.4); }
.stop-btn:hover { background: #ff6b6b !important; box-shadow: 0 3px 12px rgba(248,81,73,.5) !important; }
.sb svg { width: 15px; height: 15px; }
.msg-queued { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--muted); margin-top: 5px; padding: 3px 6px 3px 8px; background: var(--s2); border: 1px solid var(--border); border-radius: 10px; }
.msg-queued::before { content: '⏳'; font-size: 11px; }
.mq-label { line-height: 1; }
.qd-btn { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 11px; padding: 1px 3px; line-height: 1; border-radius: 3px; transition: color .12s, background .12s; display: inline-flex; align-items: center; }
.qd-btn:hover { background: var(--s3); }
.qd-edit:hover { color: var(--accent2); }
.qd-del:hover { color: var(--red); }
.queue-editor { display: flex; flex-direction: column; gap: 5px; margin: 4px 0 2px; }
.queue-edit-area { width: 100%; box-sizing: border-box; background: var(--s2); border: 1px solid var(--accent); border-radius: 8px; color: var(--text); font-size: 14px; font-family: inherit; padding: 7px 10px; resize: none; outline: none; min-height: 58px; line-height: 1.55; }
.queue-edit-area:focus { box-shadow: 0 0 0 2px rgba(124,106,239,.18); }
.queue-edit-btns { display: flex; gap: 6px; justify-content: flex-end; }
.qe-save { background: var(--accent); color: #fff; border: none; border-radius: 6px; padding: 4px 13px; font-size: 12px; font-family: inherit; cursor: pointer; transition: background .12s; }
.qe-save:hover { background: var(--accent2); }
.qe-cancel { background: var(--s3); color: var(--muted); border: 1px solid var(--border); border-radius: 6px; padding: 4px 13px; font-size: 12px; font-family: inherit; cursor: pointer; transition: color .12s; }
.qe-cancel:hover { color: var(--text); }
.queue-badge { display:none; align-items:center; gap:4px; background:var(--orange); color:#000; font-size:11px; font-weight:700; padding:2px 9px 2px 7px; border-radius:12px; white-space:nowrap; flex-shrink:0; line-height:1.5; }
.queue-badge.visible { display:inline-flex; animation:qbpulse 2s ease-in-out infinite; }
.queue-badge::before { content:'⏳'; font-size:10px; }
@keyframes qbpulse { 0%,100%{opacity:1} 50%{opacity:.72} }

/* ─── File browser ─── */
.fh { padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; }
.fh button { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 15px; transition: color .12s; }
.fh button:hover { color: var(--text); }
.ft { flex: 1; overflow-y: auto; padding: 5px 7px; }
.fii { display: flex; align-items: center; gap: 7px; padding: 5px 7px; border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--muted); transition: all .1s; }
.fii:hover { background: var(--s2); color: var(--text); }
.fii .fi { width: 17px; text-align: center; font-size: 14px; flex-shrink: 0; }
.fii .fn { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.fii .fs { font-size: 10.5px; color: var(--muted); }
/* ─── File Preview Modal ─── */
.fpv-modal { width: calc(100vw - 40px) !important; max-width: calc(100vw - 40px) !important; height: calc(100vh - 40px); max-height: calc(100vh - 40px) !important; border-radius: 12px; }
.fpv-toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-bottom: 1px solid var(--border); background: var(--s2); flex-shrink: 0; }
.fpv-toolbar .fpv-ext { font-size: 10px; color: var(--muted); background: var(--s3); border: 1px solid var(--border); border-radius: 3px; padding: 1px 6px; margin-right: auto; }
.fpv-body { flex: 1; overflow: auto; display: flex; flex-direction: column; min-height: 0; }
.fpv-body img { max-width: 100%; max-height: calc(100vh - 155px); object-fit: contain; margin: auto; display: block; padding: 16px; }
.fpv-body iframe { width: 100%; flex: 1; border: none; min-height: calc(100vh - 155px); flex: 1; }
.fpv-body .fpv-text { padding: 16px; font-family: 'SF Mono', monospace; font-size: 13.5px; line-height: 1.7; color: var(--text); white-space: pre-wrap; word-break: break-word; }
.fpv-body .fpv-md { padding: 16px 20px; line-height: 1.7; }
.fpv-body .fpv-binary { padding: 32px; display: flex; flex-direction: column; align-items: center; gap: 12px; color: var(--muted); font-size: 14px; }
.fpv-btn { background: var(--s2); border: 1px solid var(--border); color: var(--muted); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; transition: all .15s; flex-shrink: 0; }
.fpv-btn:hover { color: var(--text); border-color: var(--accent2); }

/* ─── Modal ─── */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: flex; align-items: center; justify-content: center; z-index: 100; animation: fadeUp .15s; backdrop-filter: blur(14px) saturate(150%); }
.modal { background: var(--s1); border: 1px solid var(--border); border-radius: var(--r-lg); width: 740px; max-width: 92vw; max-height: 86vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-xl); }
.modal-hdr { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid var(--border); }
.modal-hdr h2 { font-size: 15px; font-weight: 700; }
.modal-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 20px; padding: 4px; transition: color .12s; line-height: 1; }
.modal-close:hover { color: var(--text); }
.modal-tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 14px; }
.modal-tab { padding: 9px 16px; font-size: 13px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; transition: all .15s; font-weight: 500; }
.modal-tab:hover { color: var(--text); }
.modal-tab.active { color: var(--accent2); border-bottom-color: var(--accent); }
.modal-body { flex: 1; overflow: auto; padding: 16px; }
.modal-body textarea { width: 100%; min-height: 340px; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 14px; border-radius: 9px; font-family: 'SF Mono', Consolas, monospace; font-size: 13px; line-height: 1.6; resize: vertical; outline: none; transition: border .15s; }
.modal-body textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,106,239,.12); }
.modal-footer { padding: 12px 18px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.modal-footer button { padding: 7px 18px; border-radius: 7px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
.save-notice { color: var(--green); font-size: 12px; }
.cfg-path { font-size: 11px; color: var(--muted); padding: 0 2px 10px; font-family: 'SF Mono', Consolas, monospace; letter-spacing: .2px; display: flex; align-items: center; gap: 6px; }

/* ─── Toast notifications ─── */
#toast { position: fixed; bottom: 22px; left: 50%; transform: translateX(-50%); background: var(--s3); border: 1px solid var(--border); color: var(--text); padding: 9px 18px; border-radius: 10px; font-size: 13px; z-index: 200; pointer-events: none; opacity: 0; transition: opacity .25s; box-shadow: var(--shadow); white-space: nowrap; }
#toast.show { opacity: 1; }
#toast.toast-err { border-color: var(--red); color: var(--red); }

/* ─── Tooltips (floating JS div) ─── */
#globalTip {
  position: fixed; z-index: 9999; pointer-events: none;
  padding: 6px 11px; background: #1a2235; border: 1px solid rgba(255,255,255,.13);
  border-radius: 8px; font-size: 12px; line-height: 1.5; max-width: 280px;
  white-space: normal; color: var(--text);
  box-shadow: 0 4px 20px rgba(0,0,0,.55), 0 1px 4px rgba(0,0,0,.3);
  opacity: 0; transition: opacity .12s ease; word-break: break-word;
}

/* ─── Scrollbars ─── */
* { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #4a5568; }
::-webkit-scrollbar-track { background: transparent; }

/* ─── Tactile button feedback ─── */
.hb:active { transform: scale(0.95); transition-duration: 0.07s; }
.tb-btn:active { transform: scale(0.93); transition-duration: 0.07s; }
.add-btn:active { transform: scale(0.97); transition-duration: 0.07s; }
.ci:active { transform: scale(0.98); transition-duration: 0.07s; }

/* ─── Sidebar item left-border accent on hover ─── */
.ci { transition: background .12s, box-shadow .12s, transform .12s; }
.ci:hover { background: var(--s2); box-shadow: inset 2px 0 0 rgba(124,106,239,.3); }
.ci.on { box-shadow: inset 2px 0 0 var(--accent); }
.ci.on:hover { background: rgba(124,106,239,.13); }

/* ─── History hover accent ─── */
.hist-item { transition: background .12s, box-shadow .12s; }
.hist-item:hover { background: var(--s2); box-shadow: inset 2px 0 0 rgba(124,106,239,.3); }

/* ─── Language selector ─── */
.lang-sel { background: var(--s2); border: 1px solid var(--border); color: var(--text); padding: 3px 8px; border-radius: 6px; font-size: 12px; outline: none; cursor: pointer; font-weight: 500; }
.lang-sel:hover, .lang-sel:focus { border-color: var(--accent2); }
.lang-sel option { background: var(--s2); }

/* ─── Directory browser ─── */
.dir-modal { width: 520px; }
.dir-path-bar { padding: 8px 16px; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; gap: 6px; }
.dir-path-bar .path-text { font-size: 12px; color: var(--accent2); font-family: 'SF Mono', monospace; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; word-break: break-all; }
.dir-list { flex: 1; overflow-y: auto; max-height: 340px; padding: 4px 6px; }
.dir-list::-webkit-scrollbar { width: 3px; }
.dir-list::-webkit-scrollbar-thumb { background: var(--border); }
.dii { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 7px; cursor: pointer; font-size: 13px; transition: background .1s; color: var(--text); }
.dii:hover { background: var(--s2); }
.dii.selected { background: var(--abg); border: 1px solid rgba(124,106,239,.3); }
.dii .di { font-size: 15px; flex-shrink: 0; }
.dii .dn { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.dii.hidden-dir { opacity: .5; }
.dir-footer { padding: 10px 16px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
.dir-footer label { display: flex; align-items: center; gap: 7px; font-size: 12px; cursor: pointer; color: var(--muted); }
.dir-footer input[type=checkbox] { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; }

/* ─── Project name input in dir modal ─── */
.proj-name-row { padding: 8px 16px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
.proj-name-row input { flex: 1; background: var(--s2); border: 1px solid var(--border); color: var(--text); padding: 5px 9px; border-radius: 6px; font-size: 12px; font-family: inherit; outline: none; }

/* ─── Confirm Stop Dialog ─── */
.confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.65); display: flex; align-items: center; justify-content: center; z-index: 300; backdrop-filter: blur(4px); animation: fadeUp .12s ease; }
.confirm-dialog { background: var(--s1); border: 1px solid var(--border); border-radius: 14px; padding: 28px 32px 24px; width: 320px; max-width: 90vw; box-shadow: 0 20px 60px rgba(0,0,0,.65); text-align: center; }
.confirm-dialog .cd-icon { font-size: 28px; margin-bottom: 12px; line-height: 1; }
.confirm-dialog h3 { font-size: 16px; font-weight: 700; margin-bottom: 6px; color: var(--text); }
.confirm-dialog p { font-size: 13px; color: var(--muted); margin-bottom: 22px; line-height: 1.45; }
.confirm-actions { display: flex; gap: 10px; justify-content: center; }
.confirm-actions button { padding: 8px 22px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: background .12s, transform .08s, box-shadow .12s; }
.confirm-actions button:active { transform: scale(.96); }
.cd-btn-stop { background: var(--red); color: #fff; box-shadow: 0 2px 8px rgba(248,81,73,.35); }
.cd-btn-stop:hover { background: #ff6b6b; box-shadow: 0 3px 12px rgba(248,81,73,.5); }
.cd-btn-cancel { background: var(--s3); color: var(--text); border: 1px solid var(--border) !important; }
.cd-btn-cancel:hover { background: var(--border); }
.proj-name-row input:focus { border-color: var(--accent); }

/* ─── HUD Panel ─── */
#hud {
  display: flex; align-items: center; gap: 8px;
  background: var(--s1); border-top: 1px solid var(--border);
  height: 32px; flex-shrink: 0; padding: 0 10px;
  overflow: hidden; transition: height .2s cubic-bezier(.4,0,.2,1);
  font-size: 11px; color: var(--muted); user-select: none;
}
#hud.collapsed { height: 12px; cursor: pointer; }
#hud.collapsed > *:not(.hud-toggle) { opacity: 0; pointer-events: none; }
.hud-toggle { font-size: 8px; opacity: .5; cursor: pointer; flex-shrink: 0; transition: transform .2s, opacity .15s; line-height: 1; padding: 2px 4px; border-radius: 3px; }
.hud-toggle:hover { opacity: 1; background: var(--s3); }
#hud.collapsed .hud-toggle { transform: rotate(-90deg); opacity: .4; }
.hud-sep { width: 1px; height: 14px; background: var(--border); flex-shrink: 0; }
.hud-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; flex-shrink: 0; }
.hud-label { font-size: 10px; text-transform: uppercase; letter-spacing: .5px; opacity: .6; }
.hud-val { color: var(--text); font-weight: 600; }
.hud-dim { font-size: 10px; opacity: .55; }
.hud-reset { font-size: 10px; opacity: .5; }
.hud-warn { color: var(--orange) !important; }
.hud-crit { color: var(--red) !important; }
.hud-ctx-bar { width: 70px; height: 4px; background: var(--s3); border-radius: 2px; overflow: hidden; flex-shrink: 0; }
.hud-ctx-fill { height: 100%; width: 0%; border-radius: 2px; background: var(--accent); transition: width .5s ease; }

/* ─── File attachment bar (chips above input) ─── */
.attach-bar { display: flex; flex-wrap: wrap; gap: 6px; padding: 0 2px 8px; }
.attach-bar:empty { display: none; }
.attach-chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--s3); border: 1px solid var(--border); border-radius: 8px;
  padding: 4px 5px; max-width: 200px; animation: fadeUp .12s ease;
}
.attach-chip img { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; flex-shrink: 0; cursor: zoom-in; }
.attach-chip-icon {
  width: 30px; height: 30px; border-radius: 4px; background: var(--s2);
  display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0;
}
.attach-chip-name {
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  font-size: 11.5px; color: var(--muted); max-width: 120px;
}
.attach-chip-rm {
  background: none; border: none; color: var(--muted); cursor: pointer;
  font-size: 13px; padding: 0 2px; line-height: 1; flex-shrink: 0; transition: color .12s;
}
.attach-chip-rm:hover { color: var(--red); }

/* ─── Paperclip button ─── */
.attach-btn {
  width: 30px; height: 30px; border: none; background: none; color: var(--muted);
  border-radius: 7px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: color .12s, background .12s; margin-bottom: 3px; align-self: flex-end;
}
.attach-btn:hover { color: var(--accent2); background: rgba(124,106,239,.1); }
.attach-btn.has-files { color: var(--accent2); }
.attach-btn svg { width: 16px; height: 16px; }

/* ─── Full-screen drag-drop overlay ─── */
.drop-overlay {
  position: fixed; inset: 0; background: rgba(9,13,19,.82);
  display: flex; align-items: center; justify-content: center;
  z-index: 300; opacity: 0; pointer-events: none;
  transition: opacity .15s; backdrop-filter: blur(6px);
}
.drop-overlay.active { opacity: 1; }
.drop-overlay-inner { text-align: center; color: var(--accent2); user-select: none; pointer-events: none; }
.drop-overlay-inner svg { opacity: .8; }
.drop-overlay-inner p { font-size: 20px; font-weight: 700; margin-top: 14px; letter-spacing: -.3px; }
.drop-overlay-inner span { font-size: 13px; color: var(--muted); margin-top: 6px; display: block; }

/* ─── Attachment previews inside message bubbles ─── */
.msg-attachments { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
.msg-attach-img {
  width: 72px; height: 72px; object-fit: cover; border-radius: 8px;
  border: 1px solid rgba(124,106,239,.35); cursor: zoom-in; transition: opacity .15s;
}
.msg-attach-img:hover { opacity: .85; }
.msg-attach-file {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,.05); border: 1px solid var(--border);
  border-radius: 7px; padding: 5px 10px; font-size: 12px; color: var(--muted);
}

/* ─── Reply button (hover on message) ─── */
.reply-btn {
  position: absolute; top: 30px; right: 5px;
  opacity: 0; background: var(--s3); border: 1px solid var(--border);
  color: var(--muted); padding: 3px 7px; border-radius: 5px;
  cursor: pointer; font-size: 13px; line-height: 1; transition: opacity .15s;
}
.mw:hover .reply-btn { opacity: .6; }
.reply-btn:hover { color: var(--text); opacity: 1 !important; background: var(--s2); }

/* ─── Reply preview bar (above textarea) ─── */
.reply-preview {
  display: flex; align-items: center; gap: 8px;
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 10px; margin-bottom: 6px;
  animation: fadeUp .12s ease;
}
.reply-preview-accent { width: 3px; background: var(--accent); border-radius: 2px; align-self: stretch; flex-shrink: 0; }
.reply-preview-content { flex: 1; min-width: 0; }
.reply-preview-role { font-size: 10px; color: var(--accent2); font-weight: 700; text-transform: uppercase; letter-spacing: .4px; margin-bottom: 2px; }
.reply-preview-text { font-size: 12px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.reply-preview-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 15px; padding: 0 3px; line-height: 1; flex-shrink: 0; transition: color .12s; }
.reply-preview-close:hover { color: var(--red); }

/* ─── Reply quote inside message bubble ─── */
.msg-reply-quote {
  font-size: 12px; color: var(--muted);
  border-left: 3px solid var(--accent);
  padding: 4px 8px; margin-bottom: 8px;
  background: rgba(124,106,239,.08); border-radius: 0 6px 6px 0;
  overflow: hidden;
}
.msg-reply-quote .rq-role { font-size: 10px; font-weight: 700; color: var(--accent2); text-transform: uppercase; letter-spacing: .4px; display: block; margin-bottom: 2px; }
.msg-reply-quote .rq-text { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ─── Responsive / Mobile ─── */
#mobileBackdrop {
  display: none; position: fixed; inset: 0; z-index: 45;
  background: rgba(0,0,0,.55); backdrop-filter: blur(4px);
}
@media (max-width: 800px) {
  /* Sidebars: fixed overlay instead of shrinking */
  .left {
    position: fixed; top: 0; left: 0; bottom: 0; z-index: 50;
    width: min(85vw, 300px) !important;
    transform: translateX(0);
    transition: transform .28s var(--ease-out), opacity .28s;
    box-shadow: 6px 0 40px rgba(0,0,0,.55);
    opacity: 1 !important;
  }
  .left.collapsed { transform: translateX(-105%); opacity: 0 !important; pointer-events: none; }
  .right {
    position: fixed; top: 0; right: 0; bottom: 0; z-index: 50;
    width: min(85vw, 300px) !important;
    transform: translateX(0);
    transition: transform .28s var(--ease-out), opacity .28s;
    box-shadow: -6px 0 40px rgba(0,0,0,.55);
    opacity: 1 !important;
  }
  .right.collapsed { transform: translateX(105%); opacity: 0 !important; pointer-events: none; }
  /* Panel tabs — bigger touch targets */
  .panel-tab { width: 32px; }
  .panel-tab-inner { width: 32px; height: 48px; }
  /* Center area adjustments */
  .msgs { padding: 12px 10px; }
  .mw { max-width: 94%; }
  .mw.assistant { padding-left: 28px; }
  .mw.assistant::before { width: 22px; height: 22px; font-size: 8px; }
  .mw.user { padding-right: 28px; }
  .mw.user::after { width: 22px; height: 22px; font-size: 7px; }
  .toolbar { gap: 5px; padding: 5px 10px; }
  .tb-group .label { display: none; }
  .hdr { padding: 8px 12px; }
  .hdr h1 { font-size: 14px; }
  /* Input area */
  .ia { padding: 10px 12px; }
  /* Tabs bar */
  .tabs-bar { overflow-x: auto; }
  .tab { max-width: 140px; }
  /* File preview: full screen on mobile */
  .fpv-modal { width: 100vw !important; max-width: 100vw !important; height: 100vh !important; max-height: 100vh !important; border-radius: 0 !important; }
}
@media (max-width: 480px) {
  .hdr-btns .hb span { display: none; }
  .hb { padding: 5px 8px; }
  .toolbar { font-size: 12px; }
}
</style>
</head>
<body>

<!-- LEFT PANEL -->
<div class="left" id="leftPanel">
  <div class="left-inner">
    <div class="sec">
      <div class="sec-title" onclick="toggleSec('proj')">
        <span data-i18n="sec.projects">Проекти</span>
        <span class="badge" id="projCount"></span>
      </div>
      <div class="sec-body" id="projBody">
        <div id="projList"></div>
        <button class="add-btn" onclick="openAddProject()" data-i18n="proj.add">＋ Додати проект</button>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title" onclick="toggleSec('hist')">
        <span data-i18n="sec.chats">Чати</span> <span class="badge" id="histCount">0</span>
      </div>
      <div class="sec-body" id="histBody">
        <div class="hist-list" id="histList"></div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title" onclick="toggleSec('mcp')">
        <span data-i18n="sec.mcp">MCP</span>
        <span class="badge" id="mcpCount">0</span>
      </div>
      <div class="sec-body" id="mcpBody">
        <div style="font-size:11px;color:var(--muted);padding:2px 2px 8px;line-height:1.5" data-i18n="mcp.hint">Увімкніть інструменти, які Claude може використовувати в цьому чаті.</div>
        <div id="mcpList"></div>
        <button class="add-btn" onclick="showMcpForm()" data-i18n="mcp.add">＋ Додати MCP-сервер</button>
        <div id="mcpForm" style="display:none" class="af">
          <select id="mcpType" onchange="updateMcpFormType()">
            <option value="stdio">stdio (команда)</option>
            <option value="sse">SSE (URL потік)</option>
            <option value="http">HTTP (REST)</option>
          </select>
          <input id="mcpId" data-i18n-ph="mcp.id" placeholder="ID (напр. my-server)">
          <input id="mcpLabel" data-i18n-ph="mcp.label" placeholder="Назва">
          <div id="mcpStdioFields">
            <input id="mcpCmd" data-i18n-ph="mcp.cmd" placeholder="Команда (напр. npx)">
            <input id="mcpArgs" data-i18n-ph="mcp.args" placeholder="Аргументи через кому">
          </div>
          <div id="mcpUrlFields" style="display:none">
            <input id="mcpUrl" placeholder="URL (https://...)">
            <textarea id="mcpHeadersArea" placeholder='{"Authorization":"Bearer TOKEN"}' style="display:none"></textarea>
          </div>
          <textarea id="mcpEnv" placeholder='{"KEY":"value"}'></textarea>
          <div class="fr">
            <button class="bp" onclick="addMcp()" data-i18n="mcp.add_btn">Додати</button>
            <button class="bg" onclick="hideMcpForm()">✕</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title" onclick="toggleSec('skills')">
        <span data-i18n="sec.skills">Навички</span>
        <div style="display:flex;align-items:center;gap:6px;margin-left:auto">
          <span class="badge" id="skillsCount">0</span>
          <button id="autoSkillsBtn" class="auto-skills-btn" onclick="event.stopPropagation();toggleAutoSkills()">⚡ Auto</button>
        </div>
      </div>
      <div class="sec-body" id="skillsBody">
        <div style="font-size:11px;color:var(--muted);padding:2px 2px 8px;line-height:1.5" data-i18n="skills.hint">Навички — файли інструкцій, що додаються до системного промпту.</div>
        <div id="autoSkillsHint" class="auto-notif" style="display:none" data-i18n="skills.auto_hint">⚡ Навички обираються автоматично по тексту задачі</div>
        <div id="skillsList"></div>
        <button class="add-btn" onclick="$i('skillUpload').click()" data-i18n="skills.upload">＋ Завантажити .md файл</button>
        <input type="file" id="skillUpload" accept=".md,.txt" style="display:none" onchange="uploadSkill(this)">
      </div>
    </div>
  </div>
</div>

<!-- LEFT PANEL TAB -->
<div class="panel-tab panel-tab-left active" onclick="toggle('leftPanel')" data-tip="Сховати/показати ліву панель" data-i18n-tip="tip.panels.left">
  <div class="panel-tab-inner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
  </div>
</div>

<!-- CENTER PANEL -->
<div class="center">
  <div class="hdr">
    <div class="hdr-l">
      <div class="logo">CC</div>
      <nav class="nav-sw" aria-label="Навігація між розділами">
        <a class="nav-sw-btn active" href="/" data-tip="Чат">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
          Chat
        </a>
        <a class="nav-sw-btn" href="/kanban" data-tip="Kanban дошка">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="13" rx="1"/><rect x="17" y="3" width="5" height="9" rx="1"/></svg>
          Kanban
        </a>
      </nav>
      <div>
        <div style="display:flex;align-items:center;gap:6px">
          <span class="status-dot warn" id="statusEl">Підключення...</span>
          <span id="activeProjLabel"></span>
          <span id="versionBadge" title="Перевірка версії..."></span>
        </div>
      </div>
    </div>
    <div class="hdr-btns">
      <button class="hb" onclick="newSession()" data-tip="Нова сесія" data-i18n-tip="tip.new"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> <span data-i18n="btn.new">Нова</span></button>
      <button class="hb" onclick="openCfgEditor()" data-tip="Налаштування" data-i18n-tip="tip.cfg"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg></button>
      <select class="lang-sel" id="langSel" onchange="setLang(this.value)" data-tip="Мова інтерфейсу">
        <option value="en">EN</option>
        <option value="uk">UK</option>
        <option value="ru">RU</option>
      </select>
      <a class="hb" href="https://github.com/Lexus2016/claude-code-chat" target="_blank" rel="noopener" data-tip="GitHub" style="text-decoration:none"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.013-1.703-2.782.604-3.369-1.34-3.369-1.34-.454-1.154-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.115 2.504.337 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg></a>
      <button class="hb" onclick="logout()" data-tip="Вийти" data-i18n-tip="tip.logout"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
  </div>

  <div class="toolbar">
    <div class="tb-group">
      <span class="label" data-i18n="tb.mode">Режим</span>
      <button class="tb-btn on" data-v="auto" onclick="setOpt(this,'mode')">Auto</button>
      <button class="tb-btn" data-v="planning" onclick="setOpt(this,'mode')">Plan</button>
      <button class="tb-btn" data-v="task" onclick="setOpt(this,'mode')">Task</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="label" data-i18n="tb.agent">Агент</span>
      <button class="tb-btn on" data-v="single" onclick="setOpt(this,'agent')">Single</button>
      <button class="tb-btn" data-v="multi" onclick="setOpt(this,'agent')">Multi</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="label" data-i18n="tb.model">Модель</span>
      <button class="tb-btn" data-v="haiku" onclick="setOpt(this,'model')">Haiku</button>
      <button class="tb-btn on" data-v="sonnet" onclick="setOpt(this,'model')">Sonnet</button>
      <button class="tb-btn" data-v="opus" onclick="setOpt(this,'model')">Opus</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="label" data-i18n="tb.turns">Кроки</span>
      <input type="number" class="tb-input" id="maxTurns" value="30" min="1" max="100">
    </div>
    <div class="mode-ind" id="modeInd">
      <span class="dot dot-auto"></span> Auto · Single · Sonnet
    </div>
    <div style="flex:1"></div>
  </div>

  <div class="tabs-bar" id="tabsBar"></div>

  <div class="sess-bar" id="sessBar" style="display:none">
    <span id="sessBarTitle" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px;color:var(--text-dim)"></span>
    <span style="flex:1"></span>
    <span id="sessBarId" class="sess-id" onclick="copySessId()" data-i18n-tip="session.copy_id" title="—">—</span>
    <button class="sess-open-btn" onclick="openInClaude()" id="sessOpenBtn" style="display:none" data-i18n-tip="session.open_claude">⚡ Claude Code</button>
  </div>

  <div class="msgs" id="messages" role="log" aria-live="polite" aria-label="Chat messages">
    <div class="welcome">
      <div class="wi">CC</div>
      <h2>Claude Code Chat</h2>
      <p data-i18n="welcome.desc">Виберіть MCP та Навички зліва, файли — справа.</p>
      <div class="welcome-prompts">
        <div class="wp-card" onclick="setPrompt(this)">&#x1F4A1; <span data-i18n="welcome.prompt.1">Поясни цей код крок за кроком</span></div>
        <div class="wp-card" onclick="setPrompt(this)">&#x1F41B; <span data-i18n="welcome.prompt.2">Знайди та виправ помилки</span></div>
        <div class="wp-card" onclick="setPrompt(this)">&#x2728; <span data-i18n="welcome.prompt.3">Напиши unit-тести</span></div>
        <div class="wp-card" onclick="setPrompt(this)">&#x1F3D7;&#xFE0F; <span data-i18n="welcome.prompt.4">Спроектуй архітектуру</span></div>
      </div>
    </div>
  </div>

  <button id="scrollBtn" onclick="scrollToBottom()" data-i18n-title="scroll.down" title="Scroll to bottom">↓</button>

  <div id="statusBar">
    <span class="sb-spin"></span>
    <span class="sb-txt" id="sbTxt"></span>
  </div>

  <div class="ia" style="position:relative">
    <!-- Hidden file input for local file attachment -->
    <input type="file" id="filePickerInput" multiple style="display:none" onchange="onFilePicker(this)">
    <!-- @ file picker popup -->
    <div class="at-popup hidden" id="atPopup">
      <div class="at-popup-hdr">
        <span>📁</span>
        <input id="atSearch" data-i18n-ph="at.search" placeholder="Search file..." autocomplete="off" oninput="onAtSearch(this.value)">
      </div>
      <div class="at-popup-list" id="atList"></div>
    </div>
    <!-- Attachment chips (files + screenshots) -->
    <div class="att-chips" id="attChips"></div>
    <div id="replyPreview" class="reply-preview" style="display:none">
      <div class="reply-preview-accent"></div>
      <div class="reply-preview-content">
        <div class="reply-preview-role" id="replyPreviewRole"></div>
        <div class="reply-preview-text" id="replyPreviewText"></div>
      </div>
      <button class="reply-preview-close" onclick="clearReply()" data-i18n-title="reply.cancel" title="Cancel reply">✕</button>
    </div>
    <div class="iw">
      <button class="attach-btn" type="button" onclick="$i('filePickerInput').click()" data-i18n-title="attach.file" title="Додати файл" aria-label="Attach file">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
        </svg>
      </button>
      <textarea id="input" rows="1" data-i18n-ph="input.ph" placeholder="Напишіть завдання... Вставте скріншот (Ctrl+V) · @ для файлів проекту · 📎 для будь-яких файлів" autofocus aria-label="Message input" aria-multiline="true"></textarea>
      <span class="queue-badge" id="queueBadge" data-i18n-title="queue.title" title="Завдань у черзі"></span>
      <button class="sb stop-btn hidden" id="stopBtn" onclick="confirmStop()" data-i18n-title="stop.agent" title="Stop agent">
        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
      <button class="sb" id="sendBtn" onclick="send()" data-i18n-title="send.msg" title="Send (Enter)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- RIGHT PANEL TAB (left side of right panel) -->
<div class="panel-tab panel-tab-right active" onclick="toggle('rightPanel')" data-tip="Сховати/показати праву панель" data-i18n-tip="tip.panels.right">
  <div class="panel-tab-inner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
  </div>
</div>

<!-- RIGHT PANEL: File Browser -->
<div class="right" id="rightPanel">
  <div class="fh">
    <span data-i18n="files.title">Робоча директорія</span>
    <button onclick="loadFiles()" data-i18n-title="files.refresh" title="Оновити">↻</button>
  </div>
  <div class="ft" id="filesTree"></div>
</div>

<!-- Config Modal -->
<div class="modal-overlay hidden" id="cfgModal" onclick="if(event.target===this)closeCfg()">
  <div class="modal">
    <div class="modal-hdr">
      <h2 data-i18n="cfg.title">Налаштування</h2>
      <button class="modal-close" onclick="closeCfg()">✕</button>
    </div>
    <div class="modal-tabs" id="cfgTabs"></div>
    <div class="modal-body">
      <div class="cfg-path hidden" id="cfgPathInfo"></div>
      <textarea id="cfgEditor" spellcheck="false"></textarea>
    </div>
    <div class="modal-footer">
      <span class="save-notice hidden" id="saveNotice" data-i18n="cfg.saved">✓ Збережено</span>
      <div style="display:flex;gap:8px">
        <button class="bg" onclick="closeCfg()" data-i18n="cfg.close">Закрити</button>
        <button class="bp" onclick="saveCfg()" data-i18n="cfg.save">Зберегти</button>
      </div>
    </div>
  </div>
</div>

<!-- MCP Settings Modal -->
<div class="modal-overlay hidden" id="mcpSettingsModal" onclick="if(event.target===this)closeMcpSettings()">
  <div class="modal" style="width:440px;max-height:72vh">
    <div class="modal-hdr">
      <h2 id="mcpSettingsTitle" style="font-size:14px">⚙ MCP</h2>
      <button class="modal-close" onclick="closeMcpSettings()">✕</button>
    </div>
    <div class="modal-body" id="mcpSettingsBody" style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;overflow-y:auto"></div>
    <div class="modal-footer">
      <button class="bg" onclick="closeMcpSettings()" data-i18n="mcp.cfg.cancel">Скасувати</button>
      <button class="bp" onclick="saveMcpSettings()" data-i18n="mcp.cfg.save">Зберегти</button>
    </div>
  </div>
</div>

<!-- File Preview Modal -->
<div class="modal-overlay hidden" id="filePreviewModal" onclick="if(event.target===this)closeFpv()">
  <div class="modal fpv-modal">
    <div class="modal-hdr">
      <h2 id="fpvTitle" style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0"></h2>
      <button class="modal-close" onclick="closeFpv()">✕</button>
    </div>
    <div class="fpv-toolbar">
      <span class="fpv-ext" id="fpvExt"></span>
      <button class="fpv-btn" onclick="fpvDownload()" data-i18n-title="fpv.download.title" title="Завантажити файл">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span data-i18n="fpv.download">Завантажити</span>
      </button>
      <button class="fpv-btn" onclick="fpvShare()" id="fpvShareBtn" data-i18n-title="fpv.share.title" title="Поділитись / Скопіювати посилання">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        <span data-i18n="fpv.share">Поділитись</span>
      </button>
    </div>
    <div class="fpv-body" id="fpvBody"></div>
  </div>
</div>

<!-- Directory Browser Modal -->
<div class="modal-overlay hidden" id="dirModal" onclick="if(event.target===this)closeDirModal()">
  <div class="modal dir-modal">
    <div class="modal-hdr">
      <h2 data-i18n="dir.title">Новий проект</h2>
      <button class="modal-close" onclick="closeDirModal()">✕</button>
    </div>
    <div class="dir-path-bar">
      <span class="path-text" id="dirCurrentPath">/</span>
    </div>
    <div class="dir-list" id="dirList">
      <div style="padding:14px;color:var(--muted);text-align:center;font-size:12px" data-i18n="toast.loading">Завантаження...</div>
    </div>
    <div class="proj-name-row">
      <span style="font-size:12px;color:var(--muted);white-space:nowrap">Назва:</span>
      <input id="projNameInput" data-i18n-ph="dir.proj_name" placeholder="Назва проекту (авто якщо порожньо)">
    </div>
    <div class="dir-footer">
      <label>
        <input type="checkbox" id="gitInitChk">
        git init (якщо ще не репозиторій)
      </label>
      <div style="flex:1"></div>
      <button class="bg" onclick="closeDirModal()" style="padding:6px 14px" data-i18n="dir.cancel">Cancel</button>
      <button class="bp" onclick="selectDir()" style="padding:6px 14px">＋ Додати проект</button>
    </div>
  </div>
</div>

<!-- Confirm Stop Modal -->
<div class="confirm-overlay hidden" id="confirmStopModal" onclick="if(event.target===this)cancelStop()">
  <div class="confirm-dialog">
    <div class="cd-icon">⏹</div>
    <h3 data-i18n="confirm.stop.h">Stop task?</h3>
    <p>Виконання агента буде перервано.</p>
    <div class="confirm-actions">
      <button class="cd-btn-cancel" onclick="cancelStop()" data-i18n="confirm.stop.cancel">Cancel</button>
      <button class="cd-btn-stop" id="confirmStopBtn" onclick="doStop()" data-i18n="confirm.stop.yes">Yes, stop</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
'use strict';

// ─── State ───────────────────────────────────────────────────────────────────
let ws = null, isGen = false, curEl = null, curTxt = '', currentSessionId = null, generatingTabId = null;
let replyTo = null; // { id, role, content }
let openTabs = [], activeTabId = null;
const tabState = {}; // per-tab: { curEl, curTxt, currentSessionId, generating, draft }
function getTS(id) {
  if (!tabState[id]) tabState[id] = { curEl: null, curTxt: '', currentSessionId: null, generating: false, draft: '' };
  return tabState[id];
}
let config = { mcpServers: {}, skills: {} };
let activeMcp = new Set(), activeSkills = new Set();
let autoSkillsMode = true; // ON by default; user can disable
let cfgFiles = {}, activeCfgTab = null;
let curMode = 'auto', curAgent = 'single', curModel = 'sonnet', curEngine = 'cli';
let curWorkdir = null; // current working directory for the session
let projects = [], curProjectId = null; // projects list + active project

// ─── Per-project in-memory tab state ─────────────────────────────────────
// Keeps all projects' tabs alive simultaneously so background generation continues
const projectTabs = {};      // { projectId: Tab[] }  — live references to openTabs arrays
const projectActiveTab = {}; // { projectId: string|null } — last active tab per project

// Find a tab across current project and all background projects
function findTabAcrossProjects(tabId) {
  let tab = openTabs.find(t => t.id === tabId);
  if (tab) return { tab, tabs: openTabs, projId: curProjectId, isCurrent: true };
  for (const [pid, tabs] of Object.entries(projectTabs)) {
    if (pid === curProjectId) continue;
    tab = tabs.find(t => t.id === tabId);
    if (tab) return { tab, tabs, projId: pid, isCurrent: false };
  }
  return null;
}
let userScrolled = false; // track if user scrolled up
let histOffset = 0;       // offset of the oldest rendered message (non-tool)
let histTotal  = 0;       // total non-tool message count for current session
let dirBrowsePath = null; // path currently shown in dir browser
let _onProjectCreated = null; // callback to invoke after a new project is created

const $i = id => document.getElementById(id);
const msgsEl = $i('messages');
const inEl = $i('input');

// ─── i18n ─────────────────────────────────────────────────────────────────
const TRANSLATIONS = {
  uk: {
    'sec.proactive':'Статус',
    'sec.chats':'Чати','sec.mcp':'MCP',
    'mcp.hint':'Увімкніть інструменти, які Claude може використовувати в цьому чаті.',
    'mcp.add':'＋ Додати MCP-сервер','mcp.id':'ID (напр. my-server)','mcp.label':'Назва',
    'mcp.cmd':'Команда (напр. npx)','mcp.args':'Аргументи через кому','mcp.add_btn':'Додати',
    'sec.skills':'Навички','skills.hint':'Навички — файли інструкцій, що додаються до системного промпту.',
    'skills.upload':'＋ Завантажити .md файл','sec.projects':'Проекти','proj.add':'＋ Додати проект',
    'tip.new':'Нова сесія','tip.cfg':'Налаштування','tip.logout':'Вийти',
    'tip.panels.left':'Сховати/показати ліву панель','tip.panels.right':'Сховати/показати праву панель',
    'btn.new':'Нова','tb.mode':'Режим','tb.agent':'Агент','tb.model':'Модель','tb.turns':'Кроки',
    'welcome.title':'Нова сесія','welcome.ready':'Готовий до роботи',
    'welcome.desc':'Виберіть MCP та Навички зліва, файли — справа.',
    'input.ph':'Напишіть завдання... Вставте скріншот (Ctrl+V) · @ для файлів проекту · 📎 для будь-яких файлів',
    'files.title':'Робоча директорія','files.refresh':'Оновити','queue.title':'Завдань у черзі',
    'cfg.title':'Налаштування','cfg.saved':'✓ Збережено','cfg.close':'Закрити','cfg.save':'Зберегти',
    'dir.title':'Новий проект','toast.loading':'Завантаження...',
    'scroll.down':'Прокрутити вниз',
    'at.search':'Пошук файлу...',
    'reply.cancel':'Скасувати відповідь',
    'stop.agent':'Зупинити агента',
    'send.msg':'Надіслати (Enter)',
    'dir.cancel':'Скасувати',
    'confirm.stop.h':'Зупинити завдання?',
    'confirm.stop.yes':'Так, зупинити',
    'confirm.stop.cancel':'Скасувати',
    'copy.code':'Копіювати',
    'copy.msg':'Копіювати',
    'msg.reply':'Відповісти',
    'tab.new':'Новий чат',
    'you.label':'Ви',
    'err.stop.switch':'Зупиніть агента перед переключенням',
    'err.stop.close':'Зупиніть агента перед закриттям',
    'err.stop.new':'Зупиніть агента перед відкриттям нового чату',
    'err.stop.project':'Зупиніть агента перед зміною проекту',
    'queue.cancel':'Скасувати','queue.save':'Зберегти',
    'proj.deactivated':'Проект деактивовано',
    'load.more':'↑ Завантажити попередні повідомлення',
    'logout.confirm':'Вийти з системи?\n\nВсі активні сесії залишаться збережені.',
    'proj.delete.confirm':'Видалити проект "{{name}}"?\n\nДиректорія НЕ буде видалена.',
    'proj.active':'● Активний','proj.inactive':'○ Не активний',
    'proj.active.title':'Активний проект','proj.click.title':'Клік — активувати',
    'proj.del.title':'Видалити проект',
    'chip.remove':'Видалити',
    'attach.file':'Додати файл (📎)',
    'queue.label':'У черзі','queue.edit.title':'Редагувати повідомлення','queue.del.title':'Видалити з черги',
    'agents.title':'Активні агенти',
    'sess.delete.confirm':'Видалити сесію?','sess.load.err':'Помилка завантаження сесії',
    'mcp.active':'● Активний у чаті','mcp.inactive':'○ Вимкнений','mcp.del.title':'Видалити сервер',
    'mcp.cfg.tip':'Налаштування','mcp.cfg.warn':'Потрібна конфігурація',
    'mcp.toggle.on':'Клік — вимкнути','mcp.toggle.off':'Клік — увімкнути',
    'mcp.cfg.api_warn':'⚠ Вкажіть API ключі для активації',
    'mcp.cfg.no_params':'Немає параметрів для налаштування',
    'mcp.cfg.saved':'✓ Налаштування збережено','mcp.cfg.save_err':'Помилка збереження',
    'mcp.cfg.cancel':'Скасувати','mcp.cfg.save':'Зберегти',
    'mcp.add.id_req':'ID обов\'язковий','mcp.add.url_req':'URL обов\'язковий',
    'mcp.add.cmd_req':'Команда обов\'язкова','mcp.add.ok':'✓ MCP сервер додано',
        'skill.active':'● У системному промпті','skill.inactive':'○ Не активний','skill.del.title':'Видалити skill',
    'skills.auto_hint':'⚡ Навички обираються автоматично по тексту задачі',
    'auto.title.on':'⚡ Auto-Skills: увімкнено — клік для вимкнення',
    'auto.title.off':'⚡ Auto-Skills: вимкнено — клік для увімкнення',
    'status.connected':'Підключено','status.generating':'Генерація…','status.thinking':'Обдумування...','status.processing':'Обробка...','status.reconnecting':'Перепідключення…','status.stopped':'Зупинено','status.error':'Помилка',
    'fpv.download':'Завантажити','fpv.download.title':'Завантажити файл','fpv.share':'Поділитись','fpv.share.title':'Поділитись / Скопіювати посилання','fpv.binary':'Бінарний файл — перегляд недоступний','fpv.img_error':'Помилка завантаження зображення','fpv.load_error':'Помилка завантаження файлу',
    'toast.no_connection':'Немає з\'єднання','toast.sess_not_found':'Сесію не знайдено','toast.cfg_load_err':'Помилка завантаження конфігурації','toast.skill_uploaded':'✓ Скіл завантажено','toast.link_copied':'✓ Посилання скопійовано','toast.select_dir':'Виберіть директорію','toast.link_prompt':'Скопіюйте посилання:',
    'at.no_project':'Оберіть проект, щоб шукати файли','at.searching':'Пошук...','at.search_err':'Помилка пошуку','at.no_files':'Файлів не знайдено',
    'dir.this_dir':'. (ця директорія)','dir.no_subdirs':'Немає підпапок',
    'toast.read_err':'Не вдалося прочитати: ','toast.err_prefix':'Помилка: ','dir.proj_name':'Назва проекту (авто якщо порожньо)',
    'welcome.prompt.1':'Поясни цей код крок за кроком','welcome.prompt.2':'Знайди та виправ помилки','welcome.prompt.3':'Напиши unit-тести','welcome.prompt.4':'Спроектуй архітектуру',
    'toast.task_resumed':'Задачу відновлено','toast.task_lost':'З\'єднання втрачено, вивід недоступний','toast.task_interrupted':'Задачу перервано. Повторити?','toast.task_retry':'Повторити',
    'session.copy_id':'Скопіювати ID сесії Claude','session.open_claude':'Відкрити в Claude Code',
  },
  en: {
    'sec.proactive':'Status',
    'sec.chats':'Chats','sec.mcp':'MCP',
    'mcp.hint':'Enable tools that Claude can use in this chat.',
    'mcp.add':'＋ Add MCP server','mcp.id':'ID (e.g. my-server)','mcp.label':'Label',
    'mcp.cmd':'Command (e.g. npx)','mcp.args':'Args comma-separated','mcp.add_btn':'Add',
    'sec.skills':'Skills','skills.hint':'Skills are instruction files added to the system prompt.',
    'skills.upload':'＋ Upload .md file','sec.projects':'Projects','proj.add':'＋ Add project',
    'tip.new':'New session','tip.cfg':'Configuration','tip.logout':'Logout',
    'tip.panels.left':'Toggle left panel','tip.panels.right':'Toggle right panel',
    'btn.new':'New','tb.mode':'Mode','tb.agent':'Agent','tb.model':'Model','tb.turns':'Turns',
    'welcome.title':'New session','welcome.ready':'Ready to work',
    'welcome.desc':'Choose MCP and Skills on the left, files on the right.',
    'input.ph':'Write a task... Paste screenshot (Ctrl+V) · @ for project files · 📎 for any files',
    'files.title':'Workspace','files.refresh':'Refresh','queue.title':'Tasks waiting in queue',
    'cfg.title':'Configuration','cfg.saved':'✓ Saved','cfg.close':'Close','cfg.save':'Save',
    'dir.title':'New project','toast.loading':'Loading...',
    'scroll.down':'Scroll to bottom',
    'at.search':'Search file...',
    'reply.cancel':'Cancel reply',
    'stop.agent':'Stop agent',
    'send.msg':'Send (Enter)',
    'dir.cancel':'Cancel',
    'confirm.stop.h':'Stop task?',
    'confirm.stop.yes':'Yes, stop',
    'confirm.stop.cancel':'Cancel',
    'copy.code':'Copy',
    'copy.msg':'Copy',
    'msg.reply':'Reply',
    'tab.new':'New chat',
    'you.label':'You',
    'err.stop.switch':'Stop agent before switching',
    'err.stop.close':'Stop agent before closing',
    'err.stop.new':'Stop agent before opening a new chat',
    'err.stop.project':'Stop agent before switching project',
    'queue.cancel':'Cancel','queue.save':'Save',
    'proj.deactivated':'Project deactivated',
    'load.more':'↑ Load previous messages',
    'logout.confirm':'Sign out?\n\nAll active sessions will remain saved.',
    'proj.delete.confirm':'Delete project "{{name}}"?\n\nThe directory will NOT be deleted.',
    'proj.active':'● Active','proj.inactive':'○ Inactive',
    'proj.active.title':'Active project','proj.click.title':'Click to activate',
    'proj.del.title':'Delete project',
    'chip.remove':'Remove',
    'attach.file':'Attach file (📎)',
    'queue.label':'In queue','queue.edit.title':'Edit message','queue.del.title':'Remove from queue',
    'agents.title':'Active agents',
    'sess.delete.confirm':'Delete session?','sess.load.err':'Error loading session',
    'mcp.active':'● Active in chat','mcp.inactive':'○ Disabled','mcp.del.title':'Remove server',
    'mcp.cfg.tip':'Settings','mcp.cfg.warn':'Configuration required',
    'mcp.toggle.on':'Click to disable','mcp.toggle.off':'Click to enable',
    'mcp.cfg.api_warn':'⚠ Set API keys to enable',
    'mcp.cfg.no_params':'No parameters to configure',
    'mcp.cfg.saved':'✓ Settings saved','mcp.cfg.save_err':'Save error',
    'mcp.cfg.cancel':'Cancel','mcp.cfg.save':'Save',
    'mcp.add.id_req':'ID is required','mcp.add.url_req':'URL is required',
    'mcp.add.cmd_req':'Command is required','mcp.add.ok':'✓ MCP server added',
        'skill.active':'● In system prompt','skill.inactive':'○ Inactive','skill.del.title':'Remove skill',
    'skills.auto_hint':'⚡ Skills are auto-selected based on task text',
    'auto.title.on':'⚡ Auto-Skills: enabled — click to disable',
    'auto.title.off':'⚡ Auto-Skills: disabled — click to enable',
    'status.connected':'Connected','status.generating':'Generating…','status.thinking':'Thinking...','status.processing':'Processing...','status.reconnecting':'Reconnecting…','status.stopped':'Stopped','status.error':'Error',
    'fpv.download':'Download','fpv.download.title':'Download file','fpv.share':'Share','fpv.share.title':'Share / Copy link','fpv.binary':'Binary file — preview not available','fpv.img_error':'Image load error','fpv.load_error':'File load error',
    'toast.no_connection':'No connection','toast.sess_not_found':'Session not found','toast.cfg_load_err':'Config load error','toast.skill_uploaded':'✓ Skill uploaded','toast.link_copied':'✓ Link copied','toast.select_dir':'Select a directory','toast.link_prompt':'Copy link:',
    'at.no_project':'Select a project to search files','at.searching':'Searching...','at.search_err':'Search error','at.no_files':'No files found',
    'dir.this_dir':'. (this directory)','dir.no_subdirs':'No subdirectories',
    'toast.read_err':'Failed to read: ','toast.err_prefix':'Error: ','dir.proj_name':'Project name (auto if empty)',
    'welcome.prompt.1':'Explain this code step by step','welcome.prompt.2':'Find and fix bugs','welcome.prompt.3':'Write unit tests','welcome.prompt.4':'Design the architecture',
    'toast.task_resumed':'Task resumed','toast.task_lost':'Connection lost, output unavailable','toast.task_interrupted':'Task was interrupted. Retry?','toast.task_retry':'Retry',
    'session.copy_id':'Copy Claude session ID','session.open_claude':'Open in Claude Code',
  },
  ru: {
    'sec.proactive':'Статус',
    'sec.chats':'Чаты','sec.mcp':'MCP',
    'mcp.hint':'Включите инструменты, которые Claude может использовать в этом чате.',
    'mcp.add':'＋ Добавить MCP-сервер','mcp.id':'ID (напр. my-server)','mcp.label':'Название',
    'mcp.cmd':'Команда (напр. npx)','mcp.args':'Аргументы через запятую','mcp.add_btn':'Добавить',
    'sec.skills':'Навыки','skills.hint':'Навыки — файлы инструкций, добавляемые в системный промпт.',
    'skills.upload':'＋ Загрузить .md файл','sec.projects':'Проекты','proj.add':'＋ Добавить проект',
    'tip.new':'Новая сессия','tip.cfg':'Настройки','tip.logout':'Выйти',
    'tip.panels.left':'Скрыть/показать левую панель','tip.panels.right':'Скрыть/показать правую панель',
    'btn.new':'Новая','tb.mode':'Режим','tb.agent':'Агент','tb.model':'Модель','tb.turns':'Шаги',
    'welcome.title':'Новая сессия','welcome.ready':'Готов к работе',
    'welcome.desc':'Выберите MCP и Навыки слева, файлы — справа.',
    'input.ph':'Напишите задание... Вставьте скриншот (Ctrl+V) · @ для файлов проекта · 📎 для любых файлов',
    'files.title':'Рабочая директория','files.refresh':'Обновить','queue.title':'Задач в очереди',
    'cfg.title':'Настройки','cfg.saved':'✓ Сохранено','cfg.close':'Закрыть','cfg.save':'Сохранить',
    'dir.title':'Новый проект','toast.loading':'Загрузка...',
    'scroll.down':'Прокрутить вниз',
    'at.search':'Поиск файла...',
    'reply.cancel':'Отменить ответ',
    'stop.agent':'Остановить агента',
    'send.msg':'Отправить (Enter)',
    'dir.cancel':'Отмена',
    'confirm.stop.h':'Остановить задание?',
    'confirm.stop.yes':'Да, остановить',
    'confirm.stop.cancel':'Отмена',
    'copy.code':'Копировать',
    'copy.msg':'Копировать',
    'msg.reply':'Ответить',
    'tab.new':'Новый чат',
    'you.label':'Вы',
    'err.stop.switch':'Остановите агента перед переключением',
    'err.stop.close':'Остановите агента перед закрытием',
    'err.stop.new':'Остановите агента перед открытием нового чата',
    'err.stop.project':'Остановите агента перед сменой проекта',
    'queue.cancel':'Отмена','queue.save':'Сохранить',
    'proj.deactivated':'Проект деактивирован',
    'load.more':'↑ Загрузить предыдущие сообщения',
    'logout.confirm':'Выйти из системы?\n\nВсе активные сессии останутся сохранены.',
    'proj.delete.confirm':'Удалить проект "{{name}}"?\n\nДиректория НЕ будет удалена.',
    'proj.active':'● Активен','proj.inactive':'○ Не активен',
    'proj.active.title':'Активный проект','proj.click.title':'Клик — активировать',
    'proj.del.title':'Удалить проект',
    'chip.remove':'Удалить',
    'attach.file':'Прикрепить файл (📎)',
    'queue.label':'В очереди','queue.edit.title':'Редактировать сообщение','queue.del.title':'Удалить из очереди',
    'agents.title':'Активные агенты',
    'sess.delete.confirm':'Удалить сессию?','sess.load.err':'Ошибка загрузки сессии',
    'mcp.active':'● Активен в чате','mcp.inactive':'○ Отключен','mcp.del.title':'Удалить сервер',
    'mcp.cfg.tip':'Настройки','mcp.cfg.warn':'Требуется настройка',
    'mcp.toggle.on':'Клик — отключить','mcp.toggle.off':'Клик — включить',
    'mcp.cfg.api_warn':'⚠ Укажите API ключи для активации',
    'mcp.cfg.no_params':'Нет параметров для настройки',
    'mcp.cfg.saved':'✓ Настройки сохранены','mcp.cfg.save_err':'Ошибка сохранения',
    'mcp.cfg.cancel':'Отмена','mcp.cfg.save':'Сохранить',
    'mcp.add.id_req':'ID обязателен','mcp.add.url_req':'URL обязателен',
    'mcp.add.cmd_req':'Команда обязательна','mcp.add.ok':'✓ MCP сервер добавлен',
        'skill.active':'● В системном промпте','skill.inactive':'○ Неактивен','skill.del.title':'Удалить skill',
    'skills.auto_hint':'⚡ Навыки выбираются автоматически по тексту задачи',
    'auto.title.on':'⚡ Auto-Skills: включено — клик для отключения',
    'auto.title.off':'⚡ Auto-Skills: отключено — клик для включения',
    'status.connected':'Подключено','status.generating':'Генерация…','status.thinking':'Обдумывание...','status.processing':'Обработка...','status.reconnecting':'Переподключение…','status.stopped':'Остановлено','status.error':'Ошибка',
    'fpv.download':'Скачать','fpv.download.title':'Скачать файл','fpv.share':'Поделиться','fpv.share.title':'Поделиться / Скопировать ссылку','fpv.binary':'Бинарный файл — предпросмотр недоступен','fpv.img_error':'Ошибка загрузки изображения','fpv.load_error':'Ошибка загрузки файла',
    'toast.no_connection':'Нет соединения','toast.sess_not_found':'Сессия не найдена','toast.cfg_load_err':'Ошибка загрузки конфигурации','toast.skill_uploaded':'✓ Навык загружен','toast.link_copied':'✓ Ссылка скопирована','toast.select_dir':'Выберите директорию','toast.link_prompt':'Скопируйте ссылку:',
    'at.no_project':'Выберите проект для поиска файлов','at.searching':'Поиск...','at.search_err':'Ошибка поиска','at.no_files':'Файлов не найдено',
    'dir.this_dir':'. (эта директория)','dir.no_subdirs':'Нет подпапок',
    'toast.read_err':'Не удалось прочитать: ','toast.err_prefix':'Ошибка: ','dir.proj_name':'Название проекта (авто если пусто)',
    'welcome.prompt.1':'Объясни этот код шаг за шагом','welcome.prompt.2':'Найди и исправь ошибки','welcome.prompt.3':'Напиши unit-тесты','welcome.prompt.4':'Спроектируй архитектуру',
    'toast.task_resumed':'Задача возобновлена','toast.task_lost':'Соединение потеряно, вывод недоступен','toast.task_interrupted':'Задача прервана. Повторить?','toast.task_retry':'Повторить',
    'session.copy_id':'Скопировать ID сессии Claude','session.open_claude':'Открыть в Claude Code',
  }
};
function t(key) {
  const lang = localStorage.getItem('lang') || 'uk';
  return (TRANSLATIONS[lang] || TRANSLATIONS.uk)[key] || key;
}
function setLang(lang) {
  const t = TRANSLATIONS[lang] || TRANSLATIONS.uk;
  localStorage.setItem('lang', lang);
  const sel = $i('langSel'); if (sel) sel.value = lang;
  document.documentElement.lang = lang;
  document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.getAttribute('data-i18n'); if (t[k] !== undefined) el.textContent = t[k]; });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => { const k = el.getAttribute('data-i18n-ph'); if (t[k] !== undefined) el.placeholder = t[k]; });
  document.querySelectorAll('[data-i18n-tip]').forEach(el => { const k = el.getAttribute('data-i18n-tip'); if (t[k] !== undefined) el.setAttribute('data-tip', t[k]); });
  document.querySelectorAll('[data-i18n-title]').forEach(el => { const k = el.getAttribute('data-i18n-title'); if (t[k] !== undefined) el.title = t[k]; });
}

// ─── Auth ─────────────────────────────────────────────────────────────────
(async () => {
  const r = await fetch('/api/auth/status');
  const d = await r.json();
  if (!d.loggedIn) window.location.href = d.setupDone ? '/login' : '/setup';
})();

async function logout() {
  if (!confirm(t('logout.confirm'))) return;
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/login';
}

// ─── Toast ────────────────────────────────────────────────────────────────
let toastTimer = null;
function toast(msg, isErr = false, dur = 3000) {
  const el = $i('toast');
  el.textContent = msg;
  el.className = 'show' + (isErr ? ' toast-err' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', dur);
}

// ─── Markdown renderer ───────────────────────────────────────────────────
function escH(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function renderMd(text) {
  if (!text) return '';

  // 1. Extract and protect code blocks
  const blocks = [];
  text = text.replace(/```(\w*)\r?\n?([\s\S]*?)```/g, (_, lang, code) => {
    const idx = blocks.length;
    blocks.push({ lang: lang.trim(), code: code.replace(/\n$/, '') });
    return `\x02BLOCK${idx}\x03`;
  });

  // 2. Escape remaining HTML
  text = escH(text);

  // 3. Block elements (order matters)
  // Headers
  text = text.replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>');
  text = text.replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>');
  text = text.replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>');

  // Horizontal rule
  text = text.replace(/^(?:---|\*\*\*|___)\s*$/gm, '<hr>');

  // Blockquote
  text = text.replace(/^&gt;\s*(.+)$/gm, function(_, c) {
    return '<blockquote><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/></svg><span>' + c + '</span></blockquote>';
  });

  // Bullet lists (group consecutive items)
  text = text.replace(/((?:^[-*+]\s+.+\n?)+)/gm, m => {
    const items = m.trim().split('\n').map(l => `<li>${l.replace(/^[-*+]\s+/, '')}</li>`).join('');
    return `<ul>${items}</ul>`;
  });

  // Ordered lists
  text = text.replace(/((?:^\d+\.\s+.+\n?)+)/gm, m => {
    const items = m.trim().split('\n').map(l => `<li>${l.replace(/^\d+\.\s+/, '')}</li>`).join('');
    return `<ol>${items}</ol>`;
  });

  // 3.5 Tables — header row + separator row + data rows
  text = text.replace(/((?:^\|.+\|\s*\n?)+)/gm, block => {
    const rows = block.trim().split('\n');
    if (rows.length < 2) return block;
    // Validate separator row (only |, -, :, spaces)
    if (!/^\|[\s\-:|]+\|/.test(rows[1])) return block;
    const parseRow = row => row.replace(/^\||\|$/g, '').split('|').map(c => c.trim());
    const headers = parseRow(rows[0]);
    const dataRows = rows.slice(2).filter(r => r.trim());
    const thead = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody = dataRows.length
      ? `<tbody>${dataRows.map(r => `<tr>${parseRow(r).map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`
      : '';
    return `<div class="table-wrap"><table>${thead}${tbody}</table></div>`;
  });

  // 4. Inline elements
  // Bold + italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  // Bold
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');
  // Italic
  text = text.replace(/\*(?!\s)(.+?)(?<!\s)\*/g, '<em>$1</em>');
  text = text.replace(/_(?!\s)(.+?)(?<!\s)_/g, '<em>$1</em>');
  // Strikethrough
  text = text.replace(/~~(.+?)~~/g, '<del>$1</del>');
  // Inline code
  text = text.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  // Links
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

  // 5. Paragraphs — wrap lines that aren't block elements
  const blockTags = /^<(?:h[1-6]|ul|ol|li|hr|blockquote|pre|div)/;
  const lines = text.split('\n');
  const out = [];
  let para = [];
  const flushPara = () => {
    if (para.length) { out.push('<p>' + para.join('<br>') + '</p>'); para = []; }
  };
  for (const line of lines) {
    if (blockTags.test(line.trimStart())) { flushPara(); out.push(line); }
    else if (line.trim() === '') { flushPara(); }
    else { para.push(line); }
  }
  flushPara();
  text = out.join('\n');

  // 6. Restore code blocks with header + copy button
  text = text.replace(/\x02BLOCK(\d+)\x03/g, (_, i) => {
    const { lang, code } = blocks[+i];
    const id = 'cb' + Math.random().toString(36).slice(2, 8);
    const langLabel = lang || 'code';
    return `<pre><div class="pre-header"><span class="lang">${escH(langLabel)}</span><button class="copy-code-btn" onclick="copyCode('${id}',this)">${t('copy.code')}</button></div><code id="${id}">${escH(code)}</code></pre>`;
  });

  return text;
}

// Handle streaming: unclosed code fences shown as plain pre
const STREAM_CURSOR = '<span class="stream-cursor"></span>';
function renderStreaming(text) {
  // Count code fences — if odd, the last block is open
  const fences = (text.match(/```/g) || []).length;
  if (fences % 2 !== 0) {
    // Has open code block — render what's closed, append raw for open
    const lastFence = text.lastIndexOf('```');
    const closed = text.substring(0, lastFence);
    const open = text.substring(lastFence + 3);
    const langEnd = open.indexOf('\n');
    const lang = langEnd > -1 ? open.substring(0, langEnd) : '';
    const code = langEnd > -1 ? open.substring(langEnd + 1) : '';
    return renderMd(closed) + `<pre><div class="pre-header"><span class="lang">${escH(lang || 'code')}</span></div><code>${escH(code)}</code></pre>` + STREAM_CURSOR;
  }
  return renderMd(text) + STREAM_CURSOR;
}

function copyCode(id, btn) {
  const code = $i(id);
  if (!code) return;
  navigator.clipboard.writeText(code.textContent).then(() => {
    const orig = btn.textContent;
    btn.textContent = '✓ ' + t('copy.code');
    btn.classList.add('ok');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('ok'); }, 1500);
  });
}

// ─── WebSocket ────────────────────────────────────────────────────────────
let _reconnectDelay = 1000; // starts at 1 s, doubles up to 30 s
let _reconnectTimer = null;
let _intentionalClose = false; // set before navigating away to suppress reconnect

function connect() {
  if (_reconnectTimer) { clearTimeout(_reconnectTimer); _reconnectTimer = null; }

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}`);

  ws.onopen = () => {
    _reconnectDelay = 1000; // reset backoff on successful connect
    setStatus(t('status.connected'), 'ok');
    loadFiles();
    loadHist();
    // On page refresh: currentSessionId is null (restoreUIState doesn't call loadSess),
    // but activeTabId may point to a real session — load it now so history appears.
    if (!currentSessionId && activeTabId && openTabs.find(t => t.id === activeTabId && !t.isNew)) {
      loadSess(activeTabId); // loadSess sets currentSessionId and sends start_session at the end
    } else if (currentSessionId && ws.readyState === 1) {
      // Re-attach to active session after a reconnect
      ws.send(JSON.stringify({ type: 'start_session', sessionId: currentSessionId, mode: curMode, agentMode: curAgent, model: curModel, engine: 'cli'}));
      ws.send(JSON.stringify({ type: 'subscribe_session', sessionId: currentSessionId }));
    }
    // Resume generating tabs across ALL projects (not just current)
    const allTabArrays = [openTabs, ...Object.entries(projectTabs).filter(([pid]) => pid !== curProjectId).map(([,tabs]) => tabs)];
    for (const tabs of allTabArrays) {
      for (const tab of tabs) {
        if (tab.generating && tab.id && ws.readyState === 1) {
          ws.send(JSON.stringify({ type: 'resume_task', sessionId: tab.id, tabId: tab.id }));
        }
      }
    }
  };

  ws.onclose = (ev) => {
    // Clean close (e.g. server shutdown code 1001, or intentional nav) — reconnect
    if (_intentionalClose) return;
    setStatus(t('status.reconnecting'), 'err');
    if (isGen) { isGen = false; setSendStop(false); generatingTabId = null; } // reset generating state
    // Exponential backoff with ±20 % jitter, capped at 30 s
    const jitter = _reconnectDelay * 0.2 * (Math.random() * 2 - 1);
    _reconnectTimer = setTimeout(() => {
      _reconnectDelay = Math.min(_reconnectDelay * 2, 30000);
      connect();
    }, _reconnectDelay + jitter);
  };

  ws.onmessage = e => {
    let d;
    try { d = JSON.parse(e.data); } catch { return; }
    handleWsMsg(d);
  };

  // onerror always precedes onclose — just log; onclose handles UI + reconnect
  ws.onerror = (err) => { console.warn('WebSocket error:', err); };
}

// Stop reconnect loop on page unload to avoid pointless connections
window.addEventListener('beforeunload', () => { _intentionalClose = true; if (_reconnectTimer) clearTimeout(_reconnectTimer); });

function handleWsMsg(d) {
  const tabId = d.tabId || (generatingTabId || activeTabId);
  // Look up tab across current project AND all background projects
  const found = findTabAcrossProjects(tabId);
  const isCurrent = found ? found.isCurrent : true;
  const isVisible = isCurrent && tabId === activeTabId;

  switch (d.type) {
    case 'task_started':
      if (isVisible) {
        rmW();
        setStatus('⚙ ' + (d.title || 'Task') + '…', 'warn');
        sbShow('⚙ ' + (d.title || 'Task') + '…');
        if (!curEl) { curEl = addMsg('assistant'); curTxt = ''; addSpinner(curEl); }
      }
      if (found?.tab) { found.tab.generating = true; renderTabs(); }
      break;

    case 'text':
      if (!isVisible) break;
      rmStatus();
      if (!curEl) { rmW(); curEl = addMsg('assistant'); curTxt = ''; addSpinner(curEl); }
      curTxt += d.text;
      curEl.querySelector('.msg').innerHTML = renderStreaming(curTxt);
      if (d.agent) addAgentBadge(curEl, d.agent);
      scrollBottom();
      break;

    case 'tool':
      if (!curEl && isVisible) showStatus('⚙ ' + (d.tool || 'tool'));
      break;

    case 'thinking':
      if (!curEl && isVisible) showStatus(t('status.thinking'));
      break;

    case 'agent_status':
      if (isVisible) showStatus((d.agent ? d.agent + ' · ' : '') + escH(d.status));
      break;

    case 'status':
      if (isVisible) {
        sbShow(t('status.generating'));
        setStatus(`CLI · ${d.mode || ''} · ${d.model || ''}`, 'warn');
        setSendStop(true);
      }
      if (found?.tab) { found.tab.generating = true; found.tab.done = false; }
      if (isCurrent) renderTabs(); else renderProjects(); // background: show busy dot on project
      if (tabId === activeTabId) { isGen = true; generatingTabId = tabId; }
      break;

    case 'done':
      if (isVisible) {
        if (curEl && curTxt) { curEl.querySelector('.msg').innerHTML = renderMd(curTxt); }
        markDone(curEl);
        curEl = null; curTxt = '';
        if (d.taskId) {
          // Task worker done — hide status bar, don't touch user chat state
          sbHide();
          setStatus(t('status.connected'), 'ok');
        } else {
          if (activeTabId === generatingTabId) {
            const first = [...msgsEl.querySelectorAll('.mw.user')].find(m => !m.querySelector('.msg-ack'));
            if (first) { const a = document.createElement('div'); a.className = 'msg-ack'; a.textContent = '✓'; first.appendChild(a); }
          }
          isGen = false;
          setSendStop(false);
          setStatus(t('status.connected'), 'ok');
        }
      }
      if (found?.tab) { found.tab.generating = false; found.tab.done = true; }
      if (isCurrent) { renderTabs(); if (tabId === activeTabId && !d.taskId) generatingTabId = null; }
      else renderProjects(); // background: remove busy dot from project
      loadHist();
      if (tabId === activeTabId) updateSessBar();
      break;

    case 'files_changed':
      loadFiles();
      break;

    case 'error':
      if (isVisible) {
        rmStatus();
        sbHide();
        if (curEl) {
          const s = curEl.querySelector('.msg-spinner'); if (s) s.remove();
          curEl.querySelector('.msg').innerHTML += `<br><span style="color:var(--red)">${escH(d.error)}</span>`;
        }
        else {
          const em = addMsg('assistant'); em.querySelector('.msg').innerHTML = `<span style="color:var(--red)">${escH(d.error)}</span>`;
        }
        isGen = false;
        setSendStop(false);
        setStatus(t('status.error'), 'err');
        toast(d.error, true, 5000);
      }
      if (found?.tab) { found.tab.generating = false; }
      if (isCurrent) { renderTabs(); if (tabId === activeTabId) generatingTabId = null; }
      else renderProjects();
      break;

    case 'session_started':
      {
        const srcId = d.tabId || generatingTabId || activeTabId;
        // Search across all projects, not just current
        const sf = findTabAcrossProjects(srcId) || (openTabs.find(x => x.id === srcId) ? { tab: openTabs.find(x => x.id === srcId), tabs: openTabs, isCurrent: true } : null);
        const tab = sf?.tab;
        if (tab?.isNew) {
          const oldId = tab.id;
          tab.id = d.sessionId; tab.isNew = false;
          // Move tabState from temp id to real id
          if (tabState[oldId]) { tabState[d.sessionId] = tabState[oldId]; delete tabState[oldId]; }
          if (generatingTabId === oldId) generatingTabId = d.sessionId;
          if (activeTabId === oldId) activeTabId = d.sessionId;
          // Update projectActiveTab if this was a background project's active tab
          if (!sf.isCurrent && sf.projId && projectActiveTab[sf.projId] === oldId) {
            projectActiveTab[sf.projId] = d.sessionId;
          }
          if (sf.isCurrent) renderTabs();
          saveUIState();
        }
      }
      if (activeTabId === d.sessionId || (!d.tabId && generatingTabId === d.sessionId)) {
        currentSessionId = d.sessionId;
      }
      break;

    case 'session_title':
      {
        const titleTabId = d.tabId || generatingTabId || activeTabId;
        const tf = findTabAcrossProjects(titleTabId);
        if (tf?.tab && d.title) {
          tf.tab.title = d.title;
          if (tf.isCurrent) renderTabs();
          saveUIState();
        }
      }
      loadHist();
      updateSessBar();
      break;

    case 'queued':
      break;

    case 'queue_update':
      if (Array.isArray(d.items)) {
        const stillQueued = new Set(d.items.map(i => i.queueId).filter(Boolean));
        msgsEl.querySelectorAll('.mw[data-queue-id]').forEach(el => {
          if (!stillQueued.has(el.dataset.queueId)) {
            const q = el.querySelector('.msg-queued');
            if (q) q.remove();
            delete el.dataset.queueId;
          }
        });
      }
      break;

    case 'queue_removed':
      {
        const el = msgsEl.querySelector(`.mw[data-queue-id="${CSS.escape(d.queueId)}"]`);
        if (el) { el.style.transition = 'opacity .2s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 200); }
      }
      break;

    case 'queue_edited':
      break;

    case 'queue_start':
      { const q = msgsEl.querySelector('.msg-queued'); if (q) q.remove(); }
      if (isVisible) {
        isGen = true;
        showStatus(t('status.processing'));
        setStatus(t('status.processing'), 'warn');
        setSendStop(true);
      }
      break;

    case 'session_reset':
      msgsEl.innerHTML = '';
      _allMsgs = []; _shownFrom = 0;
      showW();
      currentSessionId = null;
      break;

    case 'task_resumed':
      toast('🔄 ' + t('toast.task_resumed'));
      // Re-show generating state for this tab
      { const tr = openTabs.find(x => x.id === tabId); if (tr) { tr.generating = true; renderTabs(); } }
      if (isVisible) { isGen = true; generatingTabId = tabId; setSendStop(true); }
      break;

    case 'task_lost': {
      const tl = openTabs.find(x => x.id === tabId);
      if (tl) { tl.generating = false; renderTabs(); saveUIState(); }
      if (isVisible) { isGen = false; setSendStop(false); setStatus(t('status.connected'), 'ok'); }
      toast(t('toast.task_lost'), true, 4000);
      break;
    }

    case 'task_interrupted': {
      const ti = openTabs.find(x => x.id === tabId);
      if (ti) { ti.generating = false; renderTabs(); saveUIState(); }
      if (isVisible) { isGen = false; setSendStop(false); setStatus(t('status.connected'), 'ok'); }
      if (isVisible && d.prompt) {
        const retryEl = document.createElement('div');
        retryEl.className = 'msg-retry';
        const safePrompt = (d.prompt || '').replace(/'/g, "\\'").substring(0, 500);
        retryEl.innerHTML = `<span>⚠️ ${escH(t('toast.task_interrupted'))}</span><button onclick="retryCrashedTask('${escH(d.sessionId || tabId)}', '${safePrompt}', this)">${escH(t('toast.task_retry'))}</button>`;
        $i('messages')?.appendChild(retryEl);
        scrollBottom();
      }
      break;
    }
  }
}

// ─── UI helpers ───────────────────────────────────────────────────────────
function setStatus(text, cls) {
  const el = $i('statusEl');
  el.textContent = text;
  el.className = `status-dot ${cls}`;
}

function setSendStop(generating) {
  const stopBtn = $i('stopBtn');
  if (generating) {
    stopBtn.classList.remove('hidden');
  } else {
    stopBtn.classList.add('hidden');
  }
}

function updateQueueBadge(n) {
  const b = $i('queueBadge');
  if (!b) return;
  if (n > 0) { b.textContent = n + ' у черзі'; b.classList.add('visible'); }
  else { b.classList.remove('visible'); }
}

function confirmStop() {
  const modal = $i('confirmStopModal');
  modal.classList.remove('hidden');
  setTimeout(() => $i('confirmStopBtn').focus(), 50);
}
function cancelStop() {
  $i('confirmStopModal').classList.add('hidden');
}
function doStop() {
  cancelStop();
  // Immediately reset client-side generating state (don't wait for server 'done')
  const activeTab = openTabs.find(t => t.id === activeTabId);
  if (activeTab) { activeTab.generating = false; renderTabs(); }
  if (activeTabId && tabState[activeTabId]) {
    tabState[activeTabId].generating = false;
    tabState[activeTabId].curEl = null;
    tabState[activeTabId].curTxt = '';
  }
  setSendStop(false);
  setStatus(t('status.stopped'), 'ok');
  rmStatus();
  if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'stop', tabId: activeTabId }));
}
function stopAgent() { confirmStop(); }

function addAgentBadge(el, agent) {
  if (el.querySelector('.ab')) return;
  const b = document.createElement('span');
  b.className = 'ab';
  b.style.cssText = 'position:absolute;top:-9px;left:10px;font-size:8px';
  b.textContent = agent;
  el.style.position = 'relative';
  el.style.marginTop = '10px';
  el.appendChild(b);
}

function addMsg(role, opts = {}) {
  rmW();
  const w = document.createElement('div');
  w.className = `mw ${role}`;
  if (opts.msgId) w.dataset.msgId = String(opts.msgId);
  let quoteHtml = '';
  if (opts.replyQuote) {
    const roleName = opts.replyQuote.quotedRole === 'user' ? t('you.label') : 'Claude';
    const preview = escH((opts.replyQuote.quotedContent || '').slice(0, 120) + (opts.replyQuote.quotedContent?.length > 120 ? '…' : ''));
    quoteHtml = `<div class="msg-reply-quote"><span class="rq-role">${escH(roleName)}</span><span class="rq-text">${preview}</span></div>`;
  }
  w.innerHTML = `${quoteHtml}<div class="msg"></div><button class="cpb" onclick="cpMsg(this)" title="${t('copy.msg')}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button><button class="reply-btn" onclick="setReply(this)" title="${t('msg.reply')}">↩</button>`;
  msgsEl.appendChild(w);
  scrollBottom();
  return w;
}

function addEl(cls) {
  const d = document.createElement('div');
  d.className = cls;
  msgsEl.appendChild(d);
  return d;
}

function rmW() { const w = msgsEl.querySelector('.welcome'); if (w) w.remove(); }
function showW() {
  msgsEl.innerHTML = `<div class="welcome"><div class="wi">CC</div><h2>Claude Code Chat</h2><p>${t('welcome.desc')}</p><div class="welcome-prompts"><div class="wp-card" onclick="setPrompt(this)">&#x1F4A1; ${t('welcome.prompt.1')}</div><div class="wp-card" onclick="setPrompt(this)">&#x1F41B; ${t('welcome.prompt.2')}</div><div class="wp-card" onclick="setPrompt(this)">&#x2728; ${t('welcome.prompt.3')}</div><div class="wp-card" onclick="setPrompt(this)">&#x1F3D7;&#xFE0F; ${t('welcome.prompt.4')}</div></div></div>`;
}

function showStatus(txt) {
  let el = msgsEl.querySelector('.agent-status');
  if (!el) { rmW(); el = addEl('agent-status'); el.innerHTML = '<span class="asdot"></span><span class="astxt"></span>'; scrollBottom(); }
  el.querySelector('.astxt').textContent = txt;
}
function rmStatus() { const el = msgsEl.querySelector('.agent-status'); if (el) el.remove(); }

// ─── Sticky status bar helpers ───
function sbShow(txt) {
  $i('sbTxt').textContent = txt;
  $i('statusBar').classList.add('sb-active');
}
function sbHide() {
  const bar = $i('statusBar');
  bar.classList.remove('sb-active');
  setTimeout(() => { if (!bar.classList.contains('sb-active')) $i('sbTxt').textContent = ''; }, 250);
}

function addSpinner(el) {
  if (!el || el.querySelector('.msg-spinner')) return;
  const s = document.createElement('div'); s.className = 'msg-spinner';
  el.appendChild(s);
}
function markDone(el) {
  rmStatus();
  sbHide();
  if (!el) return;
  const s = el.querySelector('.msg-spinner'); if (s) s.remove();
  if (!el.querySelector('.msg-done')) {
    const d = document.createElement('div'); d.className = 'msg-done'; d.textContent = '✓';
    el.appendChild(d);
  }
}

// Smart scroll: don't scroll if user scrolled up
function scrollBottom() {
  if (!userScrolled) msgsEl.scrollTop = msgsEl.scrollHeight;
}
function scrollToBottom() {
  userScrolled = false;
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

function setPrompt(el) {
  const txt = el.textContent.replace(/^[^\s]+\s/, ''); // strip emoji
  const inp = $i('input');
  if (inp) { inp.value = txt; inp.focus(); inp.style.height = 'auto'; inp.style.height = Math.min(inp.scrollHeight, 120) + 'px'; }
}

const _scrollBtn = document.getElementById('scrollBtn');
msgsEl.addEventListener('scroll', () => {
  const fromBottom = msgsEl.scrollHeight - msgsEl.scrollTop - msgsEl.clientHeight;
  userScrolled = fromBottom > 60;
  if (_scrollBtn) {
    if (fromBottom > 300) _scrollBtn.classList.add('visible');
    else _scrollBtn.classList.remove('visible');
  }
});

function cpMsg(b) {
  const t = b.parentElement.querySelector('.msg').textContent;
  navigator.clipboard.writeText(t).then(() => {
    b.innerHTML = '✓';
    b.classList.add('ok');
    setTimeout(() => { b.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>'; b.classList.remove('ok'); }, 1500);
  });
}

function setReply(btn) {
  const mw = btn.closest('.mw');
  const id = mw.dataset.msgId || null;
  const role = mw.classList.contains('user') ? 'user' : 'assistant';
  const content = mw.querySelector('.msg').textContent.trim();
  replyTo = { id, role, content };
  $i('replyPreviewRole').textContent = role === 'user' ? 'Ви' : 'Claude';
  $i('replyPreviewText').textContent = content.slice(0, 120) + (content.length > 120 ? '…' : '');
  $i('replyPreview').style.display = 'flex';
  inEl.focus();
}

function clearReply() {
  replyTo = null;
  $i('replyPreview').style.display = 'none';
}

// ─── Tabs ─────────────────────────────────────────────────────────────────
function renderTabs() {
  const bar = $i('tabsBar'); if (!bar) return;
  bar.innerHTML = '';
  for (const tab of openTabs) {
    const el = document.createElement('div');
    el.className = 'tab' + (tab.id === activeTabId ? ' active' : '');
    el.onclick = () => switchTab(tab.id);
    let dot = '';
    if (tab.generating) dot = '<div class="tab-dot spinning"></div>';
    else if (tab.done) dot = '<div class="tab-dot done"></div>';
    const titleTip = escH(tab.title || t('tab.new'));
    el.innerHTML = `${dot}<span class="tab-title" data-tip="${titleTip}" ondblclick="event.stopPropagation();startRenameTab(event,'${tab.id}')">${escH(tab.title || t('tab.new'))}</span><button class="tab-close" onclick="event.stopPropagation();closeTab('${tab.id}')">✕</button>`;
    bar.appendChild(el);
  }
  const nb = document.createElement('button');
  nb.className = 'tab-new'; nb.title = t('tab.new'); nb.textContent = '+';
  nb.onclick = newTab;
  bar.appendChild(nb);
  updateHistSpinners();
}

function updateHistSpinners() {
  const el = $i('histList');
  if (!el) return;
  el.querySelectorAll('.hist-item[data-sess]').forEach(item => {
    const tab = openTabs.find(t => t.id === item.dataset.sess);
    let spinner = item.querySelector('.hist-spin');
    if (tab?.generating) {
      if (!spinner) {
        spinner = document.createElement('span');
        spinner.className = 'hist-spin tab-dot spinning';
        item.insertBefore(spinner, item.firstChild);
      }
    } else {
      if (spinner) spinner.remove();
    }
  });
}

function startRenameTab(e, tabId) {
  const span = e.currentTarget;
  const tab = openTabs.find(t => t.id === tabId);
  if (!tab || tab.isNew) return;
  const origTitle = tab.title || '';
  const inp = document.createElement('input');
  inp.className = 'tab-rename-input';
  inp.value = origTitle;
  span.replaceWith(inp);
  inp.focus(); inp.select();
  let saved = false;
  const save = () => {
    if (saved) return; saved = true;
    const newTitle = inp.value.trim() || origTitle;
    saveTabRename(tabId, newTitle);
  };
  inp.addEventListener('keydown', ev => {
    if (ev.key === 'Enter') { ev.preventDefault(); save(); }
    if (ev.key === 'Escape') { saved = true; renderTabs(); }
  });
  inp.addEventListener('blur', save);
}

async function saveTabRename(tabId, newTitle) {
  const tab = openTabs.find(t => t.id === tabId);
  if (!tab) return;
  tab.title = newTitle;
  renderTabs(); loadHist();
  if (!tab.isNew) {
    try { await fetch(`/api/sessions/${tabId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title: newTitle }) }); } catch {}
  }
}

function openTab(id, title) {
  if (!openTabs.find(t => t.id === id))
    openTabs.push({ id, title: title || t('tab.new'), generating: false, done: false });
  switchTab(id);
}

// ─── Session info bar ─────────────────────────────────────────────────────
async function updateSessBar() {
  const bar = $i('sessBar');
  if (!bar) return;
  if (!activeTabId) { bar.style.display = 'none'; return; }
  const _tab = openTabs.find(t => t.id === activeTabId);
  if (!_tab || _tab.isNew) { bar.style.display = 'none'; return; }
  try {
    const resp = await fetch(`/api/sessions/${activeTabId}`);
    if (!resp.ok) { bar.style.display = 'none'; return; }
    const s = await resp.json();
    bar.style.display = 'flex';
    const titleEl = $i('sessBarTitle');
    if (titleEl) titleEl.textContent = s.title || '';
    const idEl = $i('sessBarId');
    if (idEl) {
      const cid = s.claude_session_id || '';
      idEl.textContent = cid ? cid.slice(0, 8) + '…' : '—';
      idEl.dataset.fullId = cid;
      idEl.title = cid || t('session.copy_id');
    }
    const openBtn = $i('sessOpenBtn');
    if (openBtn) openBtn.style.display = s.claude_session_id ? '' : 'none';
  } catch { if (bar) bar.style.display = 'none'; }
}

function copySessId() {
  const id = $i('sessBarId')?.dataset.fullId;
  if (!id) return;
  navigator.clipboard.writeText(id).then(() => toast(t('toast.link_copied')));
}

async function openInClaude() {
  if (!activeTabId) return;
  try {
    const resp = await fetch(`/api/sessions/${activeTabId}/open-terminal`, { method: 'POST' });
    const d = await resp.json();
    if (d.ok) {
      toast('⚡ Claude Code launched');
    } else if (d.command) {
      // macOS not available — copy command to clipboard
      navigator.clipboard.writeText(d.command).then(() => toast('📋 ' + d.command));
    }
  } catch { toast(t('toast.err_prefix') + 'open-terminal failed', true); }
}

function retryCrashedTask(sessionId, prompt, btn) {
  btn.closest('.msg-retry')?.remove();
  if (sessionId !== activeTabId) switchTab(sessionId);
  inEl.value = prompt;
  inEl.dispatchEvent(new Event('input'));
  doSend();
}

function switchTab(id) {
  if (activeTabId === id) return;
  // Save state for current tab before switching
  if (activeTabId) {
    getTS(activeTabId).draft = inEl.value;
    getTS(activeTabId).curTxt = curTxt;
  }
  // Reset streaming state — loadSess will clear msgsEl, making curEl stale
  curEl = null; curTxt = '';
  activeTabId = id;
  const tab = openTabs.find(t => t.id === id);
  if (tab?.isNew) {
    currentSessionId = null;
    msgsEl.innerHTML = ''; showW(); renderProjects();
  } else {
    loadSess(id);
  }
  // Restore textarea draft for new tab
  const draft = getTS(id).draft || '';
  inEl.value = draft;
  inEl.style.height = 'auto';
  inEl.style.height = Math.min(inEl.scrollHeight, 130) + 'px';
  // Update stop button state for new tab
  const newTab = openTabs.find(t => t.id === id);
  if (newTab?.generating) {
    setSendStop(true);
    setStatus(t('status.processing'), 'warn');
    sbShow(t('status.generating'));
  } else {
    setSendStop(false);
    sbHide();
  }
  renderTabs(); saveUIState();
  updateSessBar();
}

function closeTab(id) {
  if (isGen && activeTabId === id) { isGen = false; setSendStop(false); generatingTabId = null; curEl = null; }
  const idx = openTabs.findIndex(t => t.id === id);
  if (idx === -1) return;
  openTabs.splice(idx, 1);
  delete tabState[id];
  if (activeTabId === id) {
    if (openTabs.length > 0) {
      const next = openTabs[Math.min(idx, openTabs.length - 1)];
      activeTabId = next.id;
      if (next.isNew) { currentSessionId = null; msgsEl.innerHTML = ''; showW(); renderProjects(); }
      else loadSess(next.id);
    } else {
      activeTabId = null; currentSessionId = null;
      msgsEl.innerHTML = ''; showW(); renderProjects();
    }
  }
  renderTabs(); saveUIState();
}

function newTab() {
  const tempId = 'new-' + Date.now();
  if (!curProjectId) { _onProjectCreated = () => newTab(); openAddProject(); return; }
  // Save current tab's draft before switching
  if (activeTabId) getTS(activeTabId).draft = inEl.value;
  openTabs.push({ id: tempId, title: t('tab.new'), generating: false, done: false, isNew: true });
  activeTabId = tempId;
  currentSessionId = null;
  inEl.value = '';
  inEl.style.height = 'auto';
  msgsEl.innerHTML = ''; showW(); renderProjects(); loadHist();
  userScrolled = false; renderTabs(); saveUIState(); updateSessBar();
}

function toggle(id) {
  const el = $i(id);
  el.classList.toggle('collapsed');
  const btn = document.querySelector(`[onclick="toggle('${id}')"]`);
  if (btn) btn.classList.toggle('active', !el.classList.contains('collapsed'));
  // Mobile backdrop
  if (window.innerWidth <= 800) {
    const isOpen = !el.classList.contains('collapsed');
    let bd = $i('mobileBackdrop');
    if (!bd) {
      bd = document.createElement('div');
      bd.id = 'mobileBackdrop';
      document.body.appendChild(bd);
    }
    const anyOpen = !$i('leftPanel')?.classList.contains('collapsed') || !$i('rightPanel')?.classList.contains('collapsed');
    bd.style.display = anyOpen ? 'block' : 'none';
    bd.onclick = () => {
      if (!$i('leftPanel')?.classList.contains('collapsed')) toggle('leftPanel');
      if (!$i('rightPanel')?.classList.contains('collapsed')) toggle('rightPanel');
    };
  }
  saveUIState();
}
function toggleSec(id) {
  const body = $i(id + 'Body');
  body.classList.toggle('collapsed');
  const title = body.previousElementSibling;
  if (title) title.setAttribute('aria-expanded', String(!body.classList.contains('collapsed')));
  saveUIState();
}

// ─── Toolbar ─────────────────────────────────────────────────────────────
function setOpt(btn, group) {
  btn.closest('.tb-group').querySelectorAll('.tb-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  const v = btn.dataset.v;
  if (group === 'mode') curMode = v;
  else if (group === 'agent') curAgent = v;
  else if (group === 'model') curModel = v;
  updInd();
}

function updInd() {
  const mc = { auto: 'dot-auto', planning: 'dot-plan', task: 'dot-task' };
  const ml = { auto: 'Auto', planning: 'Plan', task: 'Task' };
  const al = { single: 'Single', multi: 'Multi' };
  const mo = { haiku: 'Haiku', sonnet: 'Sonnet', opus: 'Opus' };
  $i('modeInd').innerHTML = `<span class="dot ${mc[curMode]}"></span> ${ml[curMode]} · ${al[curAgent]} · ${mo[curModel]}`;
}

function syncBtn(group, val) {
  const groups = { mode: ['auto','planning','task'], agent: ['single','multi'], model: ['haiku','sonnet','opus'] };
  if (!groups[group]?.includes(val)) return;
  document.querySelectorAll('.tb-group .tb-btn').forEach(b => {
    if (b.dataset.v === val) {
      b.closest('.tb-group').querySelectorAll('.tb-btn').forEach(x => x.classList.remove('on'));
      b.classList.add('on');
    }
  });
}

// ─── Attachments (@ files + clipboard screenshots) ───────────────────────
let _attachments = []; // [{id, type:'file'|'image', name, relPath, absPath, projectDir, base64, mimeType}]

function _getChips() { return $i('attChips'); }

function _addFileChip(file) {
  if (_attachments.find(a => a.type === 'file' && a.absPath === file.absPath)) return;
  const id = 'att-' + Date.now() + Math.random().toString(36).slice(2, 6);
  _attachments.push({ id, type: 'file', name: file.name, relPath: file.relPath, absPath: file.absPath, projectDir: curWorkdir });
  const chip = document.createElement('div');
  chip.className = 'att-chip'; chip.dataset.attId = id;
  chip.innerHTML = `<span class="chip-icon">📄</span><span class="chip-name" data-tip="${escH(file.relPath)}">${escH(file.name)}</span><button class="chip-rm" onclick="rmChip('${id}')" title="${t('chip.remove')}">✕</button>`;
  _getChips().appendChild(chip);
}

function _addImageChip(base64, mimeType, name) {
  const id = 'att-' + Date.now() + Math.random().toString(36).slice(2, 6);
  _attachments.push({ id, type: 'image', name: name || 'screenshot.png', base64, mimeType });
  const chip = document.createElement('div');
  chip.className = 'att-chip chip-img'; chip.dataset.attId = id;
  chip.innerHTML = `<img src="data:${mimeType};base64,${base64}" alt=""><span class="chip-name">${escH(name || 'screenshot.png')}</span><button class="chip-rm" onclick="rmChip('${id}')" title="${t('chip.remove')}">✕</button>`;
  _getChips().appendChild(chip);
}

function _addLocalFileChip(name, base64, mimeType) {
  const id = 'att-' + Date.now() + Math.random().toString(36).slice(2, 6);
  _attachments.push({ id, type: 'file', name, base64, mimeType: mimeType || 'application/octet-stream', local: true });
  const chip = document.createElement('div');
  chip.className = 'att-chip'; chip.dataset.attId = id;
  chip.innerHTML = `<span class="chip-icon">📎</span><span class="chip-name" title="${escH(name)}">${escH(name)}</span><button class="chip-rm" onclick="rmChip('${id}')" title="${t('chip.remove')}">✕</button>`;
  _getChips().appendChild(chip);
}

function onFilePicker(input) {
  const files = Array.from(input.files);
  input.value = ''; // reset so same file can be re-selected
  for (const file of files) {
    const reader = new FileReader();
    if (file.type.startsWith('image/')) {
      reader.onload = ev => {
        const base64 = ev.target.result.split(',')[1];
        _addImageChip(base64, file.type, file.name);
      };
      reader.readAsDataURL(file);
    } else {
      reader.onload = ev => {
        const base64 = ev.target.result.split(',')[1];
        _addLocalFileChip(file.name, base64, file.type || 'text/plain');
      };
      reader.readAsDataURL(file);
    }
  }
}

function rmChip(id) {
  _attachments = _attachments.filter(a => a.id !== id);
  const el = document.querySelector(`[data-att-id="${id}"]`);
  if (el) el.remove();
}

function _clearAttachments() {
  _attachments = [];
  _getChips().innerHTML = '';
}

// ─── @ File picker ────────────────────────────────────────────────────────
let _atTimer = null, _atFiles = [], _atActiveIdx = -1, _atMode = false;

function _openAtPopup(query) {
  const popup = $i('atPopup'), s = $i('atSearch');
  popup.classList.remove('hidden');
  s.value = query;
  _atActiveIdx = -1;
  _atMode = true;
  _fetchAtFiles(query);
}

function _closeAtPopup() {
  $i('atPopup').classList.add('hidden');
  _atMode = false; _atFiles = []; _atActiveIdx = -1;
}

async function _fetchAtFiles(query) {
  if (!curWorkdir) {
    $i('atList').innerHTML = `<div class="at-empty">${t('at.no_project')}</div>`;
    return;
  }
  $i('atList').innerHTML = `<div class="at-loading">${t('at.searching')}</div>`;
  try {
    const r = await fetch(`/api/project-files?dir=${encodeURIComponent(curWorkdir)}&q=${encodeURIComponent(query)}`);
    const d = await r.json();
    _atFiles = d.files || [];
    _renderAtList();
  } catch { $i('atList').innerHTML = `<div class="at-empty">${t('at.search_err')}</div>`; }
}

function _renderAtList() {
  const list = $i('atList');
  if (!_atFiles.length) { list.innerHTML = `<div class="at-empty">${t('at.no_files')}</div>`; return; }
  list.innerHTML = _atFiles.slice(0, 60).map((f, i) => {
    const slashIdx = f.relPath.lastIndexOf('/');
    const dir = slashIdx > 0 ? f.relPath.slice(0, slashIdx) : '.';
    return `
    <div class="at-item${i === _atActiveIdx ? ' active' : ''}" onclick="selectAtFile(${i})">
      <span class="at-icon">📄</span>
      <div class="at-info">
        <span class="at-name">${escH(f.name)}</span>
        <span class="at-dir">${escH(dir)}</span>
      </div>
    </div>`;
  }).join('');
}

function selectAtFile(idx) {
  const f = _atFiles[idx]; if (!f) return;
  _addFileChip(f);
  // Remove @query from textarea
  const val = inEl.value, cur = inEl.selectionStart;
  const before = val.slice(0, cur), atIdx = before.lastIndexOf('@');
  if (atIdx >= 0) {
    inEl.value = val.slice(0, atIdx) + val.slice(cur);
    inEl.selectionStart = inEl.selectionEnd = atIdx;
  }
  _closeAtPopup(); inEl.focus();
}

function onAtSearch(query) {
  clearTimeout(_atTimer);
  _atTimer = setTimeout(() => _fetchAtFiles(query), 180);
}

// Input: watch for @ trigger
inEl.addEventListener('input', () => {
  const val = inEl.value, cur = inEl.selectionStart;
  const before = val.slice(0, cur);
  const atIdx = before.lastIndexOf('@');
  if (atIdx >= 0) {
    const afterAt = before.slice(atIdx + 1);
    if (!afterAt.includes(' ') && !afterAt.includes('\n')) {
      _openAtPopup(afterAt); return;
    }
  }
  if (!$i('atPopup').classList.contains('hidden')) _closeAtPopup();
});

// Keyboard navigation inside @ popup
inEl.addEventListener('keydown', e => {
  if ($i('atPopup').classList.contains('hidden')) return;
  if (e.key === 'Escape') { _closeAtPopup(); e.preventDefault(); return; }
  if (e.key === 'ArrowDown') { e.preventDefault(); _atActiveIdx = Math.min(_atActiveIdx + 1, _atFiles.length - 1); _renderAtList(); $i('atList').querySelector('.active')?.scrollIntoView({ block: 'nearest' }); return; }
  if (e.key === 'ArrowUp') { e.preventDefault(); _atActiveIdx = Math.max(_atActiveIdx - 1, -1); _renderAtList(); return; }
  if ((e.key === 'Enter' || e.key === 'Tab') && _atActiveIdx >= 0) { e.preventDefault(); selectAtFile(_atActiveIdx); return; }
});

// Close popup on click outside
document.addEventListener('click', e => {
  const popup = $i('atPopup');
  if (popup && !popup.classList.contains('hidden') && !popup.contains(e.target) && e.target !== inEl) _closeAtPopup();
});

// ─── Clipboard paste (screenshots) ───────────────────────────────────────
inEl.addEventListener('paste', e => {
  const items = e.clipboardData?.items;
  if (!items) return;
  for (const item of items) {
    if (!item.type.startsWith('image/')) continue;
    e.preventDefault();
    const blob = item.getAsFile(); if (!blob) continue;
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      const base64 = dataUrl.split(',')[1];
      const ts = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
      _addImageChip(base64, item.type, `screenshot-${ts}.png`);
    };
    reader.readAsDataURL(blob);
    break;
  }
});

// ─── Send / Stop ─────────────────────────────────────────────────────────
async function send() {
  if (!ws || ws.readyState !== 1) { toast(t('toast.no_connection'), true); return; }

  const txt = inEl.value.trim();
  if (!txt && !_attachments.length) return;

  // Require a project before sending the first message in a new session
  if (!curProjectId && !currentSessionId) {
    _onProjectCreated = () => send();
    openAddProject();
    return;
  }

  // Collect attachment payloads (fetch file contents for @ mentions)
  const attSnapshot = [..._attachments];
  _clearAttachments();
  _closeAtPopup();

  const msgAttachments = [];
  for (const att of attSnapshot) {
    if (att.type === 'image') {
      msgAttachments.push({ type: att.mimeType, base64: att.base64, name: att.name });
    } else if (att.type === 'file') {
      if (att.local && att.base64) {
        // Local file picked via file dialog — content already read client-side
        msgAttachments.push({ type: att.mimeType || 'text/plain', name: att.name, base64: att.base64 });
      } else {
        try {
          const r = await fetch(`/api/project-files/read?path=${encodeURIComponent(att.absPath)}&dir=${encodeURIComponent(att.projectDir)}`);
          const d = await r.json();
          if (d.content !== undefined) msgAttachments.push({ type: 'text/plain', name: att.relPath || att.name, base64: btoa(unescape(encodeURIComponent(d.content))) });
        } catch { toast(t('toast.read_err') + att.name, true); }
      }
    }
  }

  const msgEl = addMsg('user');
  // Show file/image chips in message bubble
  if (attSnapshot.length) {
    const chipsDiv = document.createElement('div');
    chipsDiv.className = 'att-chips';
    chipsDiv.style.cssText = 'padding:4px 0 2px';
    chipsDiv.innerHTML = attSnapshot.map(a => a.type === 'image'
      ? `<div class="att-chip chip-img"><img src="data:${a.mimeType};base64,${a.base64}" alt=""><span class="chip-name">${escH(a.name)}</span></div>`
      : `<div class="att-chip"><span class="chip-icon">📄</span><span class="chip-name">${escH(a.relPath || a.name)}</span></div>`
    ).join('');
    msgEl.querySelector('.msg').before(chipsDiv);
  }
  if (txt) msgEl.querySelector('.msg').textContent = txt;

  inEl.value = '';
  inEl.style.height = 'auto';
  userScrolled = false;

  const queueId = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2));

  const activeTab = openTabs.find(t => t.id === activeTabId);
  const tabIsGenerating = activeTab?.generating || false;

  if (tabIsGenerating) {
    msgEl.dataset.queueId = queueId;
    const q = document.createElement('div');
    q.className = 'msg-queued';
    q.innerHTML = `<span class="mq-label">${t('queue.label')}</span><button class="qd-btn qd-edit" onclick="editQueuedMsg(this)" title="${t('queue.edit.title')}">✏</button><button class="qd-btn qd-del" onclick="deleteQueuedMsg(this)" title="${t('queue.del.title')}">✕</button>`;
    msgEl.appendChild(q);
  } else {
    // Auto-create a tab if project is active but no tab is open
    if (!activeTabId && curProjectId) {
      const tempId = 'new-' + Date.now();
      openTabs.push({ id: tempId, title: t('tab.new'), generating: false, done: false, isNew: true });
      activeTabId = tempId;
      currentSessionId = null;
      renderTabs();
    }
    isGen = true;
    generatingTabId = activeTabId;
    if (activeTabId) { const at = openTabs.find(x => x.id === activeTabId); if (at) { at.generating = true; renderTabs(); } }
    showStatus(t('status.processing'));
    setStatus(t('status.processing'), 'warn');
    setSendStop(true);
  }

  const currentReply = replyTo;
  clearReply();

  // Auto-skill selection
  if (autoSkillsMode && txt && txt.trim().length > 3) {
    const autoSelected = autoSelectSkills(txt);
    if (autoSelected.length > 0) {
      activeSkills = new Set(autoSelected);
      renderSkills();
      // Filter out the meta-skill from the toast display (it's always included)
      const displaySkills = autoSelected.filter(id => id !== 'auto-mode');
      if (displaySkills.length > 0) {
        const names = displaySkills.map(id => (config.skills[id]?.label || id).replace(/^\S+\s/, '')).join(', ');
        toast('⚡ ' + names);
      }
    } else if (config.skills['auto-mode']) {
      // No specific skill matched — still apply auto-mode meta-skill for quality
      activeSkills = new Set(['auto-mode']);
      renderSkills();
    }
  }

  ws.send(JSON.stringify({
    type: 'chat', text: txt || ' ',
    tabId: activeTabId,
    sessionId: currentSessionId || undefined,
    attachments: msgAttachments.length ? msgAttachments : undefined,
    queueId,
    reply_to: currentReply || undefined,
    skills: [...activeSkills],
    mcpServers: [...activeMcp],
    mode: curMode, agentMode: curAgent,
    model: curModel, engine: curEngine,
    maxTurns: parseInt($i('maxTurns').value) || 30,
    workdir: curWorkdir || undefined,
  }));
}

function newSession() { newTab(); }

// ─── Queue edit / delete ──────────────────────────────────────────────────
function editQueuedMsg(btn) {
  const msgEl = btn.closest('.mw');
  if (!msgEl) return;
  const msgDiv = msgEl.querySelector('.msg');
  if (!msgDiv) return;
  const currentText = msgDiv.textContent;
  msgEl.dataset.originalText = currentText;

  const editor = document.createElement('div');
  editor.className = 'queue-editor';
  editor.innerHTML = `<textarea class="queue-edit-area" onkeydown="queueEditKey(event)">${escH(currentText)}</textarea><div class="queue-edit-btns"><button class="qe-cancel" onclick="cancelQueueEdit(this)">${t('queue.cancel')}</button><button class="qe-save" onclick="saveQueueEdit(this)">${t('queue.save')}</button></div>`;
  msgDiv.replaceWith(editor);

  const ta = editor.querySelector('.queue-edit-area');
  ta.style.height = 'auto';
  ta.style.height = Math.min(ta.scrollHeight, 180) + 'px';
  ta.focus();
  ta.setSelectionRange(ta.value.length, ta.value.length);
}

function queueEditKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    saveQueueEdit(e.target.closest('.queue-editor').querySelector('.qe-save'));
  }
  if (e.key === 'Escape') {
    cancelQueueEdit(e.target.closest('.queue-editor').querySelector('.qe-cancel'));
  }
}

function saveQueueEdit(btn) {
  const msgEl = btn.closest('.mw');
  if (!msgEl) return;
  const editor = btn.closest('.queue-editor');
  const newText = editor.querySelector('.queue-edit-area').value.trim();
  if (!newText) return;

  const queueId = msgEl.dataset.queueId;
  delete msgEl.dataset.originalText;

  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg';
  msgDiv.textContent = newText;
  editor.replaceWith(msgDiv);

  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ type: 'queue_edit', queueId, text: newText }));
  }
}

function cancelQueueEdit(btn) {
  const msgEl = btn.closest('.mw');
  if (!msgEl) return;
  const editor = btn.closest('.queue-editor');
  const originalText = msgEl.dataset.originalText || editor.querySelector('.queue-edit-area').value;
  delete msgEl.dataset.originalText;

  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg';
  msgDiv.textContent = originalText;
  editor.replaceWith(msgDiv);
}

function deleteQueuedMsg(btn) {
  const msgEl = btn.closest('.mw');
  if (!msgEl) return;
  const queueId = msgEl.dataset.queueId;

  // Optimistic UI: fade out and disable
  msgEl.style.opacity = '0.4';
  msgEl.style.pointerEvents = 'none';
  msgEl.style.transition = 'opacity .2s';

  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ type: 'queue_remove', queueId }));
  }
}

// Input auto-resize
inEl.addEventListener('input', () => {
  inEl.style.height = 'auto';
  inEl.style.height = Math.min(inEl.scrollHeight, 120) + 'px';
});
inEl.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    if (!$i('atPopup').classList.contains('hidden')) return; // let @ handler deal with it
    e.preventDefault(); send();
  }
});

// ─── (Stats panel removed) ────────────────────────────────────────────────

function loadStats() { /* removed */ }

// ─── Version check ────────────────────────────────────────────────────────
async function checkVersion() {
  try {
    const local = await fetch('/api/version').then(r => r.json());
    const el = $i('versionBadge');
    if (!el) return;
    const cur = local.version || '?';
    el.textContent = `v${cur}`;
    el.title = 'Поточна версія';
    try {
      const gh = await fetch('https://api.github.com/repos/Lexus2016/claude-code-chat/releases/latest',
        { headers: { Accept: 'application/vnd.github.v3+json' } }).then(r => r.json());
      const latest = (gh.tag_name || '').replace(/^v/, '');
      if (latest && latest !== cur) {
        el.textContent = `v${cur} → v${latest} ↑`;
        el.className = 'update';
        el.title = `Доступне оновлення ${gh.tag_name}!\nЗапустіть: npx github:Lexus2016/claude-code-chat`;
        el.onclick = () => window.open(gh.html_url, '_blank');
      } else if (latest) {
        el.title = `v${cur} — остання версія ✓`;
      }
    } catch { /* GitHub API unavailable, keep local version only */ }
  } catch { /* API not ready */ }
}

// ─── Session History ──────────────────────────────────────────────────────
async function loadHist() {
  try {
    const el = $i('histList');
    if (!curWorkdir) { el.innerHTML = ''; $i('histCount').textContent = ''; return; }
    const r = await fetch(`/api/sessions?workdir=${encodeURIComponent(curWorkdir)}`);
    const ss = await r.json();
    el.innerHTML = '';
    $i('histCount').textContent = ss.length || '';
    for (const s of ss) {
      const d = document.createElement('div');
      d.className = `hist-item ${s.id === currentSessionId ? 'active' : ''}`;
      d.dataset.sess = s.id;
      const dt = new Date(s.updated_at).toLocaleDateString(localStorage.getItem('lang') || 'uk', { day: 'numeric', month: 'short' });
      d.innerHTML = `<span class="ht" data-tip="${escH(s.title)}">${escH(s.title)}</span><span class="hd">${dt}</span><button class="del" onclick="event.stopPropagation();delSess('${s.id}')" title="✕">✕</button>`;
      d.onclick = () => openTab(s.id, s.title);
      el.appendChild(d);
    }
    updateHistSpinners();
  } catch (e) { console.error('loadHist:', e); }
}

// ─── Message pagination ───────────────────────────────────────────────────
const MSG_PAGE = 50;
let _allMsgs = [];   // all messages for current session (in memory)
let _shownFrom = 0;  // index in _allMsgs from which messages are rendered

function _renderMsgAt(idx, prepend = false) {
  const m = _allMsgs[idx];
  const hasReply = _allMsgs.slice(idx + 1).some(x => x.role === 'assistant');
  const w = document.createElement('div');
  w.className = `mw ${m.role}`;
  if (m.id) w.dataset.msgId = String(m.id);
  w.innerHTML = `<div class="msg"></div><button class="cpb" onclick="cpMsg(this)" title="${t('copy.msg')}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button><button class="reply-btn" onclick="setReply(this)" title="${t('msg.reply')}">↩</button>`;
  if (m.role === 'assistant') {
    w.querySelector('.msg').innerHTML = renderMd(m.content);
  } else {
    w.querySelector('.msg').textContent = m.content;
    if (hasReply) { const a = document.createElement('div'); a.className = 'msg-ack'; a.textContent = '✓'; w.appendChild(a); }
  }
  if (m.agent_id) addAgentBadge(w, m.agent_id);
  if (prepend) {
    const firstMsg = msgsEl.querySelector('.mw');
    if (firstMsg) msgsEl.insertBefore(w, firstMsg);
    else msgsEl.prepend(w);
  } else {
    msgsEl.appendChild(w);
  }
  return w;
}

function _updateLoadMoreBtn() {
  let btn = document.getElementById('loadMoreBtn');
  const remaining = _shownFrom; // messages before current visible range
  if (remaining <= 0) {
    if (btn) btn.remove();
    return;
  }
  if (!btn) {
    const wrap = document.createElement('div');
    wrap.id = 'loadMoreBtn';
    wrap.className = 'load-more-wrap';
    wrap.innerHTML = `<button class="load-more-btn" onclick="loadMoreMsgs()">${t('load.more')} (${remaining})</button>`;
    const firstMsg = msgsEl.querySelector('.mw');
    if (firstMsg) msgsEl.insertBefore(wrap, firstMsg);
    else msgsEl.prepend(wrap);
  } else {
    btn.querySelector('button').textContent = `${t('load.more')} (${remaining})`;
  }
}

function loadMoreMsgs() {
  if (_shownFrom <= 0) return;
  const prevHeight = msgsEl.scrollHeight;
  const prevScroll = msgsEl.scrollTop;
  const start = Math.max(0, _shownFrom - MSG_PAGE);
  const end = _shownFrom;
  // Prepend in reverse order so DOM order stays chronological
  for (let i = end - 1; i >= start; i--) {
    _renderMsgAt(i, true);
  }
  _shownFrom = start;
  _updateLoadMoreBtn();
  // Maintain scroll position after prepend
  requestAnimationFrame(() => {
    msgsEl.scrollTop = prevScroll + (msgsEl.scrollHeight - prevHeight);
  });
}

async function loadSess(id) {
  try {
    const r = await fetch(`/api/sessions/${id}`);
    if (!r.ok) { closeTab(id); toast(t('toast.sess_not_found'), true); return; }
    const d = await r.json();
    msgsEl.innerHTML = '';
    currentSessionId = id;
    // Sync tab title
    { const t = openTabs.find(x => x.id === id); if (t && d.title) { t.title = d.title; renderTabs(); } }

    if (d.mode) { curMode = d.mode; syncBtn('mode', d.mode); }
    if (d.agent_mode) { curAgent = d.agent_mode; syncBtn('agent', d.agent_mode); }
    if (d.model) { curModel = d.model; syncBtn('model', d.model); }
    updInd();

    curWorkdir = d.workdir || null;
    curProjectId = curWorkdir ? (projects.find(p => p.workdir === curWorkdir)?.id || null) : null;
    renderProjects();

    try { activeMcp = new Set(JSON.parse(d.active_mcp || '[]')); } catch { activeMcp = new Set(); }
    try { activeSkills = new Set(JSON.parse(d.active_skills || '[]')); } catch { activeSkills = new Set(); }
    renderMcp(); renderSkills();

    _allMsgs = (d.messages || []).filter(m => m.type !== 'tool');
    _shownFrom = Math.max(0, _allMsgs.length - MSG_PAGE);

    for (let i = _shownFrom; i < _allMsgs.length; i++) {
      _renderMsgAt(i, false);
    }
    _updateLoadMoreBtn();

    userScrolled = false;
    scrollBottom();
  
    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type: 'start_session', sessionId: id, mode: curMode, agentMode: curAgent, model: curModel, engine: 'cli'}));
      ws.send(JSON.stringify({ type: 'subscribe_session', sessionId: id }));
    }
    loadHist();
  } catch (e) { console.error('loadSess:', e); toast(t('sess.load.err'), true); }
}

async function delSess(id) {
  if (!confirm(t('sess.delete.confirm'))) return;
  await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
  if (id === currentSessionId) { currentSessionId = null; msgsEl.innerHTML = ''; showW(); }
  loadHist();
}

// ─── MCP & Skills ─────────────────────────────────────────────────────────
async function loadCfg() {
  try {
    const r = await fetch('/api/config');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    config = await r.json();
    renderMcp();
    renderSkills();
  } catch (e) {
    console.error('loadCfg:', e);
    toast(t('toast.cfg_load_err'), true);
  }
}

function mkToggle(on) {
  return `<div class="sw" role="switch" aria-checked="${on}"><div class="sw-track"></div><div class="sw-thumb"></div></div>`;
}

function renderMcp() {
  const el = $i('mcpList'); el.innerHTML = '';
  const tipWarn = t('mcp.cfg.warn'), tipCfg = t('mcp.cfg.tip');
  let c = 0;
  for (const [id, m] of Object.entries(config.mcpServers || {})) {
    const on = activeMcp.has(id);
    if (on) c++;
    const missing = getMcpMissingFields(m);
    const div = document.createElement('div');
    div.className = `ci ${on ? 'on' : ''}`;
    div.title = on ? t('mcp.toggle.on') : t('mcp.toggle.off');
    div.onclick = () => tMcp(id);
    div.innerHTML = `
      ${mkToggle(on)}
      <div class="inf">
        <div class="nm" data-tip="${escH(m.label || id)}">${escH(m.label || id)}</div>
        <div class="ds" data-tip="${escH(m.description || '')}">${escH(m.description || '')}</div>
        <div class="st">${on ? t('mcp.active') : t('mcp.inactive')}</div>
      </div>
      ${missing.length ? `<div class="warn-dot" title="${escH(tipWarn)}"></div>` : ''}
      <button class="cfg" onclick="event.stopPropagation();showMcpSettings('${id}')" title="${escH(tipCfg)}">⚙</button>
      ${m.custom ? `<button class="rm" onclick="event.stopPropagation();rMcp('${id}')" title="${t('mcp.del.title')}">✕</button>` : ''}`;
    el.appendChild(div);
  }
  $i('mcpCount').textContent = c || '';
}

// Returns unconfigured credential fields (placeholder values)
function getMcpMissingFields(m) {
  const PH=/YOUR_[A-Z_]+/;
  const SKIP_ENV=new Set(['ENABLE_TOOL_SEARCH','ENABLE_EXPERIMENTAL_MCP_CLI']);
  const fields=[];
  for(const[k,v]of Object.entries(m.env||{})){if(SKIP_ENV.has(k))continue;if(PH.test(v)||(v===''&&/KEY|TOKEN|SECRET|API/i.test(k)))fields.push({source:'env',key:k,val:v});}
  for(const[k,v]of Object.entries(m.headers||{})){if(PH.test(v))fields.push({source:'headers',key:k,val:v});}
  if(m.url&&PH.test(m.url))fields.push({source:'url',key:'url',val:m.url});
  if(m.args)m.args.forEach((a,i)=>{if(PH.test(a))fields.push({source:'args',key:i,val:a});});
  return fields;
}

function tMcp(id) {
  if (!activeMcp.has(id)) {
    const m=config.mcpServers[id];
    if (m&&getMcpMissingFields(m).length) { showMcpSettings(id,true); return; }
  }
  if (activeMcp.has(id)) activeMcp.delete(id); else activeMcp.add(id);
  renderMcp(); saveUIState();
}
async function rMcp(id) {
  activeMcp.delete(id);
  await fetch(`/api/mcp/${id}`, { method: 'DELETE' });
  delete config.mcpServers[id];
  renderMcp();
}
function showMcpForm() { $i('mcpForm').style.display = 'flex'; }
function hideMcpForm() { $i('mcpForm').style.display = 'none'; }
function updateMcpFormType() {
  const type=$i('mcpType').value, isUrl=type==='sse'||type==='http';
  $i('mcpStdioFields').style.display=isUrl?'none':'flex';
  $i('mcpUrlFields').style.display=isUrl?'flex':'none';
  $i('mcpHeadersArea').style.display=type==='http'?'block':'none';
}

async function addMcp() {
  const id=$i('mcpId').value.trim(), label=$i('mcpLabel').value.trim();
  const type=$i('mcpType').value;
  if (!id) { toast(t('mcp.add.id_req'),true); return; }
  let body={id, label:label||id, type};
  if (type==='sse'||type==='http') {
    const url=$i('mcpUrl').value.trim();
    if (!url) { toast(t('mcp.add.url_req'),true); return; }
    let headers={}; try{headers=JSON.parse($i('mcpHeadersArea').value||'{}')}catch{}
    let env={}; try{env=JSON.parse($i('mcpEnv').value||'{}')}catch{}
    body={...body,url,headers,env};
  } else {
    const command=$i('mcpCmd').value.trim();
    if (!command) { toast(t('mcp.add.cmd_req'),true); return; }
    const args=$i('mcpArgs').value.split(',').map(s=>s.trim()).filter(Boolean);
    let env={}; try{env=JSON.parse($i('mcpEnv').value||'{}')}catch{}
    body={...body,command,args,env};
  }
  await fetch('/api/mcp/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  config.mcpServers[id]={...body,custom:true};
  activeMcp.add(id); renderMcp(); hideMcpForm();
  ['mcpId','mcpLabel','mcpCmd','mcpArgs','mcpEnv','mcpUrl','mcpHeadersArea'].forEach(x=>{const el=$i(x);if(el)el.value='';});
  $i('mcpType').value='stdio'; updateMcpFormType();
  toast(t('mcp.add.ok'));
}

// ─── MCP Settings Modal ─────────────────────────────────────────────────────
let _mcpCfgId=null, _mcpCfgEnable=false;
const SKIP_ENV_DISPLAY=new Set(['ENABLE_TOOL_SEARCH','ENABLE_EXPERIMENTAL_MCP_CLI']);

function showMcpSettings(id, enableAfter=false) {
  _mcpCfgId=id; _mcpCfgEnable=enableAfter;
  const m=config.mcpServers[id]; if(!m) return;
  $i('mcpSettingsTitle').textContent=`⚙ ${m.label||id}`;
  const body=$i('mcpSettingsBody'); body.innerHTML='';
  if (enableAfter) {
    const note=document.createElement('div');
    note.style.cssText='font-size:12px;color:var(--orange);padding:2px 0 8px;font-weight:600';
    note.textContent=t('mcp.cfg.api_warn');
    body.appendChild(note);
  }
  const rows=[];
  const PH=/YOUR_[A-Z_]+/;
  // URL for http/sse type
  if (m.type==='sse'||m.type==='http') rows.push({source:'url',key:'url',val:m.url||'',label:'URL',secret:false});
  // Headers
  for(const[k,v]of Object.entries(m.headers||{})) rows.push({source:'headers',key:k,val:v,label:`Header: ${k}`,secret:true});
  // Env vars (skip internal flags)
  for(const[k,v]of Object.entries(m.env||{})){
    if(SKIP_ENV_DISPLAY.has(k)) continue;
    rows.push({source:'env',key:k,val:v,label:k,secret:/KEY|TOKEN|SECRET|PASS/i.test(k)});
  }
  // Args: extract URL query params containing placeholders (e.g. Tavily ?apiKey=YOUR_KEY)
  if (m.args) {
    m.args.forEach((a,i)=>{
      if(!PH.test(a)) return;
      // Try to extract query param name containing the placeholder
      const paramRe=/[?&](\w+)=(YOUR_[A-Z_]+)/g;
      let pm;
      while((pm=paramRe.exec(a))!==null){
        const paramName=pm[1], placeholder=pm[2];
        // prefix = everything up to and including '?paramName='
        const prefixEnd=a.indexOf(placeholder);
        const prefix=a.slice(0,prefixEnd);
        const suffix=a.slice(prefixEnd+placeholder.length);
        rows.push({source:'arg_param',key:`arg_${i}_${paramName}`,val:placeholder,label:paramName,secret:true,argIdx:i,placeholder,prefix,suffix});
      }
      // If the whole arg is a placeholder (not a URL param)
      if(!a.match(/[?&]\w+=YOUR_[A-Z_]+/)){
        rows.push({source:'arg',key:`arg_${i}`,val:a,label:`Arg[${i}]`,secret:false,argIdx:i});
      }
    });
  }
  if (rows.length===0) {
    const empty=document.createElement('div');
    empty.style.cssText='color:var(--muted);font-size:13px;text-align:center;padding:20px 0';
    empty.textContent=t('mcp.cfg.no_params');
    body.appendChild(empty);
  } else {
    rows.forEach(f=>{
      const need=PH.test(f.val)||(f.val===''&&/KEY|TOKEN|SECRET|API/i.test(f.key));
      const row=document.createElement('div');
      row.style.cssText='display:flex;flex-direction:column;gap:4px';
      const extraAttrs=f.source==='arg_param'
        ? ` data-arg-idx="${f.argIdx}" data-placeholder="${escH(f.placeholder)}" data-prefix="${escH(f.prefix)}" data-suffix="${escH(f.suffix)}"`
        : f.source==='arg' ? ` data-arg-idx="${f.argIdx}"` : '';
      row.innerHTML=`<label style="font-size:11px;color:${need?'var(--orange)':'var(--muted)'};font-weight:600;text-transform:uppercase;letter-spacing:.4px">${escH(f.label)}${need?' ⚠':''}</label>
        <input type="${f.secret?'password':'text'}" data-src="${f.source}" data-key="${escH(String(f.key))}" value="${escH(f.val)}"${extraAttrs}
          style="background:var(--s2);border:1px solid ${need?'var(--orange)':'var(--border)'};color:var(--text);padding:7px 10px;border-radius:6px;font-size:12px;outline:none;width:100%;font-family:monospace;transition:border .12s">`;
      body.appendChild(row);
    });
  }
  $i('mcpSettingsModal').classList.remove('hidden');
}
function closeMcpSettings() {
  $i('mcpSettingsModal').classList.add('hidden');
  _mcpCfgId=null; _mcpCfgEnable=false;
}
async function saveMcpSettings() {
  const id=_mcpCfgId; if(!id) return;
  const inputs=$i('mcpSettingsBody').querySelectorAll('input[data-src]');
  const envU={}, headU={};
  let urlU=undefined;
  // Collect arg_param changes (need to rebuild args array)
  const argChanges=[]; // {argIdx, placeholder, prefix, suffix, newVal}
  const argDirectChanges=[]; // {argIdx, newVal}
  for(const inp of inputs){
    const src=inp.dataset.src, key=inp.dataset.key, val=inp.value.trim();
    if(src==='env') envU[key]=val;
    else if(src==='headers') headU[key]=val;
    else if(src==='url') urlU=val;
    else if(src==='arg_param') argChanges.push({argIdx:parseInt(inp.dataset.argIdx),placeholder:inp.dataset.placeholder,prefix:inp.dataset.prefix,suffix:inp.dataset.suffix,newVal:val});
    else if(src==='arg') argDirectChanges.push({argIdx:parseInt(inp.dataset.argIdx),newVal:val});
  }
  const payload={};
  if(Object.keys(envU).length) payload.env=envU;
  if(Object.keys(headU).length) payload.headers=headU;
  if(urlU!==undefined) payload.url=urlU;
  // Rebuild args if needed
  const m=config.mcpServers[id];
  if((argChanges.length||argDirectChanges.length)&&m&&m.args){
    const newArgs=[...m.args];
    for(const ch of argChanges) newArgs[ch.argIdx]=ch.prefix+ch.newVal+ch.suffix;
    for(const ch of argDirectChanges) newArgs[ch.argIdx]=ch.newVal;
    payload.args=newArgs;
  }
  try{
    const r=await fetch(`/api/mcp/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    if(m){
      if(payload.env) m.env={...(m.env||{}),...payload.env};
      if(payload.headers) m.headers={...(m.headers||{}),...payload.headers};
      if(payload.url!==undefined) m.url=payload.url;
      if(payload.args) m.args=payload.args;
    }
    if(_mcpCfgEnable){activeMcp.add(id);renderMcp();saveUIState();}
    closeMcpSettings(); toast(t('mcp.cfg.saved'));
  }catch(e){toast(t('mcp.cfg.save_err'),true);}
}

const SKILL_CATS = {
  engineering: { en: '⚙️ Engineering', uk: '⚙️ Розробка', ru: '⚙️ Разработка' },
  ai:          { en: '🧠 AI & Prompts', uk: '🧠 AI та промпти', ru: '🧠 AI и промпты' },
  quality:     { en: '💎 Code Quality', uk: '💎 Якість коду', ru: '💎 Качество кода' },
  security:    { en: '🔒 Security', uk: '🔒 Безпека', ru: '🔒 Безопасность' },
  design:      { en: '🎨 Design', uk: '🎨 Дизайн', ru: '🎨 Дизайн' },
  product:     { en: '📋 Product', uk: '📋 Продукт', ru: '📋 Продукт' },
  finance:     { en: '💼 Finance', uk: '💼 Фінанси', ru: '💼 Финансы' },
  research:    { en: '🔬 Research', uk: '🔬 Дослідження', ru: '🔬 Исследования' },
  system:      { en: '⚙️ System', uk: '⚙️ Система', ru: '⚙️ Система' },
};

const SKILL_TRIGGERS = {
  'backend':            ['backend', 'api endpoint', 'server', 'node.js', 'express', 'fastify', 'endpoint', 'rest api', 'crud', 'migration', 'transaction', 'queue', 'http server'],
  'api-designer':       ['graphql', 'grpc', 'swagger', 'openapi', 'api versioning', 'api design', 'api contract', 'rest design', 'api spec'],
  'frontend':           ['react', 'vue', 'angular', 'component', 'jsx', 'tsx', 'css', 'html', 'browser', 'dom', 'state management', 'hook', 'redux', 'tailwind', 'responsive'],
  'fullstack':          ['full stack', 'fullstack', 'entire feature', 'end to end', 'build a page', 'build a form', 'build an app', 'build a screen', 'full feature'],
  'devops':             ['docker', 'kubernetes', 'k8s', 'deploy', 'aws', 'gcp', 'azure', 'terraform', 'ci/cd', 'pipeline', 'container', 'nginx', 'helm', 'infrastructure', 'monitoring'],
  'postgres-wizard':    ['postgres', 'postgresql', 'index', 'query optimization', 'explain analyze', 'partitioning', 'vacuum', 'slow query'],
  'data-engineer':      ['data pipeline', 'etl', 'spark', 'airflow', 'dbt', 'data warehouse', 'data lake', 'kafka', 'transform data', 'data quality', 'cdc', 'batch processing'],
  'llm-architect':      ['llm', 'chatgpt', 'claude api', 'openai', 'anthropic', 'agent', 'langchain', 'chatbot', 'ai product', 'ai application', 'ai system'],
  'prompt-engineer':    ['prompt', 'system prompt', 'few-shot', 'chain of thought', 'instruction tuning', 'jailbreak', 'context window', 'token limit'],
  'rag-engineer':       ['rag', 'vector', 'embedding', 'retrieval', 'semantic search', 'pinecone', 'chroma', 'weaviate', 'chunk', 'knowledge base', 'vector db'],
  'security':           ['security', 'vulnerability', 'xss', 'sql injection', 'csrf', 'owasp', 'exploit', 'pentest', 'attack', 'breach', 'sanitize', 'threat model'],
  'auth-specialist':    ['auth', 'login', 'oauth', 'jwt', 'token', 'session', 'password', 'sso', 'saml', 'mfa', 'permission', 'rbac', 'roles'],
  'debugging-master':   ['debug', 'bug', 'error', 'fix', 'issue', 'problem', 'crash', 'exception', 'stacktrace', 'not working', 'broken', 'fails', 'investigate error'],
  'code-quality':       ['refactor', 'clean code', 'solid', 'technical debt', 'maintainable', 'readable', 'code smell', 'coupling', 'cohesion'],
  'code-review':        ['review', 'pull request', ' pr ', 'code review', 'feedback on code', 'review this'],
  'system-designer':    ['architecture', 'system design', 'scalable', 'distributed', 'microservices', 'high availability', 'design pattern', 'cap theorem', 'event driven'],
  'ui-design':          ['ui design', 'visual design', 'color palette', 'typography', 'layout', 'figma', 'design system', 'component library', 'style guide', 'pixel'],
  'ux-design':          ['ux', 'user experience', 'usability', 'wireframe', 'prototype', 'user flow', 'journey map', 'onboarding', 'user research', 'usability test'],
  'product-management': ['product', 'roadmap', 'prioritize', 'user story', 'requirements', 'sprint', 'backlog', 'product manager', 'feature request', 'rice'],
  'docs-engineer':      ['documentation', 'readme', 'tutorial', 'guide', 'api docs', 'onboarding doc', 'wiki', 'write docs'],
  'technical-writer':   ['technical writing', 'blog post', 'article', 'write about', 'explain how', 'technical article'],
  'investment-banking': ['dcf', 'lbo', 'valuation', 'financial model', 'investment', 'equity research', 'merger', 'acquisition', 'm&a', 'ebitda', 'wacc', 'comps', 'ipo', 'private equity', 'ic memo', 'investment committee'],
  'researcher':         ['research', 'investigate', 'find information', 'competitive analysis', 'market research', 'analyze market', 'due diligence', 'landscape analysis', 'find and analyze'],
};

function autoSelectSkills(text) {
  const t = text.toLowerCase();
  const scores = {};
  for (const [id] of Object.entries(config.skills || {})) {
    if (id === 'auto-mode') continue; // always included separately
    let score = 0;
    const triggers = SKILL_TRIGGERS[id] || [];
    for (const kw of triggers) { if (t.includes(kw)) score += 2; }
    const descWords = (config.skills[id].description || '').toLowerCase().split(/\W+/).filter(w => w.length > 5);
    for (const w of descWords) { if (t.includes(w)) score += 1; }
    if (score > 0) scores[id] = score;
  }
  const selected = Object.entries(scores).sort((a, b) => b[1] - a[1]).slice(0, 4).map(([id]) => id);
  // Always prepend auto-mode meta-skill so Claude knows to embrace specialist roles
  if (selected.length > 0 && config.skills['auto-mode']) {
    return ['auto-mode', ...selected];
  }
  return selected;
}

function toggleAutoSkills() {
  autoSkillsMode = !autoSkillsMode;
  const btn = $i('autoSkillsBtn');
  if (btn) {
    btn.classList.toggle('active', autoSkillsMode);
    btn.title = autoSkillsMode ? t('auto.title.on') : t('auto.title.off');
  }
  const hint = $i('autoSkillsHint');
  if (hint) hint.style.display = autoSkillsMode ? 'block' : 'none';
  saveUIState();
}

function renderSkills() {
  const el = $i('skillsList'); el.innerHTML = '';
  let c = 0;
  const lang = localStorage.getItem('lang') || 'uk';

  // Group skills by category
  const grouped = {};
  const uncategorized = [];
  for (const [id, s] of Object.entries(config.skills || {})) {
    const cat = s.category || '__custom__';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push([id, s]);
  }

  // Render in defined category order, then custom
  const catOrder = Object.keys(SKILL_CATS);
  const toRender = [
    ...catOrder.filter(k => grouped[k]),
    ...(grouped['__custom__'] ? ['__custom__'] : [])
  ];

  for (const catId of toRender) {
    const items = grouped[catId];
    if (!items?.length) continue;

    // Category header
    const catMeta = SKILL_CATS[catId];
    const catLabel = catMeta ? (catMeta[lang] || catMeta.en) : '🔧 Custom';
    const catDiv = document.createElement('div');
    catDiv.className = 'sk-cat';
    catDiv.textContent = catLabel;
    el.appendChild(catDiv);

    for (const [id, s] of items) {
      const on = activeSkills.has(id);
      if (on) c++;
      const div = document.createElement('div');
      div.className = `ci ${on ? 'on' : ''}`;
      div.title = on ? 'Клік — вимкнути skill' : 'Клік — додати skill до системного промпту';
      div.onclick = () => tSkill(id);
      div.innerHTML = `
        ${mkToggle(on)}
        <div class="inf">
          <div class="nm" data-tip="${escH(s.label || id)}">${escH(s.label || id)}</div>
          <div class="ds" data-tip="${escH(s.description || '')}">${escH(s.description || '')}</div>
          <div class="st">${on ? t('skill.active') : t('skill.inactive')}</div>
        </div>
        ${s.custom ? `<button class="rm" onclick="event.stopPropagation();rSkill('${id}')" title="${t('skill.del.title')}">✕</button>` : ''}`;
      el.appendChild(div);
    }
  }
  $i('skillsCount').textContent = c || '';
}

function tSkill(id) { if (activeSkills.has(id)) activeSkills.delete(id); else activeSkills.add(id); renderSkills(); saveUIState(); }
async function rSkill(id) {
  activeSkills.delete(id);
  await fetch(`/api/skills/${id}`, { method: 'DELETE' });
  delete config.skills[id];
  renderSkills();
}
async function uploadSkill(input) {
  const file = input.files[0];
  if (!file) return;
  const name = prompt('Назва скілу:', file.name.replace(/\.md$/, ''));
  if (!name) return;
  const fd = new FormData();
  fd.append('file', file); fd.append('name', name);
  fd.append('label', name); fd.append('description', 'Custom skill');
  const r = await fetch('/api/skills/upload', { method: 'POST', body: fd });
  const d = await r.json();
  if (d.ok) { toast(t('toast.skill_uploaded')); input.value = ''; await loadCfg(); }
  else toast(t('toast.err_prefix') + (d.error || '?'), true);
}

// ─── Config Editor ────────────────────────────────────────────────────────
const CFG_TABS_BASE = [
  { id: 'config.json', label: 'config.json' },
  { id: '.claude/settings.json', label: 'settings.json' },
  { id: '.env', label: '.env' },
  { id: 'global-claude-md', label: '🌐 Global CLAUDE.md' },
];

async function openCfgEditor() {
  const mdUrl = curWorkdir ? `/api/claude-md?dir=${encodeURIComponent(curWorkdir)}` : '/api/claude-md';
  const [r1, r2] = await Promise.all([fetch('/api/config-files'), fetch(mdUrl)]);
  cfgFiles = await r1.json();
  const cm = await r2.json();
  cfgFiles['global-claude-md'] = cm.global || '';
  cfgFiles['__globalPath']     = cm.globalPath || '~/.claude/CLAUDE.md';

  const tabs = [...CFG_TABS_BASE];
  if (curWorkdir) {
    cfgFiles['local-claude-md'] = cm.local || '';
    cfgFiles['__localPath']     = cm.localPath || curWorkdir + '/CLAUDE.md';
    const projName = projects.find(p => p.workdir === curWorkdir)?.name || curWorkdir.split('/').pop();
    tabs.push({ id: 'local-claude-md', label: `📁 ${projName}` });
  }

  const t = $i('cfgTabs');
  t.innerHTML = '';
  tabs.forEach((c, i) => {
    const d = document.createElement('div');
    d.className = `modal-tab ${i === 0 ? 'active' : ''}`;
    d.dataset.tabId = c.id;
    d.textContent = c.label;
    d.onclick = () => switchCfgTab(c.id);
    t.appendChild(d);
  });
  activeCfgTab = tabs[0].id;
  $i('cfgEditor').value = cfgFiles[activeCfgTab] || '';
  $i('saveNotice').className = 'save-notice hidden';
  updateCfgPathInfo(activeCfgTab);
  $i('cfgModal').classList.remove('hidden');
}

function updateCfgPathInfo(id) {
  const el = $i('cfgPathInfo');
  if (!el) return;
  let path = '';
  if (id === 'global-claude-md') path = cfgFiles['__globalPath'] || '~/.claude/CLAUDE.md';
  else if (id === 'local-claude-md') path = cfgFiles['__localPath'] || 'WORKDIR/CLAUDE.md';
  if (path) { el.textContent = path; el.classList.remove('hidden'); }
  else { el.textContent = ''; el.classList.add('hidden'); }
}

function switchCfgTab(id) {
  cfgFiles[activeCfgTab] = $i('cfgEditor').value;
  activeCfgTab = id;
  $i('cfgEditor').value = cfgFiles[id] || '';
  $i('saveNotice').className = 'save-notice hidden';
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.dataset.tabId === id));
  updateCfgPathInfo(id);
}

async function saveCfg() {
  cfgFiles[activeCfgTab] = $i('cfgEditor').value;
  try {
    let r;
    if (activeCfgTab === 'global-claude-md') {
      r = await fetch('/api/claude-md', { method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'global', content: cfgFiles[activeCfgTab] }) });
    } else if (activeCfgTab === 'local-claude-md') {
      r = await fetch('/api/claude-md', { method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'local', content: cfgFiles[activeCfgTab], dir: curWorkdir }) });
    } else {
      r = await fetch('/api/config-files', { method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: activeCfgTab, content: cfgFiles[activeCfgTab] }) });
    }
    const d = await r.json();
    if (d.ok) {
      $i('saveNotice').className = 'save-notice';
      setTimeout(() => $i('saveNotice').className = 'save-notice hidden', 2000);
      if (activeCfgTab === 'config.json') loadCfg();
      toast(t('cfg.saved'));
    } else toast(t('toast.err_prefix') + (d.error || '?'), true);
  } catch (e) { toast(e.message, true); }
}

function closeCfg() { $i('cfgModal').classList.add('hidden'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeFpv(); closeCfg(); closeDirModal(); cancelStop(); } });

// ─── File Browser ─────────────────────────────────────────────────────────
function _filesQS(relPath) {
  const wd = curWorkdir;
  return `path=${encodeURIComponent(relPath)}${wd ? '&workdir=' + encodeURIComponent(wd) : ''}`;
}

async function loadFiles(dir = '') {
  try {
    const r = await fetch(`/api/files?${_filesQS(dir)}`);
    const d = await r.json();
    if (d.type !== 'dir') return;
    const t = $i('filesTree');
    t.innerHTML = '';

    if (dir) {
      const b = document.createElement('div');
      b.className = 'fii';
      b.innerHTML = '<span class="fi" style="color:var(--muted)">↑</span><span class="fn">..</span>';
      b.onclick = () => loadFiles(dir.split('/').slice(0, -1).join('/'));
      t.appendChild(b);
    }

    const items = d.items.sort((a, b) => a.type !== b.type ? (a.type === 'dir' ? -1 : 1) : a.name.localeCompare(b.name));
    for (const it of items) {
      const el = document.createElement('div');
      el.className = 'fii';
      const fileBtns = it.type === 'file' ? `<button class="fpe" onclick="event.stopPropagation();openFilePreview('${escH(it.path)}','${escH(it.name)}')" title="Переглянути">👁</button><button class="fdl" onclick="event.stopPropagation();downloadFile('${escH(it.path)}')" title="Завантажити">⬇</button>` : '';
      el.innerHTML = `<span class="fi">${it.type === 'dir' ? '<span style="color:var(--accent2);font-size:13px">▸</span>' : fileIcon(it.name)}</span><span class="fn">${escH(it.name)}</span><span class="fs">${it.size ? fmtSize(it.size) : ''}</span>${fileBtns}`;
      el.onclick = it.type === 'dir' ? () => loadFiles(it.path) : () => openFilePreview(it.path, it.name);
      t.appendChild(el);
    }

    if (!items.length) t.innerHTML = '<div style="padding:14px;color:var(--muted);text-align:center;font-size:11px">Порожньо</div>';
  } catch {}
}

let _fpvPath = '', _fpvName = '';

function closeFpv() {
  $i('filePreviewModal').classList.add('hidden');
  $i('fpvBody').innerHTML = '';
  _fpvPath = ''; _fpvName = '';
}

async function openFilePreview(relPath, name) {
  _fpvPath = relPath;
  _fpvName = name || relPath.split('/').pop();
  const ext = (_fpvName.lastIndexOf('.') > 0 ? _fpvName.slice(_fpvName.lastIndexOf('.')).toLowerCase() : '');
  $i('fpvTitle').textContent = _fpvName;
  $i('fpvExt').textContent = ext || 'file';
  const body = $i('fpvBody');
  body.innerHTML = `<div class="fpv-text" style="color:var(--muted)">Завантаження...</div>`;
  $i('filePreviewModal').classList.remove('hidden');

  const rawUrl = `/api/files/raw?${_filesQS(relPath)}`;
  const imgExts = ['.png','.jpg','.jpeg','.gif','.webp','.svg','.bmp','.ico','.tiff'];
  const pdfExts = ['.pdf'];
  const mdExts  = ['.md','.mdx'];
  const textExts= ['.js','.ts','.jsx','.tsx','.mjs','.cjs','.py','.rb','.go','.rs','.php',
                   '.java','.kt','.swift','.cs','.cpp','.c','.h','.html','.css','.scss',
                   '.json','.yaml','.yml','.toml','.ini','.cfg','.env','.txt','.sh','.bash',
                   '.zsh','.sql','.graphql','.xml','.vue','.svelte','.log','.pine','.lock'];

  if (imgExts.includes(ext)) {
    body.innerHTML = `<img src="${escH(rawUrl)}" alt="${escH(_fpvName)}" onerror="this.alt=t('fpv.img_error')">`;
    return;
  }
  if (pdfExts.includes(ext)) {
    body.innerHTML = `<iframe src="${escH(rawUrl)}" title="${escH(_fpvName)}"></iframe>`;
    return;
  }
  // md and text: fetch content
  try {
    const r = await fetch(`/api/files?${_filesQS(relPath)}`);
    const d = await r.json();
    if (d.content === '[Binary]' || (!d.content && !textExts.includes(ext) && !mdExts.includes(ext))) {
      body.innerHTML = `<div class="fpv-binary"><div style="font-size:40px">📦</div><div>${t('fpv.binary')}</div><button class="fpv-btn" onclick="fpvDownload()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ${t('fpv.download')}</button></div>`;
      return;
    }
    if (mdExts.includes(ext)) {
      body.innerHTML = `<div class="fpv-md msg">${renderMd(d.content || '')}</div>`;
    } else {
      body.innerHTML = `<div class="fpv-text">${escH(d.content || '')}</div>`;
    }
  } catch {
    body.innerHTML = `<div class="fpv-binary">${t('fpv.load_error')}</div>`;
  }
}

function fpvDownload() {
  if (_fpvPath) downloadFile(_fpvPath);
}

async function fpvShare() {
  if (!_fpvPath) return;
  const url = location.origin + `/api/files/raw?${_filesQS(_fpvPath)}`;
  if (navigator.share) {
    try {
      await navigator.share({ title: _fpvName, url });
      return;
    } catch {}
  }
  try {
    await navigator.clipboard.writeText(url);
    toast(t('toast.link_copied'));
  } catch {
    prompt(t('toast.link_prompt'), url);
  }
}

function downloadFile(relPath) {
  window.open(`/api/files/download?${_filesQS(relPath)}`, '_blank');
}

function fileIcon(name) {
  const ext = name.split('.').pop().toLowerCase();
  const colors = { js: '#f7df1e', ts: '#3178c6', py: '#3572a5', html: '#e34c26', css: '#264de4', json: '#cbcb41', md: '#083fa1', sh: '#89e051', go: '#00add8', rs: '#dea584', rb: '#701516', sql: '#336791' };
  const color = colors[ext];
  if (color) return `<span style="font-size:10px;font-weight:700;color:${color};font-family:monospace">${ext.toUpperCase()}</span>`;
  return `<span style="font-size:10px;color:var(--muted);font-family:monospace">${ext ? ext.toUpperCase() : 'FILE'}</span>`;
}

function fmtSize(b) {
  return b < 1024 ? b + 'B' : b < 1048576 ? (b / 1024).toFixed(1) + 'K' : (b / 1048576).toFixed(1) + 'M';
}

// ─── Projects ──────────────────────────────────────────────────────────────
async function loadProjectsList() {
  try {
    const r = await fetch('/api/projects');
    projects = await r.json();
    renderProjects();
  } catch(e) { console.error('loadProjectsList:', e); }
}

function renderProjects() {
  const el = $i('projList');
  if (!el) return;
  el.innerHTML = '';
  $i('projCount').textContent = projects.length || '';

  // Update active project label in header
  const activeProjLabel = $i('activeProjLabel');
  if (activeProjLabel) {
    const activeProj = curProjectId ? projects.find(p => p.id === curProjectId) : null;
    if (activeProj) { activeProjLabel.textContent = activeProj.name; activeProjLabel.setAttribute('data-tip', activeProj.name + '\n' + activeProj.workdir); activeProjLabel.style.display = 'inline-block'; }
    else { activeProjLabel.textContent = ''; activeProjLabel.removeAttribute('data-tip'); activeProjLabel.style.display = 'none'; }
  }

  if (!projects.length) {
    el.innerHTML = '<div style="font-size:11px;color:var(--muted);padding:2px 2px 8px;line-height:1.5">Немає проектів. Додайте директорію для роботи з Claude Code.</div>';
    return;
  }

  for (const p of projects) {
    const active = p.id === curProjectId;
    // Check if any tab in this project is generating (works for both current and background)
    const tabs = active ? openTabs : (projectTabs[p.id] || []);
    const busy = tabs.some(tab => tab.generating);
    const div = document.createElement('div');
    div.className = `ci${active ? ' on' : ''}`;
    div.title = active ? t('proj.active.title') : t('proj.click.title');
    div.onclick = () => switchProject(p.id);
    const shortPath = p.workdir.length > 38 ? '…' + p.workdir.slice(-36) : p.workdir;
    const busyDot = busy ? '<span class="proj-busy-dot tab-dot spinning" title="Генерація у фоні..."></span>' : '';
    div.innerHTML = `
      <div class="inf">
        <div class="nm" data-tip="${escH(p.name)}">${escH(p.name)}${busyDot}</div>
        <div class="ds" data-tip="${escH(p.workdir)}">${escH(shortPath)}</div>
        <div class="st">${active ? t('proj.active') : t('proj.inactive')}</div>
      </div>
      <button class="rm" onclick="event.stopPropagation();delProject('${p.id}')" title="${t('proj.del.title')}">✕</button>`;
    el.appendChild(div);
  }
}

// ─── Per-project tab save/restore ────────────────────────────────────────
const PROJ_TABS_KEY = pid => `cc_ptabs_${pid || '__none'}`;

// loadProjTabs: read from localStorage for initial restore only
function loadProjTabs(pid) {
  try { return JSON.parse(localStorage.getItem(PROJ_TABS_KEY(pid)) || 'null'); } catch { return null; }
}

function switchProject(id) {
  // No isGen block — background generation continues uninterrupted
  const p = projects.find(x => x.id === id);
  if (!p) return;

  // Persist current project's live tab state to memory before switching away
  if (curProjectId) {
    projectTabs[curProjectId] = openTabs;
    projectActiveTab[curProjectId] = activeTabId;
  }

  // Toggle off if clicking the already-active project
  if (curProjectId === id) {
    curProjectId = null; curWorkdir = null;
    openTabs = []; activeTabId = null; currentSessionId = null;
    msgsEl.innerHTML = ''; showW(); renderTabs();
    renderProjects(); saveUIState(); loadHist();
    toast(t('proj.deactivated'));
    return;
  }

  curProjectId = id;
  curWorkdir = p.workdir;

  // Restore from in-memory state (if project was visited before), else from localStorage
  if (projectTabs[id]) {
    openTabs = projectTabs[id];
    activeTabId = projectActiveTab[id] ?? openTabs[0]?.id ?? null;
  } else {
    const saved = loadProjTabs(id);
    if (saved?.tabs?.length) {
      openTabs = saved.tabs.map(t => ({ id: t.id, title: t.title, generating: false, done: false }));
      activeTabId = saved.activeTabId || openTabs[0]?.id || null;
    } else {
      openTabs = []; activeTabId = null;
    }
    projectTabs[id] = openTabs;
    projectActiveTab[id] = activeTabId;
  }

  // Update UI for the newly active project
  renderTabs();
  if (activeTabId) {
    const tab = openTabs.find(t => t.id === activeTabId);
    if (tab?.isNew) { currentSessionId = null; msgsEl.innerHTML = ''; showW(); }
    else loadSess(activeTabId);
    // Sync send/stop button to this tab's generating state
    if (tab?.generating) { isGen = true; generatingTabId = activeTabId; setSendStop(true); sbShow(t('status.generating')); }
    else { isGen = false; generatingTabId = null; setSendStop(false); sbHide(); }
  } else {
    currentSessionId = null; msgsEl.innerHTML = ''; showW();
    isGen = false; generatingTabId = null; setSendStop(false); sbHide();
  }

  renderProjects(); saveUIState(); loadHist(); loadFiles('');
  toast(`✓ ${p.name}`);
}

async function delProject(id) {
  const p = projects.find(x => x.id === id);
  if (!confirm(t('proj.delete.confirm').replace('{{name}}', p?.name || id))) return;
  await fetch(`/api/projects/${id}`, { method: 'DELETE' });
  if (curProjectId === id) {
    curProjectId = null; curWorkdir = null;
    openTabs = []; activeTabId = null; currentSessionId = null;
    msgsEl.innerHTML = ''; showW(); renderTabs();
    loadHist();
  }
  // Clean up in-memory state for deleted project
  delete projectTabs[id];
  delete projectActiveTab[id];
  projects = projects.filter(x => x.id !== id);
  try { localStorage.removeItem(PROJ_TABS_KEY(id)); } catch {}
  renderProjects(); saveUIState();
}

// ─── Directory browser ───────────────────────────────────────────────────
function openAddProject() {
  $i('dirModal').classList.remove('hidden');
  $i('gitInitChk').checked = false;
  $i('projNameInput').value = '';
  dirBrowsePath = null;
  browseDirs(null);
}

async function browseDirs(dirPath) {
  const url = dirPath ? `/api/browse-dirs?path=${encodeURIComponent(dirPath)}` : '/api/browse-dirs';
  try {
    const r = await fetch(url);
    const d = await r.json();
    if (d.error) { toast(d.error, true); return; }

    dirBrowsePath = d.path;
    $i('dirCurrentPath').textContent = d.path;
    // Auto-fill name if empty
    const nameEl = $i('projNameInput');
    if (!nameEl.value) nameEl.value = d.path.split('/').filter(Boolean).pop() || '';

    const list = $i('dirList');
    list.innerHTML = '';

    // Up button
    if (d.parent) {
      const b = document.createElement('div');
      b.className = 'dii';
      b.innerHTML = '<span class="di" style="color:var(--muted)">↑</span><span class="dn" style="color:var(--muted)">..</span>';
      b.onclick = () => browseDirs(d.parent);
      list.appendChild(b);
    }

    // Current dir as selectable row
    const self = document.createElement('div');
    self.className = 'dii selected';
    self.innerHTML = `<span class="di" style="color:var(--accent2)">▸</span><span class="dn"><strong>${t('dir.this_dir')}</strong></span>`;
    self.onclick = () => { dirBrowsePath = d.path; $i('dirCurrentPath').textContent = d.path; highlightSelected(self); };
    list.appendChild(self);

    // Subdirectories — single click selects, double click navigates
    for (const it of d.items) {
      const el = document.createElement('div');
      el.className = `dii${it.hidden ? ' hidden-dir' : ''}`;
      el.innerHTML = `<span class="di" style="color:var(--muted)">▸</span><span class="dn">${escH(it.name)}</span>`;
      el.onclick = () => {
        if (el._t) { clearTimeout(el._t); el._t = null; browseDirs(it.path); }
        else { el._t = setTimeout(() => {
          el._t = null;
          dirBrowsePath = it.path;
          $i('dirCurrentPath').textContent = it.path;
          $i('projNameInput').value = it.name;
          highlightSelected(el);
        }, 220); }
      };
      list.appendChild(el);
    }

    if (!d.items.length) {
      const e = document.createElement('div');
      e.style.cssText = 'padding:12px;color:var(--muted);text-align:center;font-size:12px';
      e.textContent = t('dir.no_subdirs');
      list.appendChild(e);
    }
  } catch(e) { toast(t('toast.err_prefix') + e.message, true); }
}

function highlightSelected(el) {
  $i('dirList').querySelectorAll('.dii').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
}

async function selectDir() {
  if (!dirBrowsePath) { toast(t('toast.select_dir'), true); return; }
  const name = ($i('projNameInput').value.trim()) || dirBrowsePath.split('/').filter(Boolean).pop() || dirBrowsePath;
  const gitInit = $i('gitInitChk').checked;

  const r = await fetch('/api/projects', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, workdir: dirBrowsePath, gitInit }),
  });
  const d = await r.json();
  if (!d.ok) { toast(t('toast.err_prefix') + (d.error || '?'), true); return; }
  if (d.gitError) toast('git init: ' + d.gitError, true, 4000);
  else if (d.actions?.length) toast('✓ ' + d.actions.join(', '));

  await loadProjectsList();
  if (d.id) switchProject(d.id);
  closeDirModal();
  if (_onProjectCreated) { const cb = _onProjectCreated; _onProjectCreated = null; cb(); }
}

function closeDirModal() {
  $i('dirModal').classList.add('hidden');
}

// ─── Persist UI state across page refreshes ──────────────────────────────
const LS_KEY = 'cc_ui_state';
function saveUIState() {
  try {
    const c = id => $i(id)?.classList.contains('collapsed');
    // Collect all project tab states (current + background)
    const allProjTabs = {};
    for (const [pid, tabs] of Object.entries(projectTabs)) {
      allProjTabs[pid] = {
        tabs: tabs.filter(t => !t.isNew).map(t => ({ id: t.id, title: t.title })),
        activeTabId: pid === curProjectId ? activeTabId : (projectActiveTab[pid] || tabs[0]?.id || null),
      };
    }
    // Ensure current project is always included
    if (curProjectId) {
      allProjTabs[curProjectId] = {
        tabs: openTabs.filter(t => !t.isNew).map(t => ({ id: t.id, title: t.title })),
        activeTabId: openTabs.find(t => t.id === activeTabId && !t.isNew) ? activeTabId : null,
      };
    }
    localStorage.setItem(LS_KEY, JSON.stringify({
      activeMcp: [...activeMcp],
      activeSkills: [...activeSkills],
      autoSkillsMode,
      curWorkdir, curProjectId,
      panels: { left: c('leftPanel'), right: c('rightPanel') },
      sections: { hist: c('histBody'), mcp: c('mcpBody'), skills: c('skillsBody'), proj: c('projBody') },
      openTabs: openTabs.filter(t => !t.isNew).map(t => ({ id: t.id, title: t.title })),
      activeTabId: openTabs.find(t => t.id === activeTabId && !t.isNew) ? activeTabId : null,
      allProjTabs,
    }));
  } catch {}
}
function restoreUIState() {
  try {
    const s = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if (!s) return;
    if (s.activeMcp) activeMcp = new Set(s.activeMcp);
    if (s.activeSkills) activeSkills = new Set(s.activeSkills);
    if (s.autoSkillsMode !== undefined) { autoSkillsMode = !!s.autoSkillsMode; }
    if (s.curWorkdir) curWorkdir = s.curWorkdir;
    if (s.curProjectId) curProjectId = s.curProjectId;
    if (s.panels) {
      const setPanel = (id, collapsed) => {
        const el = $i(id); if (!el) return;
        el.classList.toggle('collapsed', !!collapsed);
        const btn = document.querySelector(`[onclick="toggle('${id}')"]`);
        if (btn) btn.classList.toggle('active', !collapsed);
      };
      setPanel('leftPanel', s.panels.left);
      setPanel('rightPanel', s.panels.right);
    }
    if (s.sections) {
      const secs = { hist: 'histBody', mcp: 'mcpBody', skills: 'skillsBody', proj: 'projBody' };
      for (const [k, elId] of Object.entries(secs)) {
        const el = $i(elId);
        if (!el) continue;
        el.classList.toggle('collapsed', !!s.sections[k]);
        const title = el.previousElementSibling;
        if (title) title.setAttribute('aria-expanded', String(!s.sections[k]));
      }
    }
    // Restore current project's tabs
    if (s.openTabs?.length) {
      openTabs = s.openTabs.map(t => ({ id: t.id, title: t.title, generating: false, done: false }));
      activeTabId = s.activeTabId || null;
    }
    // Pre-populate background project tab arrays from saved state
    if (s.allProjTabs) {
      for (const [pid, saved] of Object.entries(s.allProjTabs)) {
        if (pid === curProjectId) continue; // current project already restored above
        if (saved?.tabs?.length) {
          projectTabs[pid] = saved.tabs.map(t => ({ id: t.id, title: t.title, generating: false, done: false }));
          projectActiveTab[pid] = saved.activeTabId || projectTabs[pid][0]?.id || null;
        }
      }
    }
    // Sync projectTabs for current project
    if (curProjectId && openTabs.length) {
      projectTabs[curProjectId] = openTabs;
      projectActiveTab[curProjectId] = activeTabId;
    }
  } catch {}
}

// ─── Global tooltip system ────────────────────────────────────────────────
const _tipEl = (() => {
  const d = document.createElement('div');
  d.id = 'globalTip';
  document.body.appendChild(d);
  return d;
})();
let _tipTimer = null;
document.addEventListener('mouseover', e => {
  const el = e.target.closest('[data-tip]');
  clearTimeout(_tipTimer);
  if (!el) { _tipEl.style.opacity = '0'; return; }
  const txt = el.getAttribute('data-tip');
  if (!txt) { _tipEl.style.opacity = '0'; return; }
  _tipTimer = setTimeout(() => {
    _tipEl.textContent = txt;
    const r = el.getBoundingClientRect();
    const tw = _tipEl.offsetWidth || 200;
    const th = _tipEl.offsetHeight || 30;
    let x = Math.round(r.left + r.width / 2 - tw / 2);
    let y = Math.round(r.top - th - 8);
    if (y < 8) y = Math.round(r.bottom + 8);
    x = Math.max(8, Math.min(x, window.innerWidth - tw - 8));
    _tipEl.style.left = x + 'px';
    _tipEl.style.top = y + 'px';
    _tipEl.style.opacity = '1';
  }, 420);
});
document.addEventListener('mouseout', () => {
  clearTimeout(_tipTimer);
  _tipEl.style.opacity = '0';
});

// ─── Init ─────────────────────────────────────────────────────────────────
setLang(localStorage.getItem('lang') || 'uk');
restoreUIState();
{
  const btn = $i('autoSkillsBtn');
  if (btn) {
    btn.classList.toggle('active', autoSkillsMode);
    btn.title = autoSkillsMode ? t('auto.title.on') : t('auto.title.off');
  }
  const hint = $i('autoSkillsHint');
  if (hint) hint.style.display = autoSkillsMode ? 'block' : 'none';
}
renderTabs();
loadCfg();
loadProjectsList();
connect();
checkVersion();
// Handle ?open_session=<id> from Kanban board links
{
  const qs = new URLSearchParams(location.search);
  const sessId = qs.get('open_session');
  if (sessId) {
    history.replaceState(null, '', '/');
    // Wait for WS connect, then open the session tab
    const tryOpen = () => {
      if (!openTabs.find(t => t.id === sessId)) openTab(sessId, '…');
      else switchTab(sessId);
    };
    if (ws && ws.readyState === 1) tryOpen();
    else setTimeout(tryOpen, 800);
  }
}
</script>
</body>
</html>
