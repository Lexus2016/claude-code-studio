<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban â€” Claude Code Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ CSS vars identical to main app â”€â”€â”€ */
:root {
  --bg: #090d13; --s1: #111620; --s2: #181e2b; --s3: #1f2637;
  --border: #2a3347; --text: #dce6f5; --muted: #7a8baa;
  --accent: #7c6aef; --accent2: #a08df5; --abg: rgba(124,106,239,.13);
  --green: #3fb950; --orange: #e5a435; --red: #f85149; --blue: #58a6ff;
  --r: 10px; --r-sm: 6px; --r-md: 10px; --r-lg: 14px;
  --shadow: 0 4px 24px rgba(0,0,0,.4);
  --shadow-md: 0 4px 16px rgba(0,0,0,.32);
  --shadow-xl: 0 24px 64px rgba(0,0,0,.65);
}
*{ margin:0; padding:0; box-sizing:border-box; }
html,body{ height:100%; overflow:hidden; }
body{
  font-family:'Plus Jakarta Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:var(--bg); color:var(--text); font-size:14px;
  display:flex; flex-direction:column; line-height:1.55;
}
body::after{
  content:''; position:fixed; inset:0; z-index:9998; pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  opacity:0.022;
}
:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:3px; }
button:focus-visible,a:focus-visible{ border-radius:5px; }
::-webkit-scrollbar{ width:4px; height:4px; }
::-webkit-scrollbar-track{ background:transparent; }
::-webkit-scrollbar-thumb{ background:var(--border); border-radius:2px; }

/* â”€â”€â”€ Header â”€â”€â”€ */
.hdr{ display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:var(--s1); border-bottom:1px solid var(--border); flex-shrink:0; }
.hdr-l{ display:flex; align-items:center; gap:10px; }
.logo{ width:32px; height:32px; border-radius:9px; background:linear-gradient(135deg,var(--accent),#a855f7); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; color:white; flex-shrink:0; box-shadow:0 2px 8px rgba(124,106,239,.4); }
.hdr-btns{ display:flex; gap:5px; }
.hdr-meta{ display:flex; align-items:center; gap:6px; }
.status-dot{ display:inline-flex; align-items:center; gap:5px; font-size:13px; }
.status-dot::before{ content:'â—'; font-size:8px; }
.status-dot.ok{ color:var(--green); }
.status-dot.ok::before{ color:var(--green); }
.status-dot.err{ color:var(--red); }
.status-dot.err::before{ color:var(--red); }
#kbVersionBadge{ font-size:11px; color:var(--muted); letter-spacing:.3px; }
.hb{ background:var(--s2); border:1px solid var(--border); color:var(--muted); padding:5px 11px; border-radius:7px; cursor:pointer; font-size:13px; transition:all .15s; font-weight:500; font-family:inherit; text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
.hb:hover{ color:var(--text); border-color:var(--accent2); background:var(--s3); }
.hb.active{ color:var(--accent2); border-color:var(--accent); background:var(--abg); }
.hb:active{ transform:scale(0.95); transition-duration:0.07s; }

/* â”€â”€â”€ Nav switcher â”€â”€â”€ */
.nav-sw{ display:flex; align-items:center; background:var(--s3); border:1px solid var(--border); border-radius:8px; padding:3px; gap:2px; }
.nav-sw-btn{ display:inline-flex; align-items:center; gap:5px; padding:4px 11px; border-radius:6px; font-size:13px; font-weight:600; color:var(--muted); text-decoration:none; transition:all .15s; white-space:nowrap; }
.nav-sw-btn:hover{ color:var(--text); background:rgba(255,255,255,.05); }
.nav-sw-btn.active{ background:var(--s2); color:var(--accent2); box-shadow:0 1px 3px rgba(0,0,0,.3); }

/* â”€â”€â”€ Project selector strip â”€â”€â”€ */
.proj-bar{ display:flex; align-items:center; gap:10px; padding:9px 16px; background:var(--s1); border-bottom:1px solid var(--border); flex-shrink:0; }
.proj-label{ font-size:11.5px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.6px; white-space:nowrap; }
.proj-sel{ background:var(--s2); border:1px solid var(--border); border-radius:var(--r-sm); color:var(--text); font-size:13px; padding:4px 10px; cursor:pointer; font-family:inherit; max-width:280px; }
.proj-sel:focus{ outline:none; border-color:var(--accent); }
.refresh-ts{ font-size:11px; color:var(--muted); margin-left:auto; }
@keyframes spin{ to{ transform:rotate(360deg); } }
.spinning{ display:inline-block; width:12px; height:12px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; vertical-align:middle; }

/* â”€â”€â”€ Board â”€â”€â”€ */
.board{ display:flex; gap:12px; padding:14px 16px 20px; overflow-x:auto; flex:1; align-items:flex-start; }

/* â”€â”€â”€ Column â”€â”€â”€ */
.col{ flex-shrink:0; width:268px; display:flex; flex-direction:column; max-height:100%; }
.col-head{ display:flex; align-items:center; gap:8px; padding:8px 10px; margin-bottom:8px; border-radius:var(--r-md); background:var(--s2); border:1px solid var(--border); }
.col-dot{ width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.col-title{ font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:.6px; flex:1; color:var(--muted); }
.col-cnt{ background:var(--s3); color:var(--muted); font-size:11px; padding:1px 7px; border-radius:10px; font-weight:600; }
.col-body{ display:flex; flex-direction:column; gap:8px; overflow-y:auto; flex:1; padding:2px; min-height:80px; border-radius:var(--r-md); transition:background .12s; }
.col-body.dz{ background:var(--abg); outline:2px dashed var(--accent); outline-offset:2px; }
.col-add{ margin-top:8px; padding:7px; border-radius:var(--r-sm); border:1px dashed var(--border); background:transparent; color:var(--muted); cursor:pointer; font-size:12px; text-align:center; transition:.12s; font-family:inherit; }
.col-add:hover{ background:var(--s2); color:var(--text); border-color:var(--muted); }
.col-empty{ text-align:center; padding:24px 10px; color:var(--muted); font-size:12px; border:1px dashed var(--border); border-radius:var(--r-md); user-select:none; }

/* Status colours */
.dot-backlog{ background:var(--muted); }
.dot-todo{ background:var(--blue); }
.dot-in_progress{ background:var(--orange); }
.dot-done{ background:var(--green); }
.dot-cancelled{ background:var(--red); }

/* â”€â”€â”€ Card â”€â”€â”€ */
.card{ background:var(--s2); border:1px solid var(--border); border-radius:var(--r-md); padding:11px 13px; cursor:grab; user-select:none; transition:box-shadow .15s,border-color .15s,transform .1s; }
.card:hover{ border-color:var(--muted); box-shadow:var(--shadow-md); }
.card.dragging{ opacity:.4; cursor:grabbing; transform:scale(.97); }
.card-ph{ border:2px dashed var(--accent); border-radius:var(--r-md); background:var(--abg); opacity:.5; }
.card-title{ font-size:13px; font-weight:600; line-height:1.4; margin-bottom:5px; word-break:break-word; }
.card-desc{ font-size:12px; color:var(--muted); line-height:1.5; margin-bottom:8px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
.card-foot{ display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.badge{ font-size:11px; padding:2px 7px; border-radius:4px; white-space:nowrap; font-weight:500; }
.badge-muted{ background:var(--s3); color:var(--muted); }
.badge-accent{ background:var(--abg); color:var(--accent2); border:1px solid rgba(124,106,239,.2); max-width:140px; overflow:hidden; text-overflow:ellipsis; }
.badge-green{ background:rgba(63,185,80,.12); color:var(--green); border:1px solid rgba(63,185,80,.2); }
.badge-orange{ background:rgba(229,164,53,.12); color:var(--orange); border:1px solid rgba(229,164,53,.2); }
.card-time{ font-size:11px; color:var(--muted); margin-left:auto; }
.card-actions{ display:none; gap:3px; margin-left:auto; }
.card:hover .card-actions{ display:flex; }
.card:hover .card-time{ display:none; }
.cbtn{ background:none; border:none; cursor:pointer; color:var(--muted); padding:2px 5px; border-radius:var(--r-sm); font-size:12px; line-height:1; transition:color .1s,background .1s; }
.cbtn:hover{ color:var(--text); background:var(--s3); }

/* â”€â”€â”€ Modal overlay â”€â”€â”€ */
.ov{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:flex; align-items:center; justify-content:center; z-index:200; padding:16px; backdrop-filter:blur(4px); }
.ov.hidden{ display:none; }
.modal{ background:var(--s1); border:1px solid var(--border); border-radius:var(--r-lg); width:100%; max-width:680px; max-height:92vh; display:flex; flex-direction:column; box-shadow:var(--shadow-xl); }
.modal-hd{ display:flex; align-items:center; gap:10px; padding:15px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
.modal-hd-title{ font-size:15px; font-weight:700; flex:1; }
.modal-close{ background:none; border:none; color:var(--muted); cursor:pointer; font-size:20px; padding:2px 6px; border-radius:var(--r-sm); line-height:1; transition:color .1s,background .1s; }
.modal-close:hover{ color:var(--text); background:var(--s2); }
.modal-body{ padding:20px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:14px; }
.modal-ft{ padding:12px 20px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; flex-shrink:0; }

/* Form elements */
.lbl{ font-size:11.5px; color:var(--muted); font-weight:600; margin-bottom:5px; display:block; text-transform:uppercase; letter-spacing:.4px; }
.inp{ background:var(--s2); border:1px solid var(--border); border-radius:var(--r-sm); color:var(--text); font-size:13px; padding:8px 12px; width:100%; font-family:inherit; transition:border-color .15s; }
.inp:focus{ outline:none; border-color:var(--accent); }
textarea.inp{ resize:vertical; min-height:80px; }
.sel{ background:var(--s2); border:1px solid var(--border); border-radius:var(--r-sm); color:var(--text); font-size:13px; padding:8px 12px; width:100%; cursor:pointer; font-family:inherit; transition:border-color .15s; }
.sel:focus{ outline:none; border-color:var(--accent); }
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

/* Buttons */
.btn{ display:inline-flex; align-items:center; gap:6px; padding:7px 14px; border-radius:var(--r-sm); border:none; cursor:pointer; font-size:13px; font-family:inherit; font-weight:600; transition:opacity .12s,background .12s; }
.btn:hover{ opacity:.88; }
.btn:active{ transform:scale(.96); transition-duration:.07s; }
.btn-primary{ background:var(--accent); color:#fff; box-shadow:0 2px 10px rgba(124,106,239,.35); }
.btn-ghost{ background:transparent; border:1px solid var(--border); color:var(--muted); }
.btn-ghost:hover{ color:var(--text); background:var(--s2); border-color:var(--muted); }
.btn-danger{ background:transparent; border:1px solid var(--red); color:var(--red); }
.btn-danger:hover{ background:rgba(248,81,73,.1); }
.btn-sm{ padding:4px 10px; font-size:12px; }

/* â”€â”€â”€ Chat history panel in modal â”€â”€â”€ */
.chat-panel{ border:1px solid var(--border); border-radius:var(--r-md); overflow:hidden; }
.chat-panel-hd{ padding:8px 14px; background:var(--s2); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; font-size:12px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
.chat-panel-body{ max-height:280px; overflow-y:auto; }
.chat-msg{ padding:9px 14px; border-bottom:1px solid var(--border); }
.chat-msg:last-child{ border-bottom:none; }
.chat-role{ font-size:10px; font-weight:700; text-transform:uppercase; margin-bottom:3px; letter-spacing:.5px; }
.chat-role.user{ color:var(--blue); }
.chat-role.assistant{ color:var(--accent2); }
.chat-role.tool{ color:var(--orange); }
.chat-text{ font-size:12px; line-height:1.5; color:var(--text); white-space:pre-wrap; word-break:break-word; max-height:100px; overflow:hidden; }
.chat-empty{ padding:20px; text-align:center; color:var(--muted); font-size:12px; }
.sess-info{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-left:auto; }
.mono-tag{ font-family:monospace; font-size:11px; color:var(--muted); background:var(--s3); padding:2px 7px; border-radius:4px; cursor:pointer; border:1px solid var(--border); transition:border-color .1s; }
.mono-tag:hover{ border-color:var(--muted); color:var(--text); }
.open-link{ display:inline-flex; align-items:center; gap:4px; font-size:12px; color:var(--accent2); text-decoration:none; padding:2px 8px; border-radius:4px; border:1px solid rgba(124,106,239,.25); transition:background .1s; }
.open-link:hover{ background:var(--abg); }

/* â”€â”€â”€ New session config (in Add modal) â”€â”€â”€ */
.new-sess-hdr{ font-size:11px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }
.sess-cfg{ border:1px solid var(--border); border-radius:var(--r-md); padding:12px 14px; background:var(--s2); }
.sc-row{ display:flex; align-items:center; gap:7px; flex-wrap:wrap; }
.sc-grp{ display:flex; flex-direction:column; gap:5px; }
.sc-grp-lbl{ font-size:10.5px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.5px; padding-left:1px; }
.sc-seg{ display:flex; align-items:center; gap:2px; background:var(--s3); border:1px solid var(--border); border-radius:8px; padding:3px; }
.sc-seg .sc-lbl{ font-size:11px; color:var(--muted); font-weight:700; letter-spacing:.6px; text-transform:uppercase; padding:0 7px; white-space:nowrap; }
.sc-btn{ padding:4px 11px; border-radius:6px; border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:13px; transition:all .12s; white-space:nowrap; font-weight:500; font-family:inherit; }
.sc-btn:hover{ color:var(--text); background:rgba(255,255,255,.06); }
.sc-btn.on{ background:var(--accent); color:white; box-shadow:0 1px 6px rgba(124,106,239,.4); }
.sc-sep{ width:1px; height:20px; background:var(--border); margin:0 2px; flex-shrink:0; }
.sc-turns{ width:55px; padding:4px 8px; border-radius:6px; background:var(--s2); border:1px solid var(--border); color:var(--text); font-size:13px; text-align:center; font-family:inherit; outline:none; }
.sc-turns:focus{ border-color:var(--accent); }
.new-sess-cfg{ display:none; }
.new-sess-cfg.visible{ display:block; }

/* â”€â”€â”€ Attachments â”€â”€â”€ */
.att-dropzone{ border:1px dashed var(--border); border-radius:var(--r-md); padding:10px 14px; text-align:center; cursor:pointer; font-size:12px; color:var(--muted); transition:border-color .15s,background .15s; }
.att-dropzone:hover{ border-color:var(--accent); background:var(--abg); color:var(--text); }
.att-previews{ display:flex; flex-wrap:wrap; gap:6px; margin-top:7px; }
.att-chip{ display:inline-flex; align-items:center; gap:6px; background:var(--s2); border:1px solid var(--border); border-radius:20px; padding:3px 8px 3px 4px; font-size:11px; max-width:220px; }
.att-chip span{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--text); }
.att-chip button{ background:none; border:none; color:var(--muted); cursor:pointer; font-size:13px; line-height:1; padding:0; flex-shrink:0; }
.att-chip button:hover{ color:var(--red); }
.att-thumb{ width:22px; height:22px; object-fit:cover; border-radius:3px; flex-shrink:0; }
.att-icon{ font-size:16px; flex-shrink:0; }

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast{ position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:var(--s3); border:1px solid var(--border); color:var(--text); padding:9px 18px; border-radius:var(--r-md); font-size:13px; font-weight:500; z-index:9999; pointer-events:none; opacity:0; transition:opacity .2s; white-space:nowrap; box-shadow:var(--shadow); }
.toast.show{ opacity:1; }
</style>
</head>
<body>

<!-- Header -->
<div class="hdr">
  <div class="hdr-l">
    <div class="logo">CC</div>
    <nav class="nav-sw" aria-label="ĞĞ°Ğ²Ñ–Ğ³Ğ°Ñ†Ñ–Ñ Ğ¼Ñ–Ğ¶ Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ğ°Ğ¼Ğ¸">
      <a class="nav-sw-btn" href="/" data-tip="Ğ§Ğ°Ñ‚">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Chat
      </a>
      <a class="nav-sw-btn active" href="/kanban" data-tip="Kanban Ğ´Ğ¾ÑˆĞºĞ°">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="13" rx="1"/><rect x="17" y="3" width="5" height="9" rx="1"/></svg>
        Kanban
      </a>
    </nav>
    <div class="hdr-meta">
      <span class="status-dot ok" id="kbStatusEl">Connected</span>
      <span id="kbVersionBadge"></span>
    </div>
  </div>
  <div class="hdr-btns">
    <span class="refresh-ts" id="refreshTs" style="margin-right:4px"></span>
    <button class="hb" onclick="refresh(true)" id="refreshBtn">&#8635;</button>
    <button class="hb" onclick="openAddModal()" id="addBtn">&#xFF0B; <span id="addBtnLabel">Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°</span></button>
    <a class="hb" href="https://github.com/Lexus2016/claude-code-chat" target="_blank" rel="noopener">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.013-1.703-2.782.604-3.369-1.34-3.369-1.34-.454-1.154-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.115 2.504.337 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
    </a>
  </div>
</div>

<!-- Project selector bar -->
<div class="proj-bar">
  <span class="proj-label" id="projLabel">ĞŸÑ€Ğ¾ĞµĞºÑ‚:</span>
  <select class="proj-sel" id="projSel" onchange="onProjChange()">
    <option value="" id="allProjOpt">â€” Ğ’ÑÑ– Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸ â€”</option>
  </select>
  <span class="refresh-ts" id="refreshTs2"></span>
</div>

<!-- Board -->
<div class="board" id="board"></div>

<!-- Task modal -->
<div class="ov hidden" id="taskOv" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-hd">
      <span class="modal-hd-title" id="modalTitle"></span>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-ft" id="modalFt"></div>
  </div>
</div>

<!-- Confirm modal -->
<div class="ov hidden" id="confirmOv">
  <div class="modal" style="max-width:400px">
    <div class="modal-hd">
      <span class="modal-hd-title" id="confirmTitle"></span>
      <button class="modal-close" onclick="closeConfirm()">Ã—</button>
    </div>
    <div class="modal-body" id="confirmBody" style="gap:8px"></div>
    <div class="modal-ft">
      <button class="btn btn-ghost btn-sm" onclick="closeConfirm()" id="cancelBtn">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
      <button class="btn btn-danger btn-sm" id="confirmOkBtn">Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TR = {
  uk: {
    'hdr.title':'Kanban','hdr.add':'Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°',
    'proj.label':'ĞŸÑ€Ğ¾ĞµĞºÑ‚:','proj.all':'â€” Ğ’ÑÑ– Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸ â€”',
    'col.backlog':'Backlog','col.todo':'Ğ”Ğ¾ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ','col.in_progress':'Ğ’ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–',
    'col.done':'Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ¾','col.cancelled':'Ğ¡ĞºĞ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¾','col.empty':'ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ°Ğ´Ğ°Ñ‡',
    'modal.add':'ĞĞ¾Ğ²Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°','modal.edit':'Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ',
    'modal.name':'ĞĞ°Ğ·Ğ²Ğ° *','modal.status':'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ','modal.session':"ĞŸĞ¾Ğ²'ÑĞ·Ğ°Ğ½Ğ° ÑĞµÑÑ–Ñ",
    'modal.no_session':'â€” Ğ±ĞµĞ· ÑĞµÑÑ–Ñ— â€”','modal.new_session':'â• ĞĞ¾Ğ²Ğ° ÑĞµÑÑ–Ñ',
    'modal.desc':'ĞĞ¿Ğ¸Ñ','modal.notes':'ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸',
    'modal.attach':'Ğ’ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ½Ñ','modal.attach_hint':'ĞšĞ»Ñ–ĞºĞ½Ñ–Ñ‚ÑŒ Ğ°Ğ±Ğ¾ Ğ¿ĞµÑ€ĞµÑ‚ÑĞ³Ğ½Ñ–Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¸ (Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ, Ñ‚ĞµĞºÑÑ‚)',
    'modal.create':'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸','modal.save':'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸','modal.cancel':'Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸',
    'modal.delete':'Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸',
    'confirm.title':'Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ?','confirm.body':'Ğ¦Ñ Ğ´Ñ–Ñ Ğ½ĞµĞ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ğ°.',
    'confirm.ok':'Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸','confirm.cancel':'Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸',
    'chat.title':'Ğ§Ğ°Ñ‚ ÑĞµÑÑ–Ñ—','chat.empty':'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ','chat.open':'â†— Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ² Ñ‡Ğ°Ñ‚Ñ–',
    'toast.created':'âœ“ Ğ—Ğ°Ğ´Ğ°Ñ‡Ñƒ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾','toast.saved':'âœ“ Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾',
    'toast.deleted':'Ğ—Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ¾','toast.copied':'âœ“ ID ÑĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾',
    'toast.sess_created':'âœ“ Ğ¡ĞµÑÑ–Ñ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾','toast.err':'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ',
    'modal.new_sess_cfg':'ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— ÑĞµÑÑ–Ñ—',
    'tb.mode':'Ğ ĞµĞ¶Ğ¸Ğ¼','tb.agent':'ĞĞ³ĞµĞ½Ñ‚','tb.model':'ĞœĞ¾Ğ´ĞµĞ»ÑŒ','tb.turns':'ĞšÑ€Ğ¾ĞºĞ¸','tb.engine':'Ğ”Ğ²Ğ¸Ğ³ÑƒĞ½',
    'card.running':'Ğ’Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ñ‚ÑŒÑÑ','msg.you':'Ğ’Ğ¸','msg.tool':'Tool','refresh.now':'Ñ‰Ğ¾Ğ¹Ğ½Ğ¾',
    'card.retry':'â†© Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€',
    'time.min':'Ñ…Ğ²','time.hr':'Ğ³','time.day':'Ğ´',
  },
  en: {
    'hdr.title':'Kanban','hdr.add':'Task',
    'proj.label':'Project:','proj.all':'â€” All projects â€”',
    'col.backlog':'Backlog','col.todo':'To Do','col.in_progress':'In Progress',
    'col.done':'Done','col.cancelled':'Cancelled','col.empty':'No tasks',
    'modal.add':'New task','modal.edit':'Edit task',
    'modal.name':'Title *','modal.status':'Status','modal.session':'Linked session',
    'modal.no_session':'â€” no session â€”','modal.new_session':'â• New Session',
    'modal.desc':'Description','modal.notes':'Notes',
    'modal.attach':'Attachments','modal.attach_hint':'Click or drag files (images, text)',
    'modal.create':'Create','modal.save':'Save','modal.cancel':'Cancel',
    'modal.delete':'Delete',
    'confirm.title':'Delete task?','confirm.body':'This action is irreversible.',
    'confirm.ok':'Delete','confirm.cancel':'Cancel',
    'chat.title':'Session chat','chat.empty':'No messages','chat.open':'â†— Open in chat',
    'toast.created':'âœ“ Task created','toast.saved':'âœ“ Saved',
    'toast.deleted':'Task deleted','toast.copied':'âœ“ ID copied',
    'toast.sess_created':'âœ“ Session created automatically','toast.err':'Error: ',
    'modal.new_sess_cfg':'New session settings',
    'tb.mode':'Mode','tb.agent':'Agent','tb.model':'Model','tb.turns':'Turns','tb.engine':'Engine',
    'card.running':'Running','msg.you':'You','msg.tool':'Tool','refresh.now':'just now',
    'card.retry':'â†© retry',
    'time.min':'m','time.hr':'h','time.day':'d',
  },
  ru: {
    'hdr.title':'Kanban','hdr.add':'Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°',
    'proj.label':'ĞŸÑ€Ğ¾ĞµĞºÑ‚:','proj.all':'â€” Ğ’ÑĞµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹ â€”',
    'col.backlog':'Backlog','col.todo':'Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ','col.in_progress':'Ğ’ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ',
    'col.done':'Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾','col.cancelled':'ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾','col.empty':'ĞĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡',
    'modal.add':'ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°','modal.edit':'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ',
    'modal.name':'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *','modal.status':'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ','modal.session':'Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ',
    'modal.no_session':'â€” Ğ±ĞµĞ· ÑĞµÑÑĞ¸Ğ¸ â€”','modal.new_session':'â• ĞĞ¾Ğ²Ğ°Ñ ÑĞµÑÑĞ¸Ñ',
    'modal.desc':'ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ','modal.notes':'Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸',
    'modal.create':'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ','modal.save':'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ','modal.cancel':'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
    'modal.delete':'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ',
    'confirm.title':'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ?','confirm.body':'Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ğ¼Ğ¾.',
    'confirm.ok':'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ','confirm.cancel':'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
    'chat.title':'Ğ§Ğ°Ñ‚ ÑĞµÑÑĞ¸Ğ¸','chat.empty':'ĞĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹','chat.open':'â†— ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ² Ñ‡Ğ°Ñ‚Ğµ',
    'toast.created':'âœ“ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°','toast.saved':'âœ“ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾',
    'toast.deleted':'Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°','toast.copied':'âœ“ ID ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½',
    'toast.sess_created':'âœ“ Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸','toast.err':'ĞÑˆĞ¸Ğ±ĞºĞ°: ',
    'modal.new_sess_cfg':'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸',
    'modal.attach':'Ğ’Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ','modal.attach_hint':'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ (Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ, Ñ‚ĞµĞºÑÑ‚)',
    'tb.mode':'Ğ ĞµĞ¶Ğ¸Ğ¼','tb.agent':'ĞĞ³ĞµĞ½Ñ‚','tb.model':'ĞœĞ¾Ğ´ĞµĞ»ÑŒ','tb.turns':'Ğ¨Ğ°Ğ³Ğ¸','tb.engine':'Ğ”Ğ²Ğ¸Ğ¶Ğ¾Ğº',
    'card.running':'Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ','msg.you':'Ğ’Ñ‹','msg.tool':'Tool','refresh.now':'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾',
    'card.retry':'â†© Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€',
    'time.min':'Ğ¼','time.hr':'Ñ‡','time.day':'Ğ´',
  },
};
const lang = localStorage.getItem('lang') || 'uk';
function t(k){ return (TR[lang]||TR.uk)[k] || k; }

document.title = t('hdr.title') + ' â€” Claude Code Chat';
fetch('/api/version').then(r=>r.json()).then(d=>{
  const el=document.getElementById('kbVersionBadge');
  if(el&&d.version) el.textContent='Claude Code Chat v'+d.version;
}).catch(()=>{});
document.getElementById('addBtnLabel').textContent=t('hdr.add');
document.getElementById('projLabel').textContent=t('proj.label');
document.getElementById('allProjOpt').textContent=t('proj.all');
document.getElementById('cancelBtn').textContent=t('confirm.cancel');
document.getElementById('confirmOkBtn').textContent=t('confirm.ok');

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS=[
  {id:'backlog',dot:'dot-backlog'},
  {id:'todo',dot:'dot-todo'},
  {id:'in_progress',dot:'dot-in_progress'},
  {id:'done',dot:'dot-done'},
  {id:'cancelled',dot:'dot-cancelled'},
];
let tasks=[],sessions=[],projects=[];
let curWorkdir=null,lastEtag='',refreshTimer=null,modalMode=null,editingId=null,dragSrcId=null;
let pendingAttachments=[]; // [{name, type, base64}]

// â”€â”€â”€ Session settings (persisted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let kbSettings={mode:'auto',agent_mode:'single',model:'sonnet',max_turns:30};
try{
  const _ks=JSON.parse(localStorage.getItem('kanban_sess_cfg')||'null');
  if(_ks&&typeof _ks==='object') kbSettings={...kbSettings,..._ks};
}catch{}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escH(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function $i(id){return document.getElementById(id);}
function relTime(iso){
  if(!iso)return'';
  const s=Math.round((Date.now()-new Date(iso.endsWith('Z')?iso:iso+'Z'))/1000);
  if(s<60)return t('refresh.now');
  if(s<3600)return Math.floor(s/60)+t('time.min');
  if(s<86400)return Math.floor(s/3600)+t('time.hr');
  return Math.floor(s/86400)+t('time.day');
}
function toast(msg,err=false){
  const el=$i('toast');
  el.textContent=msg;
  el.style.background=err?'rgba(248,81,73,.15)':'';
  el.style.borderColor=err?'var(--red)':'';
  el.classList.add('show');
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),2500);
}

async function apiFetch(url,opts={}){
  const r=await fetch(url,opts);
  if(r.status===401){location.href='/login';throw new Error('401');}
  return r;
}

// â”€â”€â”€ Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProjects(){
  try{const r=await apiFetch('/api/projects');projects=await r.json();}catch{projects=[];}
  const sel=$i('projSel');
  while(sel.options.length>1)sel.remove(1);
  for(const p of projects){
    const opt=document.createElement('option');
    opt.value=p.workdir||p.id;
    opt.textContent=p.name||p.workdir||p.id;
    opt.dataset.workdir=p.workdir||'';
    sel.appendChild(opt);
  }
  try{
    const s=JSON.parse(localStorage.getItem('cc_ui_state')||'null');
    if(s?.curWorkdir){
      const opts=[...sel.options];
      const found=opts.find(o=>o.value===s.curWorkdir||o.dataset.workdir===s.curWorkdir);
      if(found)sel.value=found.value;
    }
  }catch{}
  onProjChange(false);
}
function onProjChange(doRefresh=true){
  const sel=$i('projSel');
  const opt=sel.options[sel.selectedIndex];
  curWorkdir=opt?.value||null;
  if(doRefresh)refresh(true);
}

// â”€â”€â”€ Data fetching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTasks(){
  const qs=curWorkdir?'?workdir='+encodeURIComponent(curWorkdir):'';
  return(await apiFetch('/api/tasks'+qs)).json();
}
async function fetchSessions(){
  const qs=curWorkdir?'?workdir='+encodeURIComponent(curWorkdir):'';
  return(await apiFetch('/api/sessions'+qs)).json();
}
async function fetchEtag(){
  const d=await(await apiFetch('/api/tasks/etag')).json();
  return d.ts+'|'+d.n;
}
async function fetchMessages(sessId){
  const d=await(await apiFetch(`/api/sessions/${sessId}/messages?limit=30&offset=0`)).json();
  return d.messages||[];
}

async function refresh(force=false){
  const btn=$i('refreshBtn');
  btn.innerHTML='<span class="spinning"></span>';
  try{
    const etag=await fetchEtag();
    if(!force&&etag===lastEtag)return;
    const[newTasks,newSessions]=await Promise.all([fetchTasks(),fetchSessions()]);
    tasks=newTasks;sessions=newSessions;lastEtag=etag;
    renderBoard();
    const ts=new Date().toLocaleTimeString(lang==='uk'?'uk-UA':lang==='ru'?'ru-RU':'en-GB',{hour:'2-digit',minute:'2-digit'});
    $i('refreshTs').textContent=ts;
    $i('refreshTs2').textContent=ts;
  }catch(e){if(e.message!=='401')toast(t('toast.err')+e.message,true);}
  finally{btn.innerHTML='&#8635;';}
}
function startAutoRefresh(){
  clearTimeout(refreshTimer);
  const hasActive=tasks.some(t=>t.status==='in_progress'||t.status==='todo');
  const delay=hasActive?5000:30000;
  refreshTimer=setTimeout(async()=>{await refresh(false);startAutoRefresh();},delay);
}

// â”€â”€â”€ Board Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard(){
  const board=$i('board');board.innerHTML='';
  for(const col of COLS){
    const colTasks=tasks.filter(tk=>tk.status===col.id).sort((a,b)=>a.sort_order-b.sort_order);
    board.appendChild(makeColumn(col,colTasks));
  }
}
function makeColumn(col,colTasks){
  const el=document.createElement('div');el.className='col';
  const hd=document.createElement('div');hd.className='col-head';
  hd.innerHTML=`<div class="col-dot ${col.dot}"></div><span class="col-title">${escH(t('col.'+col.id))}</span><span class="col-cnt">${colTasks.length}</span>`;
  el.appendChild(hd);
  const body=document.createElement('div');body.className='col-body';body.dataset.status=col.id;
  setupDropZone(body);
  if(colTasks.length===0){
    const empty=document.createElement('div');empty.className='col-empty';empty.textContent=t('col.empty');body.appendChild(empty);
  }else{
    for(const tk of colTasks)body.appendChild(makeCard(tk));
  }
  el.appendChild(body);
  const addBtn=document.createElement('button');addBtn.className='col-add';
  addBtn.textContent='ï¼‹ '+t('hdr.add');addBtn.onclick=()=>openAddModal(col.id);
  el.appendChild(addBtn);
  return el;
}
function makeCard(tk){
  const el=document.createElement('div');el.className='card';el.dataset.id=tk.id;el.draggable=true;
  let sessBadge='';
  if(tk.status==='in_progress'){
    sessBadge=`<span class="badge badge-orange"><span class="spinning" style="width:10px;height:10px;border-width:1.5px"></span> ${escH(t('card.running'))}</span>`;
  }else if(tk.session_id){
    sessBadge=`<span class="badge badge-accent">ğŸ’¬ ${escH(tk.sess_title||'session')}</span>`;
  }
  const modelBadge=tk.sess_model?`<span class="badge badge-muted">${escH(tk.sess_model)}</span>`:'';
  const retryBadge=tk.retry_count>0?`<span class="badge badge-muted" title="${tk.retry_count} restart(s)">${escH(t('card.retry'))} Ã—${tk.retry_count}</span>`:'';
  el.innerHTML=`
    <div class="card-title">${escH(tk.title)}</div>
    ${tk.description?`<div class="card-desc">${escH(tk.description)}</div>`:''}
    <div class="card-foot">
      ${sessBadge}${modelBadge}${retryBadge}
      <span class="card-time">${relTime(tk.updated_at)}</span>
      <span class="card-actions">
        <button class="cbtn" title="${t('modal.edit')}" onclick="event.stopPropagation();openEditModal('${tk.id}')">âœ</button>
        <button class="cbtn" title="${t('modal.delete')}" onclick="event.stopPropagation();confirmDelete('${tk.id}')">âœ•</button>
      </span>
    </div>`;
  el.onclick=()=>openEditModal(tk.id);
  el.addEventListener('dragstart',e=>{
    dragSrcId=tk.id;el.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',tk.id);
  });
  el.addEventListener('dragend',()=>{
    el.classList.remove('dragging');
    document.querySelectorAll('.col-body.dz').forEach(z=>z.classList.remove('dz'));
    document.querySelectorAll('.card-ph').forEach(p=>p.remove());
  });
  return el;
}

// â”€â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDropZone(el){
  el.addEventListener('dragover',e=>{
    e.preventDefault();e.dataTransfer.dropEffect='move';el.classList.add('dz');
    const after=getDragAfter(el,e.clientY);
    document.querySelectorAll('.card-ph').forEach(p=>p.remove());
    const ph=document.createElement('div');ph.className='card-ph';ph.style.height='52px';
    if(after)el.insertBefore(ph,after);else el.appendChild(ph);
  });
  el.addEventListener('dragleave',e=>{
    if(!el.contains(e.relatedTarget)){
      el.classList.remove('dz');document.querySelectorAll('.card-ph').forEach(p=>p.remove());
    }
  });
  el.addEventListener('drop',async e=>{
    e.preventDefault();el.classList.remove('dz');
    document.querySelectorAll('.card-ph').forEach(p=>p.remove());
    const id=e.dataTransfer.getData('text/plain')||dragSrcId;
    if(!id)return;
    const newStatus=el.dataset.status;
    const cards=[...el.querySelectorAll('.card[data-id]')];
    const afterEl=getDragAfter(el,e.clientY);
    let sort_order;
    if(afterEl){
      const afterTk=tasks.find(tk=>tk.id===afterEl.dataset.id);
      const idx=cards.indexOf(afterEl);
      const prevEl=cards[idx-1];
      const prevTk=prevEl?tasks.find(tk=>tk.id===prevEl.dataset.id):null;
      sort_order=((prevTk?.sort_order||0)+(afterTk?.sort_order||0))/2;
    }else{
      const last=cards[cards.length-1];
      const lastTk=last?tasks.find(tk=>tk.id===last.dataset.id):null;
      sort_order=(lastTk?.sort_order||0)+1000;
    }
    try{
      const task=tasks.find(tk=>tk.id===id);
      let session_id=task?.session_id||null;
      if(newStatus==='in_progress'&&!session_id){
        const sessR=await apiFetch('/api/sessions',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title:task?.title||t('col.todo'),workdir:curWorkdir||null,
            model:task?.model||kbSettings.model,mode:task?.mode||kbSettings.mode,agentMode:task?.agent_mode||kbSettings.agent_mode})});
        const sess=await sessR.json();
        session_id=sess.id;
        toast(t('toast.sess_created'));
      }
      await apiFetch(`/api/tasks/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({status:newStatus,sort_order,session_id:session_id||undefined})});
      await refresh(true);
    }catch(err){if(err.message!=='401')toast(t('toast.err')+err.message,true);}
  });
}
function getDragAfter(container,y){
  const els=[...container.querySelectorAll('.card:not(.dragging):not(.card-ph)')];
  return els.reduce((cl,el)=>{
    const box=el.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0&&offset>cl.offset)return{offset,el};
    return cl;
  },{offset:-Infinity,el:null}).el;
}

// â”€â”€â”€ Modal: Add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal(defaultStatus='backlog'){
  modalMode='add';editingId=null;pendingAttachments=[];
  $i('modalTitle').textContent=t('modal.add');
  $i('modalBody').innerHTML=buildForm({status:defaultStatus,...kbSettings});
  $i('modalFt').innerHTML=`
    <button class="btn btn-ghost btn-sm" onclick="closeModal()">${t('modal.cancel')}</button>
    <button class="btn btn-primary btn-sm" onclick="saveTask()">${t('modal.create')}</button>`;
  $i('taskOv').classList.remove('hidden');
  setTimeout(()=>$i('fTitle')?.focus(),60);
}

// â”€â”€â”€ Modal: Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openEditModal(id){
  const tk=tasks.find(x=>x.id===id);
  if(!tk)return;
  modalMode='edit';editingId=id;
  try{pendingAttachments=tk.attachments?JSON.parse(tk.attachments):[];}catch{pendingAttachments=[];}
  $i('modalTitle').textContent=t('modal.edit');
  $i('modalBody').innerHTML=buildForm(tk);
  setTimeout(()=>renderAttPreviews(),0);
  $i('modalFt').innerHTML=`
    <button class="btn btn-danger btn-sm" onclick="confirmDelete('${id}');closeModal()">${t('modal.delete')}</button>
    <div style="flex:1"></div>
    <button class="btn btn-ghost btn-sm" onclick="closeModal()">${t('modal.cancel')}</button>
    <button class="btn btn-primary btn-sm" onclick="saveTask()">${t('modal.save')}</button>`;
  $i('taskOv').classList.remove('hidden');
  if(tk.session_id){
    try{
      const msgs=await fetchMessages(tk.session_id);
      const chatHtml=buildChatPanel(tk,msgs);
      const body=$i('modalBody');
      if(body&&!$i('taskOv').classList.contains('hidden')){
        const div=document.createElement('div');div.innerHTML=chatHtml;body.appendChild(div.firstElementChild);
      }
    }catch{}
  }
  setTimeout(()=>$i('fTitle')?.focus(),60);
}

function buildForm(tk={}){
  const isNew=!tk.id;
  const m=tk.mode||kbSettings.mode||'auto', ag=tk.agent_mode||kbSettings.agent_mode||'single', mdl=tk.model||kbSettings.model||'sonnet', eng=tk.engine||kbSettings.engine||'cli';
  const statusOpts=COLS.map(c=>`<option value="${c.id}"${tk.status===c.id?' selected':''}>${escH(t('col.'+c.id))}</option>`).join('');
  const sessOpts=`<option value="">${escH(isNew?t('modal.new_session'):t('modal.no_session'))}</option>`+
    sessions.map(s=>`<option value="${s.id}"${tk.session_id===s.id?' selected':''}>${escH((s.title||s.id).substring(0,60))}</option>`).join('');
  const visClass=!tk.session_id?' visible':'';
  return `
    <div><label class="lbl">${t('modal.name')}</label>
      <input id="fTitle" class="inp" placeholder="${t('modal.name')}" value="${escH(tk.title||'')}" maxlength="200">
    </div>
    <div class="grid2">
      <div><label class="lbl">${t('modal.status')}</label><select id="fStatus" class="sel">${statusOpts}</select></div>
      <div><label class="lbl">${t('modal.session')}</label><select id="fSession" class="sel" onchange="onFSessionChange()">${sessOpts}</select></div>
    </div>
    <div id="newSessCfg" class="new-sess-cfg${visClass}">
      <div class="new-sess-hdr">${t('modal.new_sess_cfg')}</div>
      <div class="sc-row">
        <div class="sc-seg" data-group="mode">
          <span class="sc-lbl">${t('tb.mode')}</span>
          <button type="button" class="sc-btn${m==='auto'?' on':''}" data-v="auto" onclick="scOpt(this)">Auto</button>
          <button type="button" class="sc-btn${m==='planning'?' on':''}" data-v="planning" onclick="scOpt(this)">Plan</button>
          <button type="button" class="sc-btn${m==='task'?' on':''}" data-v="task" onclick="scOpt(this)">Task</button>
        </div>
        <div class="sc-sep"></div>
        <div class="sc-seg" data-group="agent">
          <span class="sc-lbl">${t('tb.agent')}</span>
          <button type="button" class="sc-btn${ag==='single'?' on':''}" data-v="single" onclick="scOpt(this)">Single</button>
          <button type="button" class="sc-btn${ag==='multi'?' on':''}" data-v="multi" onclick="scOpt(this)">Multi</button>
        </div>
        <div class="sc-sep"></div>
        <div class="sc-seg" data-group="model">
          <span class="sc-lbl">${t('tb.model')}</span>
          <button type="button" class="sc-btn${mdl==='haiku'?' on':''}" data-v="haiku" onclick="scOpt(this)">Haiku</button>
          <button type="button" class="sc-btn${mdl==='sonnet'?' on':''}" data-v="sonnet" onclick="scOpt(this)">Sonnet</button>
          <button type="button" class="sc-btn${mdl==='opus'?' on':''}" data-v="opus" onclick="scOpt(this)">Opus</button>
        </div>
        <div class="sc-sep"></div>
        <div class="sc-seg">
          <span class="sc-lbl">${t('tb.turns')}</span>
          <input type="number" class="sc-turns" id="fMaxTurns" value="${tk.max_turns||kbSettings.max_turns||30}" min="1" max="100" oninput="kbSettings.max_turns=+this.value||30;try{localStorage.setItem('kanban_sess_cfg',JSON.stringify(kbSettings));}catch{}">
        </div>
      </div>
    </div>
    <div><label class="lbl">${t('modal.desc')}</label>
      <textarea id="fDesc" class="inp" rows="3" placeholder="â€¦" maxlength="2000">${escH(tk.description||'')}</textarea>
    </div>
    <div><label class="lbl">${t('modal.notes')}</label>
      <textarea id="fNotes" class="inp" rows="2" placeholder="â€¦" maxlength="2000">${escH(tk.notes||'')}</textarea>
    </div>
    <div>
      <label class="lbl">${t('modal.attach')}</label>
      <input type="file" id="fAttachments" multiple accept="image/*,.txt,.md,.json,.csv,.log,.py,.js,.ts,.html,.css" style="display:none" onchange="onFileSelect(event)">
      <div class="att-dropzone" onclick="$i('fAttachments').click()" ondragover="event.preventDefault()" ondrop="onFileDrop(event)">${t('modal.attach_hint')}</div>
      <div class="att-previews" id="attPreviews"></div>
    </div>`;
}

// â”€â”€â”€ Attachment helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_ATT_SIZE=5*1024*1024; // 5 MB per file
const MAX_ATT_COUNT=10;
function onFileSelect(e){processFiles(Array.from(e.target.files));e.target.value='';}
function onFileDrop(e){e.preventDefault();processFiles(Array.from(e.dataTransfer.files));}
function processFiles(files){
  for(const f of files){
    if(pendingAttachments.length>=MAX_ATT_COUNT){toast(t('modal.attach_hint'),true);break;}
    if(f.size>MAX_ATT_SIZE){toast(`${f.name}: >5MB`,true);continue;}
    const r=new FileReader();
    r.onload=ev=>{
      const b64=ev.target.result.split(',')[1];
      if(!b64)return;
      pendingAttachments.push({name:f.name,type:f.type||'application/octet-stream',base64:b64});
      renderAttPreviews();
    };
    r.readAsDataURL(f);
  }
}
function removeAtt(i){pendingAttachments.splice(i,1);renderAttPreviews();}
function renderAttPreviews(){
  const el=$i('attPreviews');
  if(!el)return;
  el.innerHTML=pendingAttachments.map((a,i)=>`
    <div class="att-chip">
      ${a.type.startsWith('image/')?`<img class="att-thumb" src="data:${a.type};base64,${a.base64}">`:'<span class="att-icon">ğŸ“„</span>'}
      <span title="${escH(a.name)}">${escH(a.name.length>28?a.name.slice(0,25)+'â€¦':a.name)}</span>
      <button onclick="removeAtt(${i})">âœ•</button>
    </div>`).join('');
}

// â”€â”€â”€ Session config helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scOpt(btn){
  const grp=btn.closest('.sc-seg');
  if(!grp)return;
  grp.querySelectorAll('.sc-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const g=grp.dataset.group;
  if(g==='agent')kbSettings.agent_mode=btn.dataset.v;
  else if(g)kbSettings[g]=btn.dataset.v;
  try{localStorage.setItem('kanban_sess_cfg',JSON.stringify(kbSettings));}catch{}
}
function onFSessionChange(){
  const hasSess=!!$i('fSession')?.value;
  const cfg=$i('newSessCfg');
  if(cfg)cfg.classList.toggle('visible',!hasSess);
}
function getSessCfg(){
  const defaults={model:'sonnet',mode:'auto',agent:'single',engine:'cli',maxTurns:30};
  const cfg=$i('newSessCfg');
  if(!cfg)return defaults;
  const result={};
  cfg.querySelectorAll('.sc-seg[data-group]').forEach(grp=>{
    const on=grp.querySelector('.sc-btn.on');
    if(on)result[grp.dataset.group]=on.dataset.v;
  });
  result.maxTurns=parseInt($i('fMaxTurns')?.value||30);
  return{...defaults,...result};
}

function buildChatPanel(tk,msgs){
  const sessTitle=escH(tk.sess_title||tk.session_id);
  const claudeId=tk.claude_session_id||'';
  const openUrl=`/?open_session=${encodeURIComponent(tk.session_id)}`;
  let msgsHtml;
  if(!msgs.length){
    msgsHtml=`<div class="chat-empty">${t('chat.empty')}</div>`;
  }else{
    msgsHtml=msgs.map(m=>{
      const role=m.role==='user'?'user':m.type==='tool'?'tool':'assistant';
      const label=role==='user'?t('msg.you'):role==='tool'?`${t('msg.tool')}: ${escH(m.tool_name||'')}`:'Claude';
      const text=escH((m.content||'').substring(0,300));
      return `<div class="chat-msg"><div class="chat-role ${role}">${label}</div><div class="chat-text">${text}</div></div>`;
    }).join('');
  }
  const copyBtn=claudeId?`<span class="mono-tag" title="Click to copy" onclick="navigator.clipboard.writeText('${escH(claudeId)}').then(()=>toast(t('toast.copied')))">${claudeId.slice(0,12)}â€¦</span>`:'';
  const openBtn=`<a class="open-link" href="${openUrl}" target="_blank">${t('chat.open')}</a>`;
  return `<div class="chat-panel">
    <div class="chat-panel-hd">
      <span>${t('chat.title')}: ${sessTitle}</span>
      <div class="sess-info">${copyBtn}${openBtn}</div>
    </div>
    <div class="chat-panel-body">${msgsHtml}</div>
  </div>`;
}

// â”€â”€â”€ Save task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveTask(){
  const title=($i('fTitle')?.value||'').trim();
  if(!title){toast(t('modal.name'),true);$i('fTitle')?.focus();return;}
  let session_id=$i('fSession')?.value||null;
  const cfg=getSessCfg();
  const existingTask=editingId?tasks.find(t=>t.id===editingId):null;
  const body={
    title,
    description:$i('fDesc')?($i('fDesc').value||''):(existingTask?.description||''),
    notes:$i('fNotes')?($i('fNotes').value||''):(existingTask?.notes||''),
    status:$i('fStatus')?.value||'backlog',
    session_id,
    workdir:curWorkdir||null,
    model:cfg.model,
    mode:cfg.mode,
    agent_mode:cfg.agent,
    max_turns:cfg.maxTurns,
    attachments:pendingAttachments.length?JSON.stringify(pendingAttachments):null,
  };
  try{
    if(modalMode==='add'){
      if(!session_id){
        const sessR=await apiFetch('/api/sessions',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title,workdir:curWorkdir||null,model:cfg.model,engine:cfg.engine,mode:cfg.mode,agentMode:cfg.agent,maxTurns:cfg.maxTurns})});
        const sess=await sessR.json();
        session_id=sess.id;
        body.session_id=session_id;
        toast(t('toast.sess_created'));
      }
      const colTasks=tasks.filter(tk=>tk.status===body.status);
      body.sort_order=colTasks.length?Math.max(...colTasks.map(tk=>tk.sort_order))+1000:0;
      await apiFetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      toast(t('toast.created'));
    }else{
      const orig=tasks.find(tk=>tk.id===editingId);
      if(orig)body.sort_order=orig.sort_order;
      await apiFetch(`/api/tasks/${editingId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      toast(t('toast.saved'));
    }
    closeModal();
    await refresh(true);
  }catch(e){if(e.message!=='401')toast(t('toast.err')+e.message,true);}
}

// â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmDelete(id){
  const tk=tasks.find(x=>x.id===id);
  $i('confirmTitle').textContent=t('confirm.title');
  $i('confirmBody').innerHTML=`<p style="font-size:14px;color:var(--text)">Â«${escH(tk?.title||id)}Â»</p><p style="font-size:12px;color:var(--muted);margin-top:6px">${t('confirm.body')}</p>`;
  $i('confirmOkBtn').onclick=async()=>{
    try{
      await apiFetch(`/api/tasks/${id}`,{method:'DELETE'});
      toast(t('toast.deleted'));closeConfirm();await refresh(true);
    }catch(e){if(e.message!=='401')toast(t('toast.err')+e.message,true);}
  };
  $i('confirmOv').classList.remove('hidden');
}
function closeConfirm(){$i('confirmOv').classList.add('hidden');}
function closeModal(){$i('taskOv').classList.add('hidden');}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(!$i('taskOv').classList.contains('hidden')){closeModal();return;}
    if(!$i('confirmOv').classList.contains('hidden')){closeConfirm();return;}
  }
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'&&!$i('taskOv').classList.contains('hidden'))saveTask();
});

(async()=>{
  await loadProjects();
  await refresh(true);
  startAutoRefresh();
  try{
    const bc=new BroadcastChannel('kanban');
    bc.onmessage=e=>{if(e.data?.type==='session_deleted')refresh(true);};
  }catch{}
})();
</script>
</body>
</html>
