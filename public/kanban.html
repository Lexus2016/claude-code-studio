<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kanban â€” Claude Code Chat</title>
<style>
:root {
  --bg:#0d0d0d; --s1:#111; --s2:#1a1a1a; --s3:#242424; --s4:#2c2c2c;
  --border:#2a2a2a; --border2:#333;
  --text:#e8e8e8; --text-dim:#888; --muted:#555;
  --accent:#7c6af7; --accent2:rgba(124,106,247,.15);
  --green:#22c55e; --green2:rgba(34,197,94,.15);
  --red:#ef4444; --red2:rgba(239,68,68,.12);
  --warn:#f59e0b; --warn2:rgba(245,158,11,.15);
  --blue:#3b82f6; --blue2:rgba(59,130,246,.15);
  --scrollbar:#2a2a2a; --scrollbar-thumb:#3a3a3a;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;font-size:14px;display:flex;flex-direction:column}

/* Scrollbars */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scrollbar-thumb);border-radius:3px}

/* â”€â”€ Header â”€â”€ */
.hdr{display:flex;align-items:center;gap:12px;padding:9px 20px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;min-height:48px}
.hdr-logo{font-weight:700;font-size:15px;color:var(--text);text-decoration:none;letter-spacing:-.3px}
.hdr-sep{color:var(--muted);font-size:13px}
.hdr-title{font-size:14px;font-weight:600;color:var(--text)}
.hdr-sp{flex:1}
.refresh-ts{font-size:11px;color:var(--muted)}
.spinning{display:inline-block;width:12px;height:12px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:7px;border:none;cursor:pointer;font-size:13px;font-family:inherit;transition:opacity .1s,background .1s;white-space:nowrap}
.btn:hover{opacity:.88}
.btn-primary{background:var(--accent);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--text-dim)}
.btn-ghost:hover{color:var(--text);background:var(--s2);border-color:var(--muted)}
.btn-danger{background:transparent;border:1px solid var(--red);color:var(--red)}
.btn-danger:hover{background:var(--red2)}
.btn-sm{padding:3px 9px;font-size:12px;border-radius:5px}

/* â”€â”€ Board â”€â”€ */
.board{display:flex;gap:14px;padding:16px 20px 20px;overflow-x:auto;flex:1;align-items:flex-start}

/* â”€â”€ Column â”€â”€ */
.col{flex-shrink:0;width:272px;display:flex;flex-direction:column;max-height:100%}
.col-head{display:flex;align-items:center;gap:8px;padding:8px 10px;margin-bottom:8px;border-radius:8px;background:var(--s2);border:1px solid var(--border)}
.col-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.col-title{font-weight:600;font-size:13px;flex:1}
.col-cnt{background:var(--s3);color:var(--text-dim);font-size:11px;padding:1px 7px;border-radius:10px;min-width:20px;text-align:center}
.col-body{display:flex;flex-direction:column;gap:8px;overflow-y:auto;flex:1;padding:2px 2px 2px;min-height:80px;border-radius:8px;transition:background .12s,outline .12s}
.col-body.dz{background:var(--accent2);outline:2px dashed var(--accent);outline-offset:2px}
.col-add{margin-top:8px;padding:7px;border-radius:7px;border:1px dashed var(--border2);background:transparent;color:var(--muted);cursor:pointer;font-size:12px;text-align:center;transition:.12s;font-family:inherit}
.col-add:hover{background:var(--s2);color:var(--text);border-color:var(--muted)}
.col-empty{text-align:center;padding:24px 10px;color:var(--muted);font-size:12px;border:1px dashed var(--border);border-radius:8px;user-select:none}

/* Status dot colours */
.dot-backlog{background:var(--muted)}
.dot-todo{background:var(--blue)}
.dot-in_progress{background:var(--warn)}
.dot-done{background:var(--green)}
.dot-cancelled{background:var(--red)}

/* â”€â”€ Card â”€â”€ */
.card{background:var(--s2);border:1px solid var(--border2);border-radius:9px;padding:11px 13px;cursor:grab;user-select:none;transition:box-shadow .15s,border-color .15s,transform .1s}
.card:hover{border-color:var(--muted);box-shadow:0 3px 14px rgba(0,0,0,.45)}
.card.dragging{opacity:.45;cursor:grabbing;transform:scale(.97)}
.card.drag-placeholder{background:rgba(124,106,247,.06);border:2px dashed var(--accent);opacity:.6}
.card-title{font-size:13px;font-weight:500;line-height:1.45;margin-bottom:5px;word-break:break-word}
.card-desc{font-size:11.5px;color:var(--text-dim);line-height:1.5;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word}
.card-footer{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.badge{font-size:10.5px;padding:1.5px 6px;border-radius:4px;white-space:nowrap}
.badge-muted{background:var(--s3);color:var(--text-dim)}
.badge-accent{background:var(--accent2);color:var(--accent)}
.badge-green{background:var(--green2);color:var(--green)}
.badge-warn{background:var(--warn2);color:var(--warn)}
.card-time{font-size:10px;color:var(--muted);margin-left:auto}
.card-actions{display:none;gap:3px;margin-left:auto}
.card:hover .card-actions{display:flex}
.card-actions .card-time{display:none}
.card:hover .card-time{display:none}
.cbtn{background:none;border:none;cursor:pointer;color:var(--muted);padding:2px 5px;border-radius:4px;font-size:12px;line-height:1}
.cbtn:hover{color:var(--text);background:var(--s3)}

/* â”€â”€ Modal overlay â”€â”€ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:200;padding:16px}
.ov.hidden{display:none}

/* â”€â”€ Task modal â”€â”€ */
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:13px;width:100%;max-width:700px;max-height:92vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.modal-hd{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-hd-title{font-size:15px;font-weight:600;flex:1}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;padding:2px 6px;border-radius:5px;line-height:1}
.modal-close:hover{color:var(--text);background:var(--s2)}
.modal-body{padding:20px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:14px}
.modal-ft{padding:13px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0}

.lbl{font-size:11.5px;color:var(--text-dim);font-weight:500;margin-bottom:5px;display:block}
.inp{background:var(--s2);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-size:13px;padding:8px 12px;width:100%;font-family:inherit;transition:border-color .15s}
.inp:focus{outline:none;border-color:var(--accent)}
textarea.inp{resize:vertical;min-height:80px}
.sel{background:var(--s2);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-size:13px;padding:8px 12px;width:100%;cursor:pointer;font-family:inherit}
.sel:focus{outline:none;border-color:var(--accent)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* â”€â”€ Chat history panel â”€â”€ */
.chat-panel{border:1px solid var(--border);border-radius:8px;overflow:hidden}
.chat-panel-hd{padding:9px 14px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:12px;font-weight:600;color:var(--text-dim)}
.chat-panel-body{max-height:300px;overflow-y:auto}
.chat-msg{padding:9px 14px;border-bottom:1px solid var(--border)}
.chat-msg:last-child{border-bottom:none}
.chat-role{font-size:10px;font-weight:700;text-transform:uppercase;margin-bottom:3px;letter-spacing:.5px}
.chat-role.user{color:var(--blue)}
.chat-role.assistant{color:var(--accent)}
.chat-role.tool{color:var(--warn)}
.chat-text{font-size:12px;line-height:1.55;color:var(--text);white-space:pre-wrap;word-break:break-word;max-height:120px;overflow:hidden}
.chat-text.long::after{content:'';display:block;height:24px;background:linear-gradient(transparent,var(--s1));margin-top:-24px;pointer-events:none}
.chat-empty{padding:20px;text-align:center;color:var(--muted);font-size:12px}
.chat-open-link{display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--accent);text-decoration:none;padding:3px 8px;border-radius:5px;border:1px solid var(--accent2)}
.chat-open-link:hover{background:var(--accent2)}
.sess-info{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.sess-id-mono{font-family:monospace;font-size:11px;color:var(--text-dim);background:var(--s2);padding:2px 7px;border-radius:4px;cursor:pointer;border:1px solid var(--border)}
.sess-id-mono:hover{border-color:var(--muted);color:var(--text)}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--s3);border:1px solid var(--border2);color:var(--text);padding:9px 18px;border-radius:8px;font-size:13px;z-index:999;pointer-events:none;opacity:0;transition:opacity .2s;white-space:nowrap}
.toast.show{opacity:1}

/* â”€â”€ Confirm dialog â”€â”€ */
.confirm-body{padding:20px 20px 0;font-size:14px;line-height:1.6;color:var(--text-dim)}
.confirm-title{font-size:15px;font-weight:600;color:var(--text);margin-bottom:8px}
</style>
</head>
<body>

<!-- Header -->
<div class="hdr">
  <a href="/" class="hdr-logo">CC</a>
  <span class="hdr-sep">/</span>
  <span class="hdr-title">Kanban</span>
  <div class="hdr-sp"></div>
  <span class="refresh-ts" id="refreshTs">â€”</span>
  <button class="btn btn-ghost btn-sm" onclick="refresh(true)" id="refreshBtn">â†» Refresh</button>
  <button class="btn btn-primary btn-sm" onclick="openAddModal()">ï¼‹ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°</button>
</div>

<!-- Board -->
<div class="board" id="board"></div>

<!-- Task modal -->
<div class="ov hidden" id="taskOv" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-hd">
      <span class="modal-hd-title" id="modalTitle">Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°</span>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-ft" id="modalFt"></div>
  </div>
</div>

<!-- Confirm modal -->
<div class="ov hidden" id="confirmOv">
  <div class="modal" style="max-width:420px">
    <div class="modal-hd">
      <span class="modal-hd-title" id="confirmTitle">ĞŸÑ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¶ĞµĞ½Ğ½Ñ</span>
      <button class="modal-close" onclick="closeConfirm()">Ã—</button>
    </div>
    <div class="confirm-body" id="confirmBody"></div>
    <div class="modal-ft">
      <button class="btn btn-ghost btn-sm" onclick="closeConfirm()">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
      <button class="btn btn-danger btn-sm" id="confirmOkBtn">Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = [
  { id:'backlog',     label:'Backlog',       dot:'dot-backlog'     },
  { id:'todo',        label:'To Do',         dot:'dot-todo'        },
  { id:'in_progress', label:'In Progress',   dot:'dot-in_progress' },
  { id:'done',        label:'Done',          dot:'dot-done'        },
  { id:'cancelled',   label:'Cancelled',     dot:'dot-cancelled'   },
];

let tasks = [];
let sessions = [];
let lastEtag = '';
let refreshTimer = null;
let modalMode = null; // 'add' | 'edit'
let editingTaskId = null;
let dragSrcId = null;

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function $i(id){ return document.getElementById(id); }
function relTime(iso){
  if(!iso) return '';
  const d = new Date(iso.endsWith('Z')?iso:iso+'Z');
  const s = Math.round((Date.now()-d)/1000);
  if(s<60) return 'Ñ‰Ğ¾Ğ¹Ğ½Ğ¾';
  if(s<3600) return Math.floor(s/60)+'Ñ…Ğ²';
  if(s<86400) return Math.floor(s/3600)+'Ğ³';
  return Math.floor(s/86400)+'Ğ´';
}
function toast(msg, err=false){
  const el=$i('toast');
  el.textContent=msg;
  el.style.background=err?'#2a0f0f':'';
  el.style.borderColor=err?'var(--red)':'';
  el.classList.add('show');
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),2500);
}

// â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTasks(){
  const r=await fetch('/api/tasks');
  if(!r.ok) throw new Error(r.statusText);
  return r.json();
}
async function fetchSessions(){
  const r=await fetch('/api/sessions');
  if(!r.ok) return [];
  return r.json();
}
async function fetchEtag(){
  const r=await fetch('/api/tasks/etag');
  if(!r.ok) return '';
  const d=await r.json();
  return d.ts+'|'+d.n;
}
async function fetchMessages(sessId){
  const r=await fetch(`/api/sessions/${sessId}/messages?limit=30&offset=0`);
  if(!r.ok) return [];
  const d=await r.json();
  return d.messages||[];
}

async function refresh(force=false){
  const btn=$i('refreshBtn');
  btn.innerHTML='<span class="spinning"></span>';
  try {
    const etag = await fetchEtag();
    if(!force && etag===lastEtag){ return; }
    const [newTasks, newSessions] = await Promise.all([fetchTasks(), fetchSessions()]);
    tasks=newTasks; sessions=newSessions; lastEtag=etag;
    renderBoard();
    $i('refreshTs').textContent = new Date().toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit'});
  } catch(e){ toast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ: '+e.message, true); }
  finally { btn.innerHTML='â†» Refresh'; }
}

function startAutoRefresh(){
  clearInterval(refreshTimer);
  refreshTimer = setInterval(()=>refresh(false), 30000);
}

// â”€â”€â”€ Board Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard(){
  const board=$i('board');
  board.innerHTML='';
  for(const col of COLS){
    const colTasks=tasks.filter(t=>t.status===col.id)
      .sort((a,b)=>a.sort_order-b.sort_order);
    board.appendChild(makeColumn(col, colTasks));
  }
}

function makeColumn(col, colTasks){
  const el=document.createElement('div');
  el.className='col';
  el.dataset.status=col.id;

  // Header
  const hd=document.createElement('div');
  hd.className='col-head';
  hd.innerHTML=`<div class="col-dot ${col.dot}"></div><span class="col-title">${escH(col.label)}</span><span class="col-cnt">${colTasks.length}</span>`;
  el.appendChild(hd);

  // Card list (drop zone)
  const body=document.createElement('div');
  body.className='col-body';
  body.dataset.status=col.id;
  setupDropZone(body);

  if(colTasks.length===0){
    const empty=document.createElement('div');
    empty.className='col-empty';
    empty.textContent='ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ°Ğ´Ğ°Ñ‡';
    body.appendChild(empty);
  } else {
    for(const task of colTasks) body.appendChild(makeCard(task));
  }
  el.appendChild(body);

  // Add button
  const addBtn=document.createElement('button');
  addBtn.className='col-add';
  addBtn.textContent='ï¼‹ Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ';
  addBtn.onclick=()=>openAddModal(col.id);
  el.appendChild(addBtn);
  return el;
}

function makeCard(task){
  const el=document.createElement('div');
  el.className='card';
  el.dataset.id=task.id;
  el.draggable=true;

  // Session badge
  let sessHtml='';
  if(task.session_id){
    if(task.is_active){
      sessHtml=`<span class="badge badge-green">âš™ ${escH(task.sess_title||'â€¦')}</span>`;
    } else {
      sessHtml=`<span class="badge badge-accent">ğŸ’¬ ${escH(task.sess_title||'ÑĞµÑÑ–Ñ')}</span>`;
    }
  }

  // Model badge
  const modelHtml=task.sess_model?`<span class="badge badge-muted">${escH(task.sess_model)}</span>`:'';

  el.innerHTML=`
    <div class="card-title">${escH(task.title)}</div>
    ${task.description?`<div class="card-desc">${escH(task.description)}</div>`:''}
    <div class="card-footer">
      ${sessHtml}${modelHtml}
      <span class="card-time">${relTime(task.updated_at)}</span>
      <span class="card-actions">
        <button class="cbtn" title="Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸" onclick="event.stopPropagation();openEditModal('${task.id}')">âœ</button>
        <button class="cbtn" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸" onclick="event.stopPropagation();confirmDelete('${task.id}')">âœ•</button>
      </span>
    </div>`;

  el.onclick=()=>openEditModal(task.id);

  // Drag
  el.addEventListener('dragstart', e=>{
    dragSrcId=task.id;
    el.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain', task.id);
  });
  el.addEventListener('dragend', ()=>{
    el.classList.remove('dragging');
    document.querySelectorAll('.dz').forEach(z=>z.classList.remove('dz'));
  });
  return el;
}

// â”€â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDropZone(el){
  el.addEventListener('dragover', e=>{
    e.preventDefault();
    e.dataTransfer.dropEffect='move';
    el.classList.add('dz');
    // Show insertion point
    const after=getDragAfterEl(el, e.clientY);
    const placeholder=document.querySelector('.drag-placeholder');
    if(placeholder) placeholder.remove();
    const ph=document.createElement('div');
    ph.className='card drag-placeholder';
    ph.style.height='50px';
    if(after) el.insertBefore(ph, after);
    else el.appendChild(ph);
  });
  el.addEventListener('dragleave', e=>{
    if(!el.contains(e.relatedTarget)){
      el.classList.remove('dz');
      const ph=el.querySelector('.drag-placeholder');
      if(ph) ph.remove();
    }
  });
  el.addEventListener('drop', async e=>{
    e.preventDefault();
    el.classList.remove('dz');
    document.querySelectorAll('.drag-placeholder').forEach(p=>p.remove());
    const id=e.dataTransfer.getData('text/plain')||dragSrcId;
    if(!id) return;
    const newStatus=el.dataset.status;
    // Determine sort_order from position
    const cards=[...el.querySelectorAll('.card[data-id]')];
    const afterEl=getDragAfterEl(el, e.clientY);
    let sort_order=0;
    if(afterEl){
      const afterTask=tasks.find(t=>t.id===afterEl.dataset.id);
      const idx=cards.indexOf(afterEl);
      const prevEl=cards[idx-1];
      const prevTask=prevEl?tasks.find(t=>t.id===prevEl.dataset.id):null;
      sort_order=((prevTask?.sort_order||0)+(afterTask?.sort_order||0))/2;
    } else {
      const last=cards[cards.length-1];
      const lastTask=last?tasks.find(t=>t.id===last.dataset.id):null;
      sort_order=(lastTask?.sort_order||0)+1000;
    }
    try{
      await fetch(`/api/tasks/${id}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({status:newStatus, sort_order}),
      });
      await refresh(true);
    } catch(err){ toast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: '+err.message, true); }
  });
}

function getDragAfterEl(container, y){
  const els=[...container.querySelectorAll('.card:not(.dragging):not(.drag-placeholder)')];
  return els.reduce((closest,el)=>{
    const box=el.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset) return {offset,el};
    return closest;
  },{offset:-Infinity,el:null}).el;
}

// â”€â”€â”€ Modal: Add Task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal(defaultStatus='backlog'){
  modalMode='add';
  editingTaskId=null;
  $i('modalTitle').textContent='ĞĞ¾Ğ²Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°';
  $i('modalBody').innerHTML=buildFormHtml({status:defaultStatus});
  $i('modalFt').innerHTML=`
    <button class="btn btn-ghost btn-sm" onclick="closeModal()">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
    <button class="btn btn-primary btn-sm" onclick="saveTask()">Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸</button>`;
  $i('taskOv').classList.remove('hidden');
  setTimeout(()=>$i('fTitle')?.focus(),50);
}

// â”€â”€â”€ Modal: Edit Task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openEditModal(id){
  const task=tasks.find(t=>t.id===id);
  if(!task) return;
  modalMode='edit';
  editingTaskId=id;
  $i('modalTitle').textContent='Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ';

  let chatHtml='';
  if(task.session_id){
    chatHtml=`<div style="height:8px"></div>`+await buildChatPanel(task);
  }

  $i('modalBody').innerHTML=buildFormHtml(task)+chatHtml;
  $i('modalFt').innerHTML=`
    <button class="btn btn-danger btn-sm" onclick="confirmDelete('${id}');closeModal()">Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸</button>
    <div style="flex:1"></div>
    <button class="btn btn-ghost btn-sm" onclick="closeModal()">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
    <button class="btn btn-primary btn-sm" onclick="saveTask()">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>`;
  $i('taskOv').classList.remove('hidden');
  setTimeout(()=>$i('fTitle')?.focus(),50);
}

function buildFormHtml(task={}){
  const statusOpts=COLS.map(c=>`<option value="${c.id}"${task.status===c.id?' selected':''}>${c.label}</option>`).join('');
  const sessOpts=`<option value="">â€” Ğ±ĞµĞ· ÑĞµÑÑ–Ñ— â€”</option>`+
    sessions.map(s=>`<option value="${s.id}"${task.session_id===s.id?' selected':''}>${escH(s.title||s.id)}</option>`).join('');

  return `
    <div><label class="lbl">ĞĞ°Ğ·Ğ²Ğ° *</label>
      <input id="fTitle" class="inp" placeholder="Ğ©Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸?" value="${escH(task.title||'')}">
    </div>
    <div><label class="lbl">ĞĞ¿Ğ¸Ñ</label>
      <textarea id="fDesc" class="inp" rows="3" placeholder="Ğ”ĞµÑ‚Ğ°Ğ»Ñ–, ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚, Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñâ€¦">${escH(task.description||'')}</textarea>
    </div>
    <div class="grid2">
      <div><label class="lbl">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</label>
        <select id="fStatus" class="sel">${statusOpts}</select>
      </div>
      <div><label class="lbl">ĞŸĞ¾Ğ²'ÑĞ·Ğ°Ğ½Ğ° ÑĞµÑÑ–Ñ</label>
        <select id="fSession" class="sel">${sessOpts}</select>
      </div>
    </div>`;
}

async function buildChatPanel(task){
  let msgs=[];
  try{ msgs=await fetchMessages(task.session_id); } catch{}

  const sessTitle=task.sess_title||task.session_id;
  const claudeId=task.claude_session_id||'';

  let msgsHtml='';
  if(msgs.length===0){
    msgsHtml=`<div class="chat-empty">ĞĞµĞ¼Ğ°Ñ” Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ</div>`;
  } else {
    msgsHtml=msgs.map(m=>{
      const role=m.role==='user'?'user':m.type==='tool'?'tool':'assistant';
      const text=m.type==='tool'?`[${escH(m.tool_name||'tool')}] ${escH((m.content||'').substring(0,120))}`:escH((m.content||'').substring(0,300));
      const long=(m.content||'').length>200;
      return `<div class="chat-msg"><div class="chat-role ${role}">${role==='user'?'Ğ’Ğ¸':role==='tool'?'Tool':'Claude'}</div><div class="chat-text${long?' long':''}">${text}</div></div>`;
    }).join('');
  }

  const openLink=`<a href="/?open_session=${encodeURIComponent(task.session_id)}" class="chat-open-link" target="_blank">â†— Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ² Ñ‡Ğ°Ñ‚Ñ–</a>`;
  const copyBtn=claudeId?`<span class="sess-id-mono" title="ĞšĞ»Ñ–Ğº â€” ÑĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸" onclick="navigator.clipboard.writeText('${escH(claudeId)}').then(()=>toast('âœ“ Ğ¡ĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾'));">${claudeId.slice(0,12)}â€¦</span>`:'';

  return `
    <div class="chat-panel">
      <div class="chat-panel-hd">
        <span style="flex:1">ğŸ’¬ ${escH(sessTitle)}</span>
        <div class="sess-info">${copyBtn}${openLink}</div>
      </div>
      <div class="chat-panel-body">${msgsHtml}</div>
    </div>`;
}

// â”€â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveTask(){
  const title=($i('fTitle')?.value||'').trim();
  if(!title){ toast('Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñ–', true); $i('fTitle')?.focus(); return; }
  const body={
    title,
    description:$i('fDesc')?.value||'',
    status:$i('fStatus')?.value||'backlog',
    session_id:$i('fSession')?.value||null,
  };

  try{
    if(modalMode==='add'){
      // Find max sort_order in that column
      const colTasks=tasks.filter(t=>t.status===body.status);
      body.sort_order=colTasks.length?Math.max(...colTasks.map(t=>t.sort_order))+1000:0;
      await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      toast('âœ“ Ğ—Ğ°Ğ´Ğ°Ñ‡Ñƒ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾');
    } else {
      const orig=tasks.find(t=>t.id===editingTaskId);
      if(orig) body.sort_order=orig.sort_order;
      await fetch(`/api/tasks/${editingTaskId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      toast('âœ“ Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾');
    }
    closeModal();
    await refresh(true);
  } catch(e){ toast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: '+e.message, true); }
}

// â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmDelete(id){
  const task=tasks.find(t=>t.id===id);
  $i('confirmTitle').textContent='Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ?';
  $i('confirmBody').innerHTML=`<p>Â«${escH(task?.title||id)}Â»</p><p style="font-size:12px;margin-top:6px;color:var(--muted)">Ğ¦Ñ Ğ´Ñ–Ñ Ğ½ĞµĞ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ğ°.</p>`;
  $i('confirmOkBtn').onclick=async()=>{
    try{
      await fetch(`/api/tasks/${id}`,{method:'DELETE'});
      toast('Ğ—Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ¾');
      closeConfirm();
      await refresh(true);
    } catch(e){ toast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: '+e.message, true); }
  };
  $i('confirmOv').classList.remove('hidden');
}
function closeConfirm(){ $i('confirmOv').classList.add('hidden'); }
function closeModal(){ $i('taskOv').classList.add('hidden'); }

// â”€â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    if(!$i('taskOv').classList.contains('hidden')){ closeModal(); return; }
    if(!$i('confirmOv').classList.contains('hidden')){ closeConfirm(); return; }
  }
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter' && !$i('taskOv').classList.contains('hidden')){ saveTask(); }
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async()=>{
  await refresh(true);
  startAutoRefresh();
})();
</script>
</body>
</html>
